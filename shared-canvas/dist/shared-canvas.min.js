// Generated by CoffeeScript 1.4.0
/*
# SGA Shared Canvas v0.131700
#
# **SGA Shared Canvas** is a shared canvas reader written in CoffeeScript.
#
# Date: Tue Jun 18 14:33:06 2013 -0400
#
# (c) Copyright University of Maryland 2012-2013.  All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
*/
(function(){var a=[].slice,b=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};(function(c,d){d.globalNamespace("SGA");return SGA.namespace("Reader",function(e){e.namespace("Data",function(e){e.namespace("StyleStore",function(b){return b.initInstance=function(){var b;b=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,a.call(b).concat([function(a){var b,c,d;c=a.options,b={},d=new RegExp("(?:\\.(\\S+)\\s*\\{\\s*([^}]*)\\s*\\})","mg"),a.addStyles=function(a,c){var e,f;if(b[a]==null){b[a]={},e=d.exec(c),f=[];while((e!=null?e.index:void 0)!=null)b[a][e[1]]=e[2],f.push(e=d.exec(c));return f}};return a.getStylesForClass=function(a,c){var d;return((d=b[a])!=null?d[c]:void 0)!=null?b[a][c]:""}}]))}}),e.namespace("TextStore",function(b){return b.initInstance=function(){var b;b=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,a.call(b).concat([function(a){var b,d,e,f;e=a.options,b={},d={},f={},a.addFile=function(a){var e,f,g,h;c.isArray(a)||(a=[a]),h=[];for(f=0,g=a.length;f<g;f++)e=a[f],h.push(function(a){if(a!=null&&b[a]==null&&d[a]==null){d[a]=[];return c.ajax({url:a,type:"GET",processData:!1,success:function(c){var e,f,g,h,i;e=c.documentElement.textContent,b[a]=e,i=d[a];for(g=0,h=i.length;g<h;g++)f=i[g],f(e);return delete d[a]}})}}(e));return h};return a.withFile=function(c,e){if(b[c]!=null)return e(b[c]);if(d[c]!=null)return d[c].push(e);a.addFile(c);return d[c].push(e)}}]))}});return e.namespace("Manifest",function(e){var f,g;f={"http://dms.stanford.edu/ns/":"sc","http://www.shared-canvas.org/ns/":"sc","http://www.w3.org/2000/01/rdf-schema#":"rdfs","http://www.w3.org/1999/02/22-rdf-syntax-ns#":"rdf","http://www.w3.org/2003/12/exif/ns#":"exif","http://purl.org/dc/elements/1.1/":"dc","http://www.w3.org/ns/openannotation/core/":"oa","http://www.openannotation.org/ns/":"oa","http://www.w3.org/ns/openannotation/extension/":"oax","http://www.openarchives.org/ore/terms/":"ore","http://www.shelleygodwinarchive.org/ns/1#":"sga","http://www.shelleygodwinarchive.org/ns1#":"sga","http://www.w3.org/2011/content#":"cnt","http://purl.org/dc/dcmitype/":"dctypes"},g={"http://www.w3.org/1999/02/22-rdf-syntax-ns#type":"item","http://www.w3.org/ns/openannotation/core/hasMotivation":"item"};return e.initInstance=function(){var e;e=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,["SGA.Reader.Data.Manifest"].concat(a.call(e),[function(a){var e,h,i,j,k,l;l=a.options,e=d.Data.Store.initInstance(),a.size=function(){return e.size()},i=d.Data.Importer.RDF_JSON.initInstance(e,f,g),k=[],h=function(d,e){{if(b.call(k,d)<0){k.push(d),a.addItemsToProcess(1);return c.ajax({url:d,type:"GET",contentType:"application/rdf+json",processData:!1,dataType:"json",success:function(b){a.addItemsProcessed(1);return a.importJSON(b,e)},error:function(b){a.addItemsProcessed(1);throw new Error("Could not load the manifest")}})}e()}},a.importJSON=function(a,b){var c;c=d.initSynchronizer(b),c.increment(),i["import"](a,function(a){var b,f;b=d.Data.Set.initInstance(a),f=e.getObjectsUnion(b,"oreisDescribedBy"),f.visit(function(a){c.increment();return h(a,c.decrement)});return c.decrement()});return c.done()},j=function(a){c.isArray(a)||(a=[a]),g=d.Data.Set.initInstance(a);return e.getSubjectsUnion(g,"type").items()},a.getCanvases=function(){return j("scCanvas")},a.getZones=function(){return j("scZone")},a.getSequences=function(){return j("scSequence")},a.getAnnotations=function(){return j("oaAnnotation")},a.getItem=e.getItem,a.contains=e.contains;return a.importFromURL=function(a,b){return h(a,function(){if(b!=null)return b()})}}]))}})}),e.namespace("Presentation",function(e){e.namespace("TextContent",function(b){return b.initInstance=function(){var b,e;b=1<=arguments.length?a.call(arguments,0):[];return(e=d.Presentation).initInstance.apply(e,["SGA.Reader.Presentation.TextContent"].concat(a.call(b),[function(a,b){var d,e;e=a.options,d=function(a,b,d,e){var f,g,h,i;h={},f=c("<span></span>"),h.$el=f,g=d.getItem(e),f.text(g.text[0]),f.addClass(g.type.join(" ")),f.attr("style",(i=g.css)!=null?i[0]:void 0),c(a).append(f),h.remove=function(){return f.remove()},h.update=function(a){return f.text(a.text[0])};return h},a.addLens("AdditionAnnotation",d),a.addLens("DeletionAnnotation",d),a.addLens("SearchAnnotation",d),a.addLens("LineAnnotation",d),a.addLens("Text",d);return a.addLens("LineBreak",function(a,b,d,e){var f,g;g={},f=c("<br/>"),g.$el=f,c(a).append(f),g.remove=function(){return f.remove()},g.update=function(a){};return g})}]))}}),e.namespace("Zone",function(f){return f.initInstance=function(){var g,h;g=1<=arguments.length?a.call(arguments,0):[];return(h=d.Presentation).initInstance.apply(h,["SGA.Reader.Presentation.Zone"].concat(a.call(g),[function(a,g){var h,i,j;i=a.options,j=i.svgRoot,h=a.dataView.prepare(["!target"]),a.addLens("Image",function(a,d,e,f){var g,h,k,l,m,n;if(b.call(i.types||[],"Image")>=0){k={},g=e.getItem(f),l=c(j.root()),n=l.get(0).getAttribute("viewBox"),n==null&&j.configure({viewBox:"0 0 "+i.width+" "+i.height}),m=null,h=function(b){var c,d,e,f,g,h,k,l,n,o;if(((g=b.image)!=null?g[0]:void 0)!=null&&j!=null){e=((h=b.x)!=null?h[0]:void 0)!=null?b.x[0]:0,f=((k=b.y)!=null?k[0]:void 0)!=null?b.y[0]:0,d=((l=b.width)!=null?l[0]:void 0)!=null?b.width[0]:i.width-e,c=((n=b.height)!=null?n[0]:void 0)!=null?b.height[0]:i.height-f,m!=null&&j.remove(m);return m=j.image(a,e,f,d,c,(o=b.image)!=null?o[0]:void 0,{preserveAspectRatio:"none"})}},h(g),k.update=h,k.remove=function(){if(m!=null&&j!=null)return j.remove(m)};return k}}),a.addLens("ImageViewer",function(d,e,f,g){var h,k,l,m,n,o,p,q,r,s,t,u;if(b.call(i.types||[],"Image")>=0){s={},p=f.getItem(g),h=a.options.application(),h.imageControls.setActive(!0),m="http://localhost:8080/adore-djatoka/resolver",o=p.image[0],k=m+"?url_ver=Z39.88-2004&rft_id="+o,r=org.polymaps,t=c(j.root()),t.get(0).removeAttribute("viewBox"),n=j.group(),q=r.map().container(n),l=c(d).parent().get(0),u=c.ajax({datatype:"json",url:k+"&svc_id=info:lanl-repo/svc/getMetadata",success:adoratio(l,k,q)}),u.then(function(){var a,b;a=!0,b=q.center(),h.imageControls.events.onZoomChange.addListener(function(b){q.zoom(b),h.imageControls.setImgPosition(q.position);return a=!1}),h.imageControls.events.onImgPositionChange.addListener(function(c){a=!1;if(c.topLeft.x===0&&c.topLeft.y===0)return q.center(b)}),h.imageControls.setZoom(q.zoom()),h.imageControls.setMaxZoom(q.zoomRange()[1]),h.imageControls.setMinZoom(q.zoomRange()[0]),h.imageControls.setImgPosition(q.position),q.on("zoom",function(){if(a){h.imageControls.setZoom(q.zoom());return h.imageControls.setImgPosition(q.position)}return a=!0});return q.on("drag",function(){return a?h.imageControls.setImgPosition(q.position):a=!0})}),s.update=function(a){return 0},s.remove=function(){h.imageControls.setActive(!1),h.imageControls.setZoom(0),h.imageControls.setMaxZoom(0),h.imageControls.setMinZoom(0),h.imageControls.setImgPosition({topLeft:{x:0,y:0},bottomRight:{x:0,y:0}});return c(j.root()).find("#map").remove()};return s}}),a.addLens("ZoneAnnotation",function(a,b,e,g){var h,k,l,m,n,o,p,q,r,s,t,u,v;k={},r=e.getItem(g),p=null,p=document.createElementNS("http://www.w3.org/2000/svg","svg"),m=((s=item.x)!=null?s[0]:void 0)!=null?item.x[0]:0,n=((t=item.y)!=null?t[0]:void 0)!=null?item.y[0]:0,l=((u=item.width)!=null?u[0]:void 0)!=null?item.width[0]:i.width-m,h=((v=item.height)!=null?v[0]:void 0)!=null?item.height[0]:i.height-n,c(p).attr("x",m).attr("y",n).attr("width",l).attr("height",h),a.appendChild(p),q=d.Data.SubSet.initInstance({dataStore:e,expressions:["!target"]}),o=f.initInstance(p,{types:i.types,dataView:q,svgRoot:j,application:i.application,heigth:h,width:l}),q.setKey(g),k._destroy=function(){o._destroy!=null&&o._destroy();if(q._destroy!=null)return q._destroy()},k.remove=function(){return k._destroy()},k.update=function(a){var b,d,e,f;m=((b=a.x)!=null?b[0]:void 0)!=null?a.x[0]:0,n=((d=a.y)!=null?d[0]:void 0)!=null?a.y[0]:0,l=((e=a.width)!=null?e[0]:void 0)!=null?a.width[0]:i.width-m,h=((f=a.height)!=null?f[0]:void 0)!=null?a.height[0]:i.height-n;return c(p).attr("x",m).attr("y",n).attr("width",l).attr("height",h)};return k}),a.addLens("ContentAnnotation",function(a,d,e,f){var g,h,j,k,l,m,n,o,p,q,r,s,t;if(b.call(i.types||[],"Text")>=0){k={},j=e.getItem(f),m=document.createElementNS("http://www.w3.org/2000/svg","foreignObject"),o=((q=j.x)!=null?q[0]:void 0)!=null?j.x[0]:0,p=((r=j.y)!=null?r[0]:void 0)!=null?j.y[0]:0,n=((s=j.width)!=null?s[0]:void 0)!=null?j.width[0]:i.width-o,h=((t=j.height)!=null?t[0]:void 0)!=null?j.height[0]:i.height-p,c(m).attr("x",o).attr("y",p).attr("width",n).attr("height",h),a.appendChild(m),g=document.createElementNS("http://www.w3.org/1999/xhtml","body"),l=document.createElement("div"),c(l).addClass("text-content"),l.text(j.text[0]),k.update=function(a){return l.text(a.text[0])},k.remove=function(){return l.remove()};return k}});return a.addLens("TextContentZone",function(a,f,g,h){var k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E;if(b.call(i.types||[],"Text")>=0){p={},k=i.application(),A=k.imageControls.getZoom(),n=g.getItem(h),u=null,u=document.createElementNS("http://www.w3.org/2000/svg","foreignObject"),y=((B=n.x)!=null?B[0]:void 0)!=null?n.x[0]:0,z=((C=n.y)!=null?C[0]:void 0)!=null?n.y[0]:0,x=((D=n.width)!=null?D[0]:void 0)!=null?n.width[0]:i.width-y,m=((E=n.height)!=null?E[0]:void 0)!=null?n.height[0]:i.height-z,c(u).attr("x",y).attr("y",z).attr("width",x).attr("height",m),a.appendChild(u),l=document.createElementNS("http://www.w3.org/1999/xhtml","body"),q=document.createElement("div"),c(q).addClass("text-content"),c(q).attr("id",h),c(q).css("font-size",150),c(q).css("line-height",1.15),l.appendChild(q),u.appendChild(l),k.imageControls.getActive()&&(s=5,o=j.rect(0,0,i.width-s,i.height-s,{"class":"marquee",fill:"yellow",stroke:"navy",strokeWidth:s,fillOpacity:"0.05",strokeOpacity:"0.9"}),r=i.width/c(a).width(),w=100,k.imageControls.events.onZoomChange.addListener(function(b){if(k.imageControls.getMaxZoom()>0){x=Math.round(i.width/Math.pow(2,k.imageControls.getMaxZoom()-b)),w=Math.min(100,c(a).width()*100/x),o.setAttribute("width",i.width*w/100);return o.setAttribute("height",i.height*w/100)}}),k.imageControls.events.onImgPositionChange.addListener(function(a){o.setAttribute("x",-a.topLeft.x*w/100*r);return o.setAttribute("y",-a.topLeft.y*w/100*r)})),v=d.Data.SubSet.initInstance({dataStore:g,expressions:["!target"]}),t=e.TextContent.initInstance(q,{types:i.types,dataView:v,svgRoot:j,application:i.application,height:m,width:x}),v.setKey(h),p._destroy=function(){t._destroy!=null&&t._destroy();if(v._destroy!=null)return v._destroy()},p.remove=function(){c(u).empty();return j.remove(u)},p.update=function(a){var b,d,e,f;y=((b=a.x)!=null?b[0]:void 0)!=null?a.x[0]:0,z=((d=a.y)!=null?d[0]:void 0)!=null?a.y[0]:0,x=((e=a.width)!=null?e[0]:void 0)!=null?a.width[0]:i.width-y,m=((f=a.height)!=null?f[0]:void 0)!=null?a.height[0]:i.height-z;return c(u).attr("x",y).attr("y",z).attr("width",x).attr("height",m)};return p}})}]))}});return e.namespace("Canvas",function(b){return b.initInstance=function(){var b,e;b=1<=arguments.length?a.call(arguments,0):[];return(e=d.Presentation).initInstance.apply(e,["SGA.Reader.Presentation.Canvas"].concat(a.call(b),[function(a,b){var e,f,g,h,i,j,k,l,m,n,o,p;l=a.options,h=a.dataView.prepare(["!target"]),m=[],e=function(a){return m.push(a)},p=c('<svg xmlns="http://www.w3.org/2000/svg" version="1.1"\n     xmlns:xlink="http://www.w3.org/1999/xlink"\n     width="0" height="0"\n >\n</svg>'),b.append(p),o=c(p).svg({onLoad:function(a){var b,c,d;e=function(b){return b(a)};for(c=0,d=m.length;c<d;c++)b=m[c],b(a);return m=null}}),j=null,i=null,f=null,g=parseInt(c(b).width()*20/20,10),d.events.onWindowResize.addListener(function(){g=parseInt(c(b).width()*20/20,10);if(j!=null&&j>0)return a.setScale(g/j)}),a.events.onScaleChange.addListener(function(a){if(j!=null&&i!=null){f=parseInt(i*a,10);return e(function(a){p.attr({width:j,height:i}),a.configure({viewBox:"0 0 "+j+" "+i});return p.css({width:g,height:f,border:"0.5em solid #eeeeee","border-radius":"5px","background-color":"#ffffff"})})}}),k=d.Data.SubSet.initInstance({dataStore:l.dataView,expressions:["!target"],key:null}),n=null;return a.events.onCanvasChange.addListener(function(b){var c,d,f;k.setKey(b),c=k.getItem(b),j=((d=c.width)!=null?d[0]:void 0)||1,i=((f=c.height)!=null?f[0]:void 0)||1,a.setScale(g/j),n!=null&&(n.hide!=null&&n.hide(),n._destroy!=null&&n._destroy());return e(function(a){a.clear();return n=SGA.Reader.Presentation.Zone.initInstance(a.root(),{types:l.types,dataView:k,application:l.application,height:i,width:j,svgRoot:a})})})}]))}})}),e.namespace("Data",function(e){e.namespace("StyleStore",function(b){return b.initInstance=function(){var b;b=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,a.call(b).concat([function(a){var b,c,d;c=a.options,b={},d=new RegExp("(?:\\.(\\S+)\\s*\\{\\s*([^}]*)\\s*\\})","mg"),a.addStyles=function(a,c){var e,f;if(b[a]==null){b[a]={},e=d.exec(c),f=[];while((e!=null?e.index:void 0)!=null)b[a][e[1]]=e[2],f.push(e=d.exec(c));return f}};return a.getStylesForClass=function(a,c){var d;return((d=b[a])!=null?d[c]:void 0)!=null?b[a][c]:""}}]))}}),e.namespace("TextStore",function(b){return b.initInstance=function(){var b;b=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,a.call(b).concat([function(a){var b,d,e,f;e=a.options,b={},d={},f={},a.addFile=function(a){var e,f,g,h;c.isArray(a)||(a=[a]),h=[];for(f=0,g=a.length;f<g;f++)e=a[f],h.push(function(a){if(a!=null&&b[a]==null&&d[a]==null){d[a]=[];return c.ajax({url:a,type:"GET",processData:!1,success:function(c){var e,f,g,h,i;e=c.documentElement.textContent,b[a]=e,i=d[a];for(g=0,h=i.length;g<h;g++)f=i[g],f(e);return delete d[a]}})}}(e));return h};return a.withFile=function(c,e){if(b[c]!=null)return e(b[c]);if(d[c]!=null)return d[c].push(e);a.addFile(c);return d[c].push(e)}}]))}});return e.namespace("Manifest",function(e){var f,g;f={"http://dms.stanford.edu/ns/":"sc","http://www.shared-canvas.org/ns/":"sc","http://www.w3.org/2000/01/rdf-schema#":"rdfs","http://www.w3.org/1999/02/22-rdf-syntax-ns#":"rdf","http://www.w3.org/2003/12/exif/ns#":"exif","http://purl.org/dc/elements/1.1/":"dc","http://www.w3.org/ns/openannotation/core/":"oa","http://www.openannotation.org/ns/":"oa","http://www.w3.org/ns/openannotation/extension/":"oax","http://www.openarchives.org/ore/terms/":"ore","http://www.shelleygodwinarchive.org/ns/1#":"sga","http://www.shelleygodwinarchive.org/ns1#":"sga","http://www.w3.org/2011/content#":"cnt","http://purl.org/dc/dcmitype/":"dctypes"},g={"http://www.w3.org/1999/02/22-rdf-syntax-ns#type":"item","http://www.w3.org/ns/openannotation/core/hasMotivation":"item"};return e.initInstance=function(){var e;e=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,["SGA.Reader.Data.Manifest"].concat(a.call(e),[function(a){var e,h,i,j,k,l;l=a.options,e=d.Data.Store.initInstance(),a.size=function(){return e.size()},i=d.Data.Importer.RDF_JSON.initInstance(e,f,g),k=[],h=function(d,e){{if(b.call(k,d)<0){k.push(d),a.addItemsToProcess(1);return c.ajax({url:d,type:"GET",contentType:"application/rdf+json",processData:!1,dataType:"json",success:function(b){a.addItemsProcessed(1);return a.importJSON(b,e)},error:function(b){a.addItemsProcessed(1);throw new Error("Could not load the manifest")}})}e()}},a.importJSON=function(a,b){var c;c=d.initSynchronizer(b),c.increment(),i["import"](a,function(a){var b,f;b=d.Data.Set.initInstance(a),f=e.getObjectsUnion(b,"oreisDescribedBy"),f.visit(function(a){c.increment();return h(a,c.decrement)});return c.decrement()});return c.done()},j=function(a){c.isArray(a)||(a=[a]),g=d.Data.Set.initInstance(a);return e.getSubjectsUnion(g,"type").items()},a.getCanvases=function(){return j("scCanvas")},a.getZones=function(){return j("scZone")},a.getSequences=function(){return j("scSequence")},a.getAnnotations=function(){return j("oaAnnotation")},a.getItem=e.getItem,a.contains=e.contains;return a.importFromURL=function(a,b){return h(a,function(){if(b!=null)return b()})}}]))}})}),e.namespace("Component",function(b){b.namespace("ProgressBar",function(b){return b.initInstance=function(){var b;b=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,["SGA.Reader.Component.ProgressBar"].concat(a.call(b),[function(a,b){a.events.onNumeratorChange.addListener(function(d){var e;e=parseInt(100*d/a.getDenominator(),10),e>100&&(e=100);return c(b).find(".bar").css("width",e+"%")}),a.events.onDenominatorChange.addListener(function(d){var e;e=parseInt(100*a.getNumerator()/d,10),e>100&&(e=100);return c(b).find(".bar").css("width",e+"%")}),a.show=function(){return c(b).show()};return a.hide=function(){return c(b).hide()}}]))}}),b.namespace("SequenceSelector",function(b){return b.initInstance=function(){var b,e;b=1<=arguments.length?a.call(arguments,0):[];return(e=d.Presentation).initInstance.apply(e,["SGA.Reader.Component.SequenceSelector"].concat(a.call(b),[function(a,b){var d;d=a.options,a.addLens("Sequence",function(a,b,d,e){var f,g,h,i;h={},g=d.getItem(e),f=c("<option></option>"),f.attr({value:e}),f.text((i=g.label)!=null?i[0]:void 0);return c(a).append(f)}),c(b).change(function(){return a.setSequence(c(b).val())}),a.events.onSequenceChange.addListener(function(a){return c(b).val(a)});return a.finishDisplayUpdate=function(){return a.setSequence(c(b).val())}}]))}}),b.namespace("Slider",function(b){return b.initInstance=function(){var b;b=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,["SGA.Reader.Component.Slider"].concat(a.call(b),[function(a,b){a.events.onMinChange.addListener(function(a){return c(b).attr({min:a})}),a.events.onMaxChange.addListener(function(a){return c(b).attr({max:a})}),a.events.onValueChange.addListener(function(a){return c(b).val(a)});return c(b).change(function(d){return a.setValue(c(b).val())})}]))}}),b.namespace("PagerControls",function(b){return b.initInstance=function(){var b;b=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,["SGA.Reader.Component.PagerControls"].concat(a.call(b),[function(a,b){var d,e,f,g;d=c(b).find(".icon-fast-backward").parent(),g=c(b).find(".icon-step-backward").parent(),f=c(b).find(".icon-step-forward").parent(),e=c(b).find(".icon-fast-forward").parent(),a.events.onMinChange.addListener(function(b){if(b<a.getValue()){d.removeClass("disabled");return g.removeClass("disabled")}d.addClass("disabled");return g.addClass("disabled")}),a.events.onMaxChange.addListener(function(b){if(b>a.getValue()){f.removeClass("disabled");return e.removeClass("disbaled")}f.addClass("disabled");return e.addClass("disabled")}),a.events.onValueChange.addListener(function(b){b>a.getMin()?(d.removeClass("disabled"),g.removeClass("disabled")):(d.addClass("disabled"),g.addClass("disabled"));if(b<a.getMax()){f.removeClass("disabled");return e.removeClass("disabled")}f.addClass("disabled");return e.addClass("disabled")}),c(g).click(function(b){b.preventDefault();return a.addValue(-1)}),c(f).click(function(b){b.preventDefault();return a.addValue(1)}),c(d).click(function(b){b.preventDefault();return a.setValue(a.getMin())});return c(e).click(function(b){b.preventDefault();return a.setValue(a.getMax())})}]))}});return b.namespace("ImageControls",function(b){return b.initInstance=function(){var b;b=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,["SGA.Reader.Component.ImageControls"].concat(a.call(b),[function(a,b){var d,e,f,g;g=c(b).find(".icon-picture").parent(),d=c(b).find(".icon-zoom-in").parent(),f=c(b).find(".icon-zoom-out").parent(),e=c(b).find(".icon-eye-open").parent(),c(g).click(function(b){b.preventDefault(),a.setZoom(a.getMinZoom());return a.setImgPosition({topLeft:{x:0,y:0},bottomRight:{x:0,y:0}})}),c(d).click(function(b){var c;b.preventDefault(),c=a.getZoom();if(Math.floor(c+1<=a.getMaxZoom()))return a.setZoom(Math.floor(c+1))}),c(f).click(function(b){var c,d;b.preventDefault(),d=a.getZoom(),c=a.getMinZoom();if(Math.floor(d-1>c))return a.setZoom(Math.floor(d-1));if(Math.floor(d-1===Math.floor(c)))return a.setZoom(c)});return c(e).click(function(a){var b;a.preventDefault(),b=c(".marquee");return b.each(function(a,b){b=c(b);return b.css("display")!=="none"?b.hide():b.show()})})}]))}})});return e.namespace("Application",function(e){return e.namespace("SharedCanvas",function(f){f.initInstance=function(){var e,f;e=1<=arguments.length?a.call(arguments,0):[];return(f=d.Application).initInstance.apply(f,["SGA.Reader.Application.SharedCanvas"].concat(a.call(e),[function(a){var e,f,g,h,i,j,k,l,m,n;k=a.options,l=[],a.addPresentation=function(b){var c;c=SGA.Reader.Presentation.Canvas.initInstance(b.container,{types:b.types,application:function(){return a},dataView:a.dataView.canvasAnnotations});return l.push([c,b.container])},e=null,a.events.onSequenceChange.addListener(function(b){var c,d;e=b,d=a.dataStore.data.getItem(e),c=0,(d!=null?d.sequence:void 0)!=null&&(c=d.sequence.indexOf(a.getCanvas())),c<0&&(c=0);return a.setPosition(c)}),a.events.onPositionChange.addListener(function(b){var c,d,f;d=a.dataStore.data.getItem(e),c=(f=d.sequence)!=null?f[b]:void 0;return a.setCanvas(c)}),a.events.onCanvasChange.addListener(function(b){var c,d,f,g,h;a.dataView.canvasAnnotations.setKey(b),f=a.dataStore.data.getItem(e),c=f.sequence.indexOf(b),c>=0&&c!==a.getPosition()&&a.setPosition(c);for(g=0,h=l.length;g<h;g++)d=l[g],d[0].setCanvas(b);return b}),j=SGA.Reader.Data.Manifest.initInstance(),a.events.onItemsProcessedChange=j.events.onItemsProcessedChange,a.events.onItemsToProcessChange=j.events.onItemsToProcessChange,a.getItemsProcessed=j.getItemsProcessed,a.getItemsToProcess=j.getItemsToProcess,a.setItemsProcessed=j.setItemsProcessed,a.setItemsToProcess=j.setItemsToProcess,a.addItemsProcessed=j.addItemsProcessed,a.addItemsToProcess=j.addItemsToProcess,n=SGA.Reader.Data.TextStore.initInstance(),a.withSource=n.withFile,f=function(a,c){var d,e,f,g;if(c!=null){e=j.getItem(c);if(b.call(e.type,"oaFragmentSelector")<0){e.oaxbegin!=null&&(a.start=parseInt((f=e.oaxbegin)!=null?f[0]:void 0,10));if(e.oaxend!=null)return a.end=parseInt((g=e.oaxend)!=null?g[0]:void 0,10)}else if(e.rdfvalue[0].substr(0,5)==="xywh="){a.shape="Rectangle",d=e.rdfvalue[0].substr(5).split(","),a.x=parseInt(d[0],10),a.y=parseInt(d[1],10),a.width=parseInt(d[2],10);return a.height=parseInt(d[3],10)}}},h=function(a,c){var d,e,g;if(c!=null){e=j.getItem(c);if(b.call(e.type,"oaSpecificResource")<0)return a.target=c;a.target=e.oahasSource,e.oahasStyle!=null&&(d=j.getItem(e.oahasStyle[0]),b.call(d.dcformat,"text/css")>=0&&(a.css=d.cntchars));return f(a,(g=e.oahasSelector)!=null?g[0]:void 0)}},g=function(a,b){var c,d;if(b!=null){c=j.getItem(b),n.addFile(c.oahasSource),a.source=c.oahasSource;return f(a,(d=c.oahasSelector)!=null?d[0]:void 0)}},m=function(){var e,i,k,l,m,n,o,p;k=[],m=d.initSynchronizer(),i=j.getCanvases(),a.addItemsToProcess(i.length),m.process(i,function(b){var c,d,e;a.addItemsProcessed(1),c=j.getItem(b);return k.push({id:b,type:"Canvas",width:parseInt((d=c.exifwidth)!=null?d[0]:void 0,10),height:parseInt((e=c.exifheight)!=null?e[0]:void 0,10),label:c.dctitle||c.rdfslabel})}),p=j.getZones(),a.addItemsToProcess(p.length),m.process(p,function(b){var c,d,e,f;a.addItemsProcessed(1),c=j.getItem(b);return k.push({id:b,type:"Zone",width:parseInt((d=mitem.exifwidth)!=null?d[0]:void 0,10),height:parseInt((e=mitem.exifheight)!=null?e[0]:void 0,10),angle:parseInt((f=mitem.scnaturalAngle)!=null?f[0]:void 0,10)||0,label:c.rdfslabel})}),l=j.getSequences(),a.addItemsToProcess(l.length),m.process(l,function(b){var c,d;a.addItemsProcessed(1),d=j.getItem(b),c={id:b,type:"Sequence",label:d.rdfslabel},l=[],l.push(d.rdffirst[0]),d=j.getItem(d.rdfrest[0]);while(d.id!=null)l.push(d.rdffirst[0]),d=j.getItem(d.rdfrest[0]);c.sequence=l;return k.push(c)}),o={},n=[],e=j.getAnnotations(),a.addItemsToProcess(e.length),m.process(e,function(d){var e,i,l,m,p,q,r,s,t,u,v,w,x;a.addItemsProcessed(1),e=j.getItem(d),i=null,p={id:d},b.call(e.type,"scContentAnnotation")<0?b.call(e.type,"scImageAnnotation")<0?b.call(e.type,"scZoneAnnotation")<0?(q=function(){var a,b,c,d;c=e.type,d=[];for(a=0,b=c.length;a<b;a++)l=c[a],l.substr(0,3)==="sga"&&l.substr(l.length-10)==="Annotation"&&d.push(l.substr(3));return d}(),q.length>0&&(h(p,(x=e.oahasTarget)!=null?x[0]:void 0),p.type=q,i=n)):(r=j.getItem(e.oahasTarget),f(p,(w=r.hasSelector)!=null?w[0]:void 0),i=k,p.target=r.hasSource,p.label=e.rdfslabel,p.type="ZoneAnnotation"):(m=j.getItem(e.oahasBody),c.isArray(m)&&(m=m[0]),i=k,p.target=e.oahasTarget,p.label=e.rdfslabel,p.image=m.oahasSource||e.oahasBody,p.type="Image",b.call(m.dcformat,"image/jp2")>=0&&a.imageControls!=null&&(p.type="ImageViewer")):(h(p,(t=e.oahasTarget)!=null?t[0]:void 0),g(p,(u=e.oahasBody)!=null?u[0]:void 0),(v=o[s=p.source])==null&&(o[s]=[]),o[p.source].push([d,p.start,p.end]),p.type="TextContentZone",i=k);if(p.type!=null&&i!=null)return i.push(p)});return m.done(function(){a.addItemsToProcess(1+n.length);return a.dataStore.data.loadItems(k,function(){var d,e,f,g,h,i,j,l,m,p,q,r,s;k=[],g={},f={},e={},i=function(a){var b,d,h,i,j,k,l,m,n,o;h=a.target,i=a.start,b=a.end,d=a.id,c.isArray(d)&&(d=d[0]),e[d]=a,(l=g[h])==null&&(g[h]={}),(m=(j=g[h])[i])==null&&(j[i]=[]),g[h][i].push(d),(n=f[h])==null&&(f[h]={}),(o=(k=f[h])[b])==null&&(k[b]=[]);return f[h][b].push(d)};for(p=0,r=n.length;p<r;p++)d=n[p],i(d);l=function(){var a;a=[];for(h in g)a.push(h);return a}(),a.addItemsToProcess(l.length),a.addItemsProcessed(n.length),m=function(d){return a.withSource(d,function(i){var j,k,l,m,n,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H;z=[],r=[],j=!1,y=function(a,b,c,e,f){return z.push({type:a,css:b.join(" "),text:i.slice(e,f),id:d+"-"+e+"-"+f,target:c,start:e,end:f})},x=function(a,b){var d,f,g,h,i;d=[],f=[];for(h=0,i=r.length;h<i;h++)g=r[h],d.push(e[g].type),c.isArray(e[g].css)?f.push(e[g].css.join(" ")):f.push(e[g].css);d.length===0&&d.push("Text");return p(a,b,d,f)},p=function(a,b,c,e){var f,g,i,j,k;k=o[d]||[];for(i=0,j=k.length;i<j;i++)f=k[i],a<=f[2]&&b>=f[1]&&(h=Math.min(Math.max(a,f[1]),f[2]),g=Math.max(Math.min(b,f[2]),f[1]),y(c,e,f[0],h,g));return!1},n=function(a){var b;b=["LineBreak"];return p(a,a,b,[""])},s=g[d]||[],q=f[d]||[],m=0,w=function(){var a;a=[];for(u in s)a.push(parseInt(u,10));return a}().concat(function(){var a;a=[];for(u in q)a.push(parseInt(u,10));return a}()).sort(function(a,b){return a-b});for(A=0,C=w.length;A<C;A++){v=w[A];if(v!==m){x(m,v),j&&!i.substr(m,v-m).match(/^\s*$/)&&(j=!1),t=!1,G=s[v]||[];for(B=0,D=G.length;B<D;B++)k=G[B],b.call(e[k].type,"LineAnnotation")>=0&&(t=!0),r.push(k);H=q[v]||[];for(F=0,E=H.length;F<E;F++)k=H[F],b.call(e[k].type,"LineAnnotation")>=0&&(t=!0),l=r.indexOf(k),l>-1&&r.splice(l,1);t&&!j&&(n(v),j=!0),m=v}}x(m,i.length);return a.dataStore.data.loadItems(z,function(){return a.addItemsProcessed(1)})})};for(q=0,s=l.length;q<s;q++)j=l[q],m(j);return a.addItemsProcessed(1)})})},i=function(a){return a.length>1?j.importFromURL(a[0],function(){return i(a.slice(1,+a.length+1||9e9))}):j.importFromURL(a[0],m)},a.loadManifests=i;if(k.url!=null)return i([k.url])}]))};return f.builder=function(a){var b,d,f,g,h,i,j;d={manifests:{}},b={},f=function(){},g=function(){},a.progressTracker!=null&&(f=function(){var b,c,e,f,g;e=0,b=0,g=d.manifests;for(c in g)f=g[c],e+=f.getItemsProcessed(),b+=f.getItemsToProcess();a.progressTracker.setNumerator(e);return a.progressTracker.setDenominator(b||1)},h=null,i=1e3,g=function(){if(h!=null)return i=500;h=function(){var b,c,e;e=d.manifests;for(b in e){c=e[b];if(c.getItemsToProcess()>c.getItemsProcessed()){a.progressTracker.show(),i/=2,i<500&&(i=500),setTimeout(h,i);return}}i>500&&a.progressTracker.hide(),i*=2,i>1e4&&(i=1e4);return setTimeout(h,i)};return h()}),d.onManifest=function(a,c){var e;if(d.manifests[a]!=null)return d.manifests[a].ready(function(){return c(d.manifests[a])});(e=b[a])==null&&(b[a]=[]);return b[a].push(c)},d.addPresentation=function(a){var h,i,j,k;i=c(a).data("manifest");if(i!=null){h=d.manifests[i],h==null&&(h=e.SharedCanvas.initInstance({url:i}),d.manifests[i]=h,h.ready(function(){var a,c,d,e;c=b[i]||[];for(d=0,e=c.length;d<e;d++)a=c[d],a(h);return delete b[i]}),h.events.onItemsToProcessChange.addListener(f),h.events.onItemsProcessedChange.addListener(f),g()),h.run(),j=(k=c(a).data("types"))!=null?k.split(/\s*,\s*/):void 0;return d.onManifest(i,function(b){return b.addPresentation({types:j,container:c(a)})})}},(j=a["class"])==null&&(a["class"]=".canvas"),c(a["class"]).each(function(a,b){return d.addPresentation(b)});return d}})})})})(jQuery,MITHgrid),MITHgrid.defaults("SGA.Reader.Application.SharedCanvas",{dataStores:{data:{types:{Sequence:{},Canvas:{}},properties:{target:{valueType:"item"}}}},dataViews:{canvasAnnotations:{dataStore:"data",type:MITHgrid.Data.SubSet,expressions:["!target"]},sequences:{dataStore:"data",types:["Sequence"]}},variables:{Canvas:{is:"rw"},Sequence:{is:"rw"},Position:{is:"lrw",isa:"numeric"}}}),MITHgrid.defaults("SGA.Reader.Component.Slider",{variables:{Min:{is:"rw",isa:"numeric"},Max:{is:"rw",isa:"numeric"},Value:{is:"rw",isa:"numeric"}}}),MITHgrid.defaults("SGA.Reader.Component.PagerControls",{variables:{Min:{is:"rw",isa:"numeric"},Max:{is:"rw",isa:"numeric"},Value:{is:"rw",isa:"numeric"}}}),MITHgrid.defaults("SGA.Reader.Component.SequenceSelector",{variables:{Sequence:{is:"rw"}}}),MITHgrid.defaults("SGA.Reader.Component.ProgressBar",{variables:{Numerator:{is:"rw","default":0,isa:"numeric"},Denominator:{is:"rw","default":1,isa:"numeric"}},viewSetup:'<div class="progress progress-striped active">\n  <div class="bar" style="width: 0%;"></div>\n</div>'}),MITHgrid.defaults("SGA.Reader.Presentation.Canvas",{variables:{Canvas:{is:"rw"},Scale:{is:"rw",isa:"numeric"}}}),MITHgrid.defaults("SGA.Reader.Data.Manifest",{variables:{ItemsToProcess:{is:"rw","default":0,isa:"numeric"},ItemsProcessed:{is:"rw","default":0,isa:"numeric"}}}),MITHgrid.defaults("SGA.Reader.Component.ImageControls",{variables:{Active:{is:"rw","default":!1},Zoom:{is:"rw","default":0,isa:"numeric"},MaxZoom:{is:"rw","default":0,isa:"numeric"},MinZoom:{is:"rw","default":0,isa:"numeric"},ImgPosition:{is:"rw","default":{}}}})}).call(this);