// Generated by CoffeeScript 1.6.3
/*
# SGA Shared Canvas v0.132620
#
# **SGA Shared Canvas** is a shared canvas reader written in CoffeeScript.
#
# Date: Thu Sep 19 15:53:44 2013 -0400
#
# (c) Copyright University of Maryland 2012-2013.  All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
*/
(function(){var a=[].slice,b=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};(function(c,d){d.globalNamespace("SGA");return SGA.namespace("Reader",function(e){e.namespace("Data",function(e){e.namespace("StyleStore",function(b){return b.initInstance=function(){var b;b=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,a.call(b).concat([function(a){var b,c,d;c=a.options,b={},d=new RegExp("(?:\\.(\\S+)\\s*\\{\\s*([^}]*)\\s*\\})","mg"),a.addStyles=function(a,c){var e,f;if(b[a]==null){b[a]={},e=d.exec(c),f=[];while((e!=null?e.index:void 0)!=null)b[a][e[1]]=e[2],f.push(e=d.exec(c));return f}};return a.getStylesForClass=function(a,c){var d;return((d=b[a])!=null?d[c]:void 0)!=null?b[a][c]:""}}]))}}),e.namespace("TextStore",function(b){return b.initInstance=function(){var b;b=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,a.call(b).concat([function(a){var b,d,e,f;e=a.options,b={},d={},f={},a.addFile=function(a){var e,f,g,h;c.isArray(a)||(a=[a]),h=[];for(f=0,g=a.length;f<g;f++)e=a[f],h.push(function(a){if(a!=null&&b[a]==null&&d[a]==null){d[a]=[];return c.ajax({url:a,type:"GET",processData:!1,success:function(c){var e,f,g,h,i;e=c.documentElement.textContent,b[a]=e,i=d[a];for(g=0,h=i.length;g<h;g++)f=i[g],f(e);return delete d[a]}})}}(e));return h};return a.withFile=function(c,e){if(b[c]!=null)return e(b[c]);if(d[c]!=null)return d[c].push(e);a.addFile(c);return d[c].push(e)}}]))}});return e.namespace("Manifest",function(e){var f,g;f={"http://dms.stanford.edu/ns/":"sc","http://www.shared-canvas.org/ns/":"sc","http://www.w3.org/2000/01/rdf-schema#":"rdfs","http://www.w3.org/1999/02/22-rdf-syntax-ns#":"rdf","http://www.w3.org/2003/12/exif/ns#":"exif","http://purl.org/dc/elements/1.1/":"dc","http://www.w3.org/ns/openannotation/core/":"oa","http://www.openannotation.org/ns/":"oa","http://www.w3.org/ns/openannotation/extension/":"oax","http://www.openarchives.org/ore/terms/":"ore","http://www.shelleygodwinarchive.org/ns/1#":"sga","http://www.shelleygodwinarchive.org/ns1#":"sga","http://www.w3.org/2011/content#":"cnt","http://purl.org/dc/dcmitype/":"dctypes"},g={"http://www.w3.org/1999/02/22-rdf-syntax-ns#type":"item","http://www.w3.org/ns/openannotation/core/hasMotivation":"item"};return e.initInstance=function(){var e;e=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,["SGA.Reader.Data.Manifest"].concat(a.call(e),[function(a){var e,h,i,j,k,l,m,n,o;o=a.options,e=d.Data.Store.initInstance(),a.size=function(){return e.size()},k=d.Data.Importer.RDF_JSON.initInstance(e,f,g),n=[],j=function(d,e){{if(b.call(n,d)<0){n.push(d),a.addItemsToProcess(1);return c.ajax({url:d,type:"GET",contentType:"application/rdf+json",processData:!1,dataType:"json",success:function(b){a.addItemsProcessed(1);return a.importJSON(b,e)},error:function(b){a.addItemsProcessed(1);throw new Error("Could not load the manifest")}})}e()}},a.importJSON=function(a,b){var c;c=d.initSynchronizer(b),c.increment(),k["import"](a,function(a){var b,f;b=d.Data.Set.initInstance(a),f=e.getObjectsUnion(b,"oreisDescribedBy"),f.visit(function(a){c.increment();return j(a,c.decrement)});return c.decrement()});return c.done()},m=function(a){c.isArray(a)||(a=[a]),g=d.Data.Set.initInstance(a);return e.getSubjectsUnion(g,"type").items()},l=function(a){var b,f,g,h,i,j,k,l;c.isArray(a)||(a=[a]),f=d.Data.Set.initInstance(a),i=e.getSubjectsUnion(f,"oahasSource"),h=e.getSubjectsUnion(f,"oahasTarget"),g=e.getSubjectsUnion(i,"oahasTarget"),k=e.getObjectsUnion(g,"oahasBody"),l=e.getObjectsUnion(k,"oahasSource"),j=e.getSubjectsUnion(l,"oahasSource"),b=e.getSubjectsUnion(j,"oahasTarget").items();return b.concat(h.items(),g.items())},h=function(){var a;g=d.Data.Set.initInstance(["sgaSearchAnnotation"]),a=e.getSubjectsUnion(g,"type").items();return e.removeItems(a)},i=function(){var a,b,f,h,i,j,k;g=d.Data.Set.initInstance(["sgaSearchAnnotation"]),f=e.getSubjectsUnion(g,"type"),i=e.getObjectsUnion(f,"oahasTarget"),k=e.getObjectsUnion(i,"oahasSource"),h=e.getSubjectsUnion(k,"oahasSource"),a=e.getSubjectsUnion(h,"oahasBody"),j=e.getObjectsUnion(a,"oahasTarget"),b=e.getObjectsUnion(j,"oahasSource");return c.unique(b.items())},a.getCanvases=function(){return m("scCanvas")},a.getZones=function(){return m("scZone")},a.getSequences=function(){return m("scSequence")},a.getAnnotations=function(){return m("oaAnnotation")},a.getAnnotationsForCanvas=l,a.flushSearchResults=h,a.getSearchResultCanvases=i,a.getItem=e.getItem,a.contains=e.contains;return a.importFromURL=function(a,b){return j(a,function(){if(b!=null)return b()})}}]))}})}),e.namespace("Presentation",function(e){e.namespace("TextContent",function(b){return b.initInstance=function(){var b,e;b=1<=arguments.length?a.call(arguments,0):[];return(e=d.Presentation).initInstance.apply(e,["SGA.Reader.Presentation.TextContent"].concat(a.call(b),[function(a,b){var d,e,f,g;g=a.options,a.setHeight(0),a.events.onWidthChange.addListener(function(a){return c(b).attr("width",a)}),g.width!=null&&a.setWidth(g.width),a.events.onHeightChange.addListener(function(a){return console.log("Height:",a,b)}),f=null,d=function(){f!=null&&clearTimeout(f);return f=setTimeout(function(){var d;d=c(b).height()*10,d>g.height&&a.setHeight(d);return f=null},0)},e=function(a,b,e,f){var g,h,i;i={},g=c("<span></span>"),i.$el=g,h=e.getItem(f),g.text(h.text[0]),g.addClass(h.type.join(" ")),h.css!=null&&!/^\s*$/.test(h.css)&&g.attr("style",h.css[0]),c(a).append(g),d(),i.remove=function(){g.remove();return d()},i.update=function(a){g.text(a.text[0]);return d()};return i},a.addLens("AdditionAnnotation",e),a.addLens("DeletionAnnotation",e),a.addLens("SearchAnnotation",e),a.addLens("LineAnnotation",e),a.addLens("Text",e);return a.addLens("LineBreak",function(a,b,e,f){var g,h;h={},g=c("<br/>"),h.$el=g,c(a).append(g),d(),h.remove=function(){g.remove();return d()},h.update=function(a){};return h})}]))}}),e.namespace("Zone",function(f){return f.initInstance=function(){var g,h;g=1<=arguments.length?a.call(arguments,0):[];return(h=d.Presentation).initInstance.apply(h,["SGA.Reader.Presentation.Zone"].concat(a.call(g),[function(a,g){var h,i,j,k;j=a.options,k=j.svgRoot,i=a.options.application(),a.setHeight(j.height),a.setWidth(j.width),a.setX(j.x),a.setY(j.y),h=a.dataView.prepare(["!target"]),a.addLens("Image",function(a,d,e,f){var g,h,i,l,m,n;if(b.call(j.types||[],"Image")>=0){i={},g=e.getItem(f),l=c(k.root()),n=l.get(0).getAttribute("viewBox"),n==null&&k.configure({viewBox:"0 0 "+j.width+" "+j.height}),m=null,h=function(b){var c,d,e,f,g,h,i,l,n,o;if(((g=b.image)!=null?g[0]:void 0)!=null&&k!=null){e=((h=b.x)!=null?h[0]:void 0)!=null?b.x[0]:0,f=((i=b.y)!=null?i[0]:void 0)!=null?b.y[0]:0,d=((l=b.width)!=null?l[0]:void 0)!=null?b.width[0]:j.width-e,c=((n=b.height)!=null?n[0]:void 0)!=null?b.height[0]:j.height-f,e/=10,f/=10,d/=10,c/=10,m!=null&&k.remove(m);return m=k.image(a,e,f,d,c,(o=b.image)!=null?o[0]:void 0,{preserveAspectRatio:"none"})}},h(g),i.update=h,i.remove=function(){if(m!=null&&k!=null)return k.remove(m)};return i}}),a.addLens("ImageViewer",function(a,d,e,f){var g,h,l,m,n,o,p,q,r,s,t;if(b.call(j.types||[],"Image")>=0){r={},o=e.getItem(f),i.imageControls.setActive(!0),l="http://sga.mith.org:8080/adore-djatoka/resolver",n=o.image[0],g=l+"?url_ver=Z39.88-2004&rft_id="+n,q=org.polymaps,s=c(k.root()),s.get(0).removeAttribute("viewBox"),m=k.group(),p=q.map().container(m),h=c(a).parent().get(0),t=c.ajax({datatype:"json",url:g+"&svc_id=info:lanl-repo/svc/getMetadata",success:adoratio(h,g,p)}),t.then(function(){var a,b;a=!1,b=p.center(),i.imageControls.events.onZoomChange.addListener(function(b){p.zoom(b),i.imageControls.setImgPosition(p.position);return a=!0}),i.imageControls.events.onImgPositionChange.addListener(function(a){if(a.topLeft.x===0&&a.topLeft.y===0)return p.center(b)}),i.imageControls.setZoom(p.zoom()),i.imageControls.setMaxZoom(p.zoomRange()[1]),i.imageControls.setMinZoom(p.zoomRange()[0]),i.imageControls.setImgPosition(p.position),p.on("zoom",function(){a||(i.imageControls.setZoom(p.zoom()),i.imageControls.setImgPosition(p.position),i.imageControls.setMaxZoom(p.zoomRange()[1]));return a=!1});return p.on("drag",function(){return i.imageControls.setImgPosition(p.position)})}),r.update=function(a){return 0},r.remove=function(){i.imageControls.setActive(!1),i.imageControls.setZoom(0),i.imageControls.setMaxZoom(0),i.imageControls.setMinZoom(0),i.imageControls.setImgPosition({topLeft:{x:0,y:0},bottomRight:{x:0,y:0}});return c(k.root()).find("#map").remove()};return r}}),a.addLens("ZoneAnnotation",function(b,e,g,h){var i,l,m,n,o,p,q,r,s,t,u,v,w;l={},s=g.getItem(h),q=null,q=document.createElementNS("http://www.w3.org/2000/svg","svg"),b.appendChild(q),n=((t=item.x)!=null?t[0]:void 0)!=null?item.x[0]:0,o=((u=item.y)!=null?u[0]:void 0)!=null?item.y[0]:0,m=((v=item.width)!=null?v[0]:void 0)!=null?item.width[0]:j.width-n,i=((w=item.height)!=null?w[0]:void 0)!=null?item.height[0]:j.height-o,r=d.Data.SubSet.initInstance({dataStore:g,expressions:["!target"]}),p=f.initInstance(q,{types:j.types,dataView:r,svgRoot:k,application:j.application,heigth:i,width:m}),r.setKey(h),p.events.onHeightChange.addListener(function(a){return c(q).attr("height",a/10)}),p.events.onWidthChange.addListener(function(a){return c(q).attr("width",a/10)}),p.events.onXChange.addListener(function(a){return c(q).attr("x",a/10)}),p.events.onYChange.addListener(function(a){return c(q).attr("y",a/10)}),p.setX(n),p.setY(o),p.setHeight(i),p.setWidth(m),p.events.onHeightChange.addListener(function(b){var c;c=a.getY();if(c+b>a.getHeight())return a.setHeight(c+b)}),l._destroy=function(){p._destroy!=null&&p._destroy();if(r._destroy!=null)return r._destroy()},l.remove=function(){p.setHeight(0),c(q).hide();return l._destroy()},l.update=function(b){var c,d,e,f;n=((c=b.x)!=null?c[0]:void 0)!=null?b.x[0]:0,o=((d=b.y)!=null?d[0]:void 0)!=null?b.y[0]:0,m=((e=b.width)!=null?e[0]:void 0)!=null?b.width[0]:j.width-n,i=((f=b.height)!=null?f[0]:void 0)!=null?b.height[0]:j.height-o,i<p.getHeight()&&(i=p.getHeight()),a.setX(n),a.setY(o),a.setWidth(m);return a.setHeight(i)};return l}),a.addLens("ContentAnnotation",function(a,d,e,f){var g,h,i,k,l,m,n,o,p,q,r,s,t,u;if(b.call(j.types||[],"Text")>=0){l={},i=e.getItem(f),n=document.createElementNS("http://www.w3.org/2000/svg","foreignObject"),p=((r=i.x)!=null?r[0]:void 0)!=null?i.x[0]:0,q=((s=i.y)!=null?s[0]:void 0)!=null?i.y[0]:0,o=((t=i.width)!=null?t[0]:void 0)!=null?i.width[0]:j.width-p,h=((u=i.height)!=null?u[0]:void 0)!=null?i.height[0]:j.height-q,p/=10,q/=10,o/=10,h/=10,c(n).attr("x",p).attr("y",q).attr("width",o).attr("height",h),a.appendChild(n),g=document.createElementNS("http://www.w3.org/1999/xhtml","body"),k=document.createElement("div"),g.appendChild(k),m=document.createElement("div"),c(m).addClass("text-content"),k.appendChild(m),m.text(i.text[0]),l.update=function(a){return m.text(a.text[0])},l.remove=function(){return m.remove()};return l}});return a.addLens("TextContentZone",function(f,g,h,l){var m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H;if(b.call(j.types||[],"Text")>=0){v=c(k.root()),r={},i=j.application(),D=i.imageControls.getZoom(),o=h.getItem(l),x=null,x=document.createElementNS("http://www.w3.org/2000/svg","foreignObject"),x.style.overflow="hidden",f.appendChild(x),m=document.createElementNS("http://www.w3.org/1999/xhtml","body"),q=document.createElement("div"),m.appendChild(q),s=document.createElement("div"),c(s).addClass("text-content"),c(s).attr("id",l),c(s).css("font-size",15),c(s).css("line-height",1.15),q.appendChild(s),x.appendChild(m),y=d.Data.SubSet.initInstance({dataStore:h,expressions:["!target"]}),w=e.TextContent.initInstance(s,{types:j.types,dataView:y,svgRoot:k,application:j.application,height:n,width:A}),y.setKey(l),w.events.onHeightChange.addListener(function(b){b>a.getHeight()&&a.setHeight(b),c(x).attr("height","auto");return c(q).attr("height",b/10)}),B=((E=o.x)!=null?E[0]:void 0)!=null?o.x[0]:0,C=((F=o.y)!=null?F[0]:void 0)!=null?o.y[0]:0,A=((G=o.width)!=null?G[0]:void 0)!=null?o.width[0]:j.width-B,n=((H=o.height)!=null?H[0]:void 0)!=null?o.height[0]:j.height-C,a.setHeight(n),B/=10,C/=10,A/=10,n/=10,c(x).attr("x",B).attr("y",C).attr("width",A).attr("height",n),i.imageControls.getActive()&&(c(".marquee").remove(),u=1,p=k.rect(0,0,Math.max(1,j.width-u),Math.max(1,j.height-u),{"class":"marquee",fill:"yellow",stroke:"navy",strokeWidth:u,fillOpacity:"0.05",strokeOpacity:"0.9"}),t=j.width/c(f).width(),z=100,i.imageControls.events.onZoomChange.addListener(function(a){if(i.imageControls.getMaxZoom()>0){A=Math.round(j.width*10/Math.pow(2,i.imageControls.getMaxZoom()-a)),z=Math.min(100,c(f).width()*100/A),p.setAttribute("width",j.width*z/100),p.setAttribute("height",j.height*z/100);return i.imageControls.getZoom()>i.imageControls.getMaxZoom()-1?c(p).attr("opacity","0"):c(p).attr("opacity","100")}}),i.imageControls.events.onImgPositionChange.addListener(function(a){p.setAttribute("x",-a.topLeft.x*z/100*t);return p.setAttribute("y",-a.topLeft.y*z/100*t)})),r._destroy=function(){w._destroy!=null&&w._destroy();if(y._destroy!=null)return y._destroy()},r.remove=function(){c(x).empty();return k.remove(x)},r.update=function(b){var d,e,f,g;B=((d=b.x)!=null?d[0]:void 0)!=null?b.x[0]:0,C=((e=b.y)!=null?e[0]:void 0)!=null?b.y[0]:0,A=((f=b.width)!=null?f[0]:void 0)!=null?b.width[0]:j.width-B,n=((g=b.height)!=null?g[0]:void 0)!=null?b.height[0]:j.height-C,n>a.getHeight()?a.setHeight(n):n=a.getHeight(),B/=10,C/=10,A/=10;return c(x).attr("x",B).attr("y",C).attr("width",A)};return r}})}]))}});return e.namespace("Canvas",function(b){return b.initInstance=function(){var b,e;b=1<=arguments.length?a.call(arguments,0):[];return(e=d.Presentation).initInstance.apply(e,["SGA.Reader.Presentation.Canvas"].concat(a.call(b),[function(a,b){var e,f,g,h,i,j,k,l,m,n,o,p,q;l=a.options,h=a.dataView.prepare(["!target"]),m=[],e=function(a){return m.push(a)},q=c('<svg xmlns="http://www.w3.org/2000/svg" version="1.1"\n     xmlns:xlink="http://www.w3.org/1999/xlink"\n     width="0" height="0"\n >\n</svg>'),b.append(q),p=c(q).svg({onLoad:function(a){var b,c,d;e=function(b){return b(a)};for(c=0,d=m.length;c<d;c++)b=m[c],b(a);return m=null}}),j=null,i=null,f=null,g=parseInt(c(b).width()*20/20,10),o=function(){return e(function(a){var b,d;q.attr({width:j,height:i}),b=c(a.root()),d=b.get(0).getAttribute("viewBox"),d!=null&&a.configure({viewBox:"0 0 "+j+" "+i});return q.css({width:g,height:f,border:"1px solid #eeeeee","border-radius":"2px","background-color":"#ffffff"})})},a.events.onHeightChange.addListener(function(a){i=a,f=parseInt(g/j*i,10);return o()}),d.events.onWindowResize.addListener(function(){g=parseInt(c(b).width()*20/20,10);if(j!=null&&j>0)return a.setScale(g/j)}),a.events.onScaleChange.addListener(function(a){if(j!=null&&i!=null){f=parseInt(i*a,10);return o()}}),k=d.Data.SubSet.initInstance({dataStore:l.dataView,expressions:["!target"],key:null}),n=null,c(b).on("resetPres",function(){g=parseInt(c(b).width()*20/20,10);if(j!=null&&j>0){a.setScale(g/j),n!=null&&(n.hide!=null&&n.hide(),n._destroy!=null&&n._destroy());return e(function(a){a.clear();return n=SGA.Reader.Presentation.Zone.initInstance(a.root(),{types:l.types,dataView:k,application:l.application,height:i,width:j,svgRoot:a})})}});return a.events.onCanvasChange.addListener(function(d){var f,h,m;k.setKey(d),f=k.getItem(d),j=(((h=f.width)!=null?h[0]:void 0)||1)/10,i=(((m=f.height)!=null?m[0]:void 0)||1)/10,a.setScale(g/j),n!=null&&(n.hide!=null&&n.hide(),n._destroy!=null&&n._destroy());return e(function(d){c(b).trigger("sizeChange",[{w:b.width(),h:b.height()}]),d.clear(),n=SGA.Reader.Presentation.Zone.initInstance(d.root(),{types:l.types,dataView:k,application:l.application,height:i,width:j,svgRoot:d}),a.setHeight(i);return n.events.onHeightChange.addListener(a.setHeight)})})}]))}})}),e.namespace("Data",function(e){e.namespace("StyleStore",function(b){return b.initInstance=function(){var b;b=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,a.call(b).concat([function(a){var b,c,d;c=a.options,b={},d=new RegExp("(?:\\.(\\S+)\\s*\\{\\s*([^}]*)\\s*\\})","mg"),a.addStyles=function(a,c){var e,f;if(b[a]==null){b[a]={},e=d.exec(c),f=[];while((e!=null?e.index:void 0)!=null)b[a][e[1]]=e[2],f.push(e=d.exec(c));return f}};return a.getStylesForClass=function(a,c){var d;return((d=b[a])!=null?d[c]:void 0)!=null?b[a][c]:""}}]))}}),e.namespace("TextStore",function(b){return b.initInstance=function(){var b;b=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,a.call(b).concat([function(a){var b,d,e,f;e=a.options,b={},d={},f={},a.addFile=function(a){var e,f,g,h;c.isArray(a)||(a=[a]),h=[];for(f=0,g=a.length;f<g;f++)e=a[f],h.push(function(a){if(a!=null&&b[a]==null&&d[a]==null){d[a]=[];return c.ajax({url:a,type:"GET",processData:!1,success:function(c){var e,f,g,h,i;e=c.documentElement.textContent,b[a]=e,i=d[a];for(g=0,h=i.length;g<h;g++)f=i[g],f(e);return delete d[a]}})}}(e));return h};return a.withFile=function(c,e){if(b[c]!=null)return e(b[c]);if(d[c]!=null)return d[c].push(e);a.addFile(c);return d[c].push(e)}}]))}});return e.namespace("Manifest",function(e){var f,g;f={"http://dms.stanford.edu/ns/":"sc","http://www.shared-canvas.org/ns/":"sc","http://www.w3.org/2000/01/rdf-schema#":"rdfs","http://www.w3.org/1999/02/22-rdf-syntax-ns#":"rdf","http://www.w3.org/2003/12/exif/ns#":"exif","http://purl.org/dc/elements/1.1/":"dc","http://www.w3.org/ns/openannotation/core/":"oa","http://www.openannotation.org/ns/":"oa","http://www.w3.org/ns/openannotation/extension/":"oax","http://www.openarchives.org/ore/terms/":"ore","http://www.shelleygodwinarchive.org/ns/1#":"sga","http://www.shelleygodwinarchive.org/ns1#":"sga","http://www.w3.org/2011/content#":"cnt","http://purl.org/dc/dcmitype/":"dctypes"},g={"http://www.w3.org/1999/02/22-rdf-syntax-ns#type":"item","http://www.w3.org/ns/openannotation/core/hasMotivation":"item"};return e.initInstance=function(){var e;e=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,["SGA.Reader.Data.Manifest"].concat(a.call(e),[function(a){var e,h,i,j,k,l,m,n,o;o=a.options,e=d.Data.Store.initInstance(),a.size=function(){return e.size()},k=d.Data.Importer.RDF_JSON.initInstance(e,f,g),n=[],j=function(d,e){{if(b.call(n,d)<0){n.push(d),a.addItemsToProcess(1);return c.ajax({url:d,type:"GET",contentType:"application/rdf+json",processData:!1,dataType:"json",success:function(b){a.addItemsProcessed(1);return a.importJSON(b,e)},error:function(b){a.addItemsProcessed(1);throw new Error("Could not load the manifest")}})}e()}},a.importJSON=function(a,b){var c;c=d.initSynchronizer(b),c.increment(),k["import"](a,function(a){var b,f;b=d.Data.Set.initInstance(a),f=e.getObjectsUnion(b,"oreisDescribedBy"),f.visit(function(a){c.increment();return j(a,c.decrement)});return c.decrement()});return c.done()},m=function(a){c.isArray(a)||(a=[a]),g=d.Data.Set.initInstance(a);return e.getSubjectsUnion(g,"type").items()},l=function(a){var b,f,g,h,i,j,k,l;c.isArray(a)||(a=[a]),f=d.Data.Set.initInstance(a),i=e.getSubjectsUnion(f,"oahasSource"),h=e.getSubjectsUnion(f,"oahasTarget"),g=e.getSubjectsUnion(i,"oahasTarget"),k=e.getObjectsUnion(g,"oahasBody"),l=e.getObjectsUnion(k,"oahasSource"),j=e.getSubjectsUnion(l,"oahasSource"),b=e.getSubjectsUnion(j,"oahasTarget").items();return b.concat(h.items(),g.items())},h=function(){var a;g=d.Data.Set.initInstance(["sgaSearchAnnotation"]),a=e.getSubjectsUnion(g,"type").items();return e.removeItems(a)},i=function(){var a,b,f,h,i,j,k;g=d.Data.Set.initInstance(["sgaSearchAnnotation"]),f=e.getSubjectsUnion(g,"type"),i=e.getObjectsUnion(f,"oahasTarget"),k=e.getObjectsUnion(i,"oahasSource"),h=e.getSubjectsUnion(k,"oahasSource"),a=e.getSubjectsUnion(h,"oahasBody"),j=e.getObjectsUnion(a,"oahasTarget"),b=e.getObjectsUnion(j,"oahasSource");return c.unique(b.items())},a.getCanvases=function(){return m("scCanvas")},a.getZones=function(){return m("scZone")},a.getSequences=function(){return m("scSequence")},a.getAnnotations=function(){return m("oaAnnotation")},a.getAnnotationsForCanvas=l,a.flushSearchResults=h,a.getSearchResultCanvases=i,a.getItem=e.getItem,a.contains=e.contains;return a.importFromURL=function(a,b){return j(a,function(){if(b!=null)return b()})}}]))}})}),e.namespace("Component",function(b){b.namespace("ProgressBar",function(b){return b.initInstance=function(){var b;b=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,["SGA.Reader.Component.ProgressBar"].concat(a.call(b),[function(a,b){a.events.onNumeratorChange.addListener(function(d){var e;e=parseInt(100*d/a.getDenominator(),10),e>100&&(e=100);return c(b).find(".bar").css("width",e+"%")}),a.events.onDenominatorChange.addListener(function(d){var e;e=parseInt(100*a.getNumerator()/d,10),e>100&&(e=100);return c(b).find(".bar").css("width",e+"%")}),a.show=function(){return c(b).show()};return a.hide=function(){return c(b).hide()}}]))}}),b.namespace("Spinner",function(b){return b.initInstance=function(){var b;b=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,["SGA.Reader.Component.Spinner"].concat(a.call(b),[function(a,b){a.show=function(){return c(b).show()};return a.hide=function(){return c(b).hide()}}]))}}),b.namespace("SequenceSelector",function(b){return b.initInstance=function(){var b,e;b=1<=arguments.length?a.call(arguments,0):[];return(e=d.Presentation).initInstance.apply(e,["SGA.Reader.Component.SequenceSelector"].concat(a.call(b),[function(a,b){var d;d=a.options;return a.addLens("Sequence",function(b,d,e,f){var g,h,i,j;a.setSequence(f);if(c(b).is("select")){i={},h=e.getItem(f),g=c("<option></option>"),g.attr({value:f}),g.text((j=h.label)!=null?j[0]:void 0),c(b).append(g),c(b).change(function(){return a.setSequence(c(b).val())}),a.events.onSequenceChange.addListener(function(a){return c(b).val(a)});return a.finishDisplayUpdate=function(){return a.setSequence(c(b).val())}}})}]))}}),b.namespace("Slider",function(b){return b.initInstance=function(){var b;b=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,["SGA.Reader.Component.Slider"].concat(a.call(b),[function(a,b){c(".canvas").on("searchResultsChange",function(d,e){var f,g,h,i,j,k,l,m,n,o,p,q;f=c(b),c(".res").remove(),h=a.getMax(),q=[];for(o=0,p=e.length;o<p;o++)i=e[o],i=i+1,k=f.height()/(h+1),j=(h+1)/100,m=f.slider("option","min"),l=f.slider("option","max"),n=100-(i-m)/(l-m)*100,g=j/2,q.push(f.append("<div style='bottom:"+(n+g)+"%; height:"+k+"px' class='res ui-slider-range ui-widget-header ui-corner-all'> </div>"));return q}),a.events.onMaxChange.addListener(function(d){var e;c(b).data("slider")?c(b).slider({max:d}):(e=d,c(b).slider({orientation:"vertical",range:"min",min:a.getMin(),max:e,value:e,step:1,slide:function(a,b){return 0},stop:function(b,c){0;return a.setValue(e-c.value)}}),c(".canvas").on("sizeChange",function(a,d){var e;e=c(b),e.height(d.h);return c(".canvas").unbind("sizeChange")}));if(a.getValue()!=null&&parseInt(a.getValue())!==NaN){c.bbq.pushState({n:a.getValue()+1});return c(b).slider({value:e-a.getValue()})}}),a.events.onMinChange.addListener(function(a){if(c(b).data("slider"))return c(b).slider({min:a})});return a.events.onValueChange.addListener(function(d){c(b).data("slider")&&c(b).slider({value:a.getMax()-d});if(a.getValue()!=null&&parseInt(a.getValue())!==NaN)return c.bbq.pushState({n:a.getValue()+1})})}]))}}),b.namespace("PagerControls",function(b){return b.initInstance=function(){var b;b=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,["SGA.Reader.Component.PagerControls"].concat(a.call(b),[function(a,b){var d,e,f,g,h;c(window).bind("hashchange",function(b){var d;d=c.bbq.getState("n");if(d!=null&&parseInt(d)!==NaN)return a.setValue(d-1)}),d=c(b).find("#first-page"),g=c(b).find("#prev-page"),f=c(b).find("#next-page"),e=c(b).find("#last-page"),a.events.onMinChange.addListener(function(b){if(b<a.getValue()){d.removeClass("disabled");return g.removeClass("disabled")}d.addClass("disabled");return g.addClass("disabled")}),a.events.onMaxChange.addListener(function(b){if(b>a.getValue()){f.removeClass("disabled");return e.removeClass("disabled")}f.addClass("disabled");return e.addClass("disabled")}),a.events.onValueChange.addListener(function(b){b>a.getMin()?(d.removeClass("disabled"),g.removeClass("disabled")):(d.addClass("disabled"),g.addClass("disabled"));if(b<a.getMax()){f.removeClass("disabled");return e.removeClass("disabled")}f.addClass("disabled");return e.addClass("disabled")}),h=function(){if(a.getValue()!=null&&parseInt(a.getValue())!==NaN)return c.bbq.pushState({n:a.getValue()+1})},c(g).click(function(b){b.preventDefault(),a.addValue(-1);return h()}),c(f).click(function(b){b.preventDefault(),a.addValue(1);return h()}),c(d).click(function(b){b.preventDefault(),a.setValue(a.getMin());return h()});return c(e).click(function(b){b.preventDefault(),a.setValue(a.getMax());return h()})}]))}}),b.namespace("ImageControls",function(b){return b.initInstance=function(){var b;b=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,["SGA.Reader.Component.ImageControls"].concat(a.call(b),[function(a,b){var d,e,f,g;g=c(b).find("#zoom-reset"),d=c(b).find("#zoom-in"),f=c(b).find("#zoom-out"),e=c(b).find("#marquee-sh"),c(g).click(function(b){b.preventDefault(),a.setZoom(a.getMinZoom());return a.setImgPosition({topLeft:{x:0,y:0},bottomRight:{x:0,y:0}})}),c(d).click(function(b){var c;b.preventDefault(),c=a.getZoom();if(Math.floor(c+1<=a.getMaxZoom()))return a.setZoom(Math.floor(c+1))}),c(f).click(function(b){var c,d;b.preventDefault(),d=a.getZoom(),c=a.getMinZoom();if(Math.floor(d-1>c))return a.setZoom(Math.floor(d-1));if(Math.floor(d-1===Math.floor(c)))return a.setZoom(c)});return c(e).click(function(a){var b;a.preventDefault(),b=c(".marquee");return b.each(function(a,b){b=c(b);return b.css("display")!=="none"?b.hide():b.show()})})}]))}}),b.namespace("SearchBox",function(b){return b.initInstance=function(){var b;b=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,["SGA.Reader.Component.SearchBox"].concat(a.call(b),[function(a,d){var e,f,g;a.events.onQueryChange.addListener(function(a){a=a.replace(/\=/g,":"),a=a.replace(/\&/g,"|");return c.bbq.pushState({s:a})}),e=b[0],a.setServiceURL(d),f=c("#search-btn"),g=c(e).closest("form"),f!=null&&f.click(function(){return g.submit()});return g.submit(function(b){var d,f,g,h,i,j,k;b.preventDefault(),g=c("#limit-search").find("input:checked"),f="";if(g.length===0)f="text";else for(h=j=0,k=g.length;j<k;h=++j)d=g[h],f+=c(d).val(),h+1!==g.length&&(f+=",");i=c(e).find("input").val(),i.match("^s*$")||a.setQuery("f="+f+"&q="+i);return!1})}]))}}),b.namespace("ModeControls",function(b){return b.initInstance=function(){var b;b=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,["SGA.Reader.Component.ModeControls"].concat(a.call(b),[function(a,b){var d,e,f,g,h;d=c(b).find("#img-only"),g=c(b).find("#mode-rdg"),h=c(b).find("#mode-xml"),e=c(b).find("#mode-std"),f=null,c(d).click(function(b){var e;b.preventDefault();if(!c(d).hasClass("active")){f=c("*[data-types=Text]").parent(),c("*[data-types=Text]").parent().remove(),e=/col-lg-(\d+)/g.exec(c("*[data-types=Image]").parent()[0].className),c("*[data-types=Image]").parent()[0].className="col-lg-"+parseInt(e[1])*2,c("*[data-types=Image]").trigger("resetPres");return a.setMode("imgOnly")}});return c(e).click(function(a){var b,d;a.preventDefault();if(!c(e).hasClass("active")&&f!=null){d=c("*[data-types=Image]").parent(),b=/col-lg-(\d+)/g.exec(c("*[data-types=Image]").parent()[0].className),d[0].className="col-lg-"+parseInt(b[1])/2,f.insertAfter(d);return c("*[data-types=Image]").trigger("resetPres")}})}]))}});return b.namespace("LimitViewControls",function(b){return b.initInstance=function(){var b;b=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,["SGA.Reader.Component.LimitViewControls"].concat(a.call(b),[function(a,b){var d;d=c(b),d.find("#hand-view_2").change(function(){var a;if(c(this).is(":checked")){a="svg .hand-pbs{ color:#a54647; } \nsvg *:not(.hand-pbs), svg .DeletionAnnotation:not(.hand-pbs){ color:#D9D9D9; }\nsvg .DeletionAnnotation.hand-pbs{ color:#a54647; }",c("#LimitViewControls_classes").remove();return c("<style type='text/css' id='LimitViewControls_classes'>"+a+"</style>").appendTo("head")}}),d.find("#hand-view_1").change(function(){var a;if(c(this).is(":checked")){a="svg .hand-pbs{ color:#D9D9D9; } \nsvg *:not(.hand-pbs), svg .DeletionAnnotation.hand-pbs{ color:#a54647; }\nsvg .DeletionAnnotation:not(.hand-pbs){ color:#a54647 }",c("#LimitViewControls_classes").remove();return c("<style type='text/css' id='LimitViewControls_classes'>"+a+"</style>").appendTo("head")}});return d.find("#hand-view_0").change(function(){if(c(this).is(":checked"))return c("#LimitViewControls_classes").remove()})}]))}})});return e.namespace("Application",function(e){return e.namespace("SharedCanvas",function(f){f.initInstance=function(){var e,f;e=1<=arguments.length?a.call(arguments,0):[];return(f=d.Application).initInstance.apply(f,["SGA.Reader.Application.SharedCanvas"].concat(a.call(e),[function(a){var e,f,g,h,i,j,k,l;j=a.options,k=[],a.addPresentation=function(b){var c;c=SGA.Reader.Presentation.Canvas.initInstance(b.container,{types:b.types,application:function(){return a},dataView:a.dataView.canvasAnnotations});return k.push([c,b.container])},e=null,a.events.onSequenceChange.addListener(function(b){var d,f,g,h,i,j;e=b,i=a.dataStore.data.getItem(e),d=c.param.fragment(window.location.href),h=c.deparam(d),f=parseInt(h.n),h.n==null||i.sequence.length<(j=f-1)||j<0?((i!=null?i.sequence:void 0)!=null&&(g=i.sequence.indexOf(a.getCanvas())),g<0&&(g=0)):g=f-1;return a.setPosition(g)}),a.events.onPositionChange.addListener(function(b){var c,d,f;d=a.dataStore.data.getItem(e),c=(f=d.sequence)!=null?f[b]:void 0;return a.setCanvas(c)}),a.events.onCanvasChange.addListener(function(b){var c,d,f,g,h,i;a.dataView.canvasAnnotations.setKey(b),h=a.dataStore.data.getItem(e),g=h.sequence.indexOf(b),g>=0&&g!==a.getPosition()&&a.setPosition(g),f=(i=h.sequence)!=null?i[g]:void 0,c=a.dataView.canvasAnnotations.items(),c.length>0&&(a.dataView.canvasAnnotations.removeItems(c),d=a.getAnnotationsForCanvas(f),a.dataStore.data.removeItems(d)),Q.nfcall(a.loadCanvas,b).then(function(){return setTimeout(function(){var a,c,d,e;e=[];for(c=0,d=k.length;c<d;c++)a=k[c],e.push(a[0].setCanvas(b));return e},100)});return b}),i=SGA.Reader.Data.Manifest.initInstance(),a.events.onItemsProcessedChange=i.events.onItemsProcessedChange,a.events.onItemsToProcessChange=i.events.onItemsToProcessChange,a.getItemsProcessed=i.getItemsProcessed,a.getItemsToProcess=i.getItemsToProcess,a.setItemsProcessed=i.setItemsProcessed,a.setItemsToProcess=i.setItemsToProcess,a.addItemsProcessed=i.addItemsProcessed,a.addItemsToProcess=i.addItemsToProcess,a.addManifestData=i.importFromURL,a.getAnnotationsForCanvas=i.getAnnotationsForCanvas,a.flushSearchResults=i.flushSearchResults,a.getSearchResultCanvases=i.getSearchResultCanvases,l=SGA.Reader.Data.TextStore.initInstance(),a.withSource=l.withFile,f=function(a,c){var d,e,f,g;if(c!=null){e=i.getItem(c);if(b.call(e.type,"oaFragmentSelector")<0){e.oaxbegin!=null&&(a.start=parseInt((f=e.oaxbegin)!=null?f[0]:void 0,10));if(e.oaxend!=null)return a.end=parseInt((g=e.oaxend)!=null?g[0]:void 0,10)}else if(e.rdfvalue[0].substr(0,5)==="xywh="){a.shape="Rectangle",d=e.rdfvalue[0].substr(5).split(","),a.x=parseInt(d[0],10),a.y=parseInt(d[1],10),a.width=parseInt(d[2],10);return a.height=parseInt(d[3],10)}}},h=function(a,c){var d,e,g;if(c!=null){e=i.getItem(c);if(b.call(e.type,"oaSpecificResource")<0)return a.target=c;a.target=e.oahasSource,e.oahasStyle!=null&&(d=i.getItem(e.oahasStyle[0]),b.call(d.dcformat,"text/css")>=0&&(a.css=d.cntchars)),e.sgahasClass!=null&&(a.cssclass=e.sgahasClass[0]);return f(a,(g=e.oahasSelector)!=null?g[0]:void 0)}},g=function(a,b){var c,d
;if(b!=null){c=i.getItem(b),l.addFile(c.oahasSource),a.source=c.oahasSource;return f(a,(d=c.oahasSelector)!=null?d[0]:void 0)}},a.loadCanvas=function(e,j){var k,l,m,n,o,p;l=Q.defer(),m=[],p={},o=[],n=d.initSynchronizer(),k=i.getAnnotationsForCanvas(e),a.addItemsToProcess(k.length),n.process(k,function(d){var e,j,k,l,n,q,r,s,t,u,v,w;a.addItemsProcessed(1),e=i.getItem(d),j=null,n={id:d},b.call(e.type,"scContentAnnotation")<0?b.call(e.type,"scImageAnnotation")<0?b.call(e.type,"scZoneAnnotation")<0?(q=function(){var a,b,c,d;c=e.type,d=[];for(a=0,b=c.length;a<b;a++)k=c[a],k.substr(0,3)==="sga"&&k.substr(k.length-10)==="Annotation"&&d.push(k.substr(3));return d}(),q.length>0&&(h(n,(w=e.oahasTarget)!=null?w[0]:void 0),n.type=q,j=o)):(r=i.getItem(e.oahasTarget),f(n,(v=r.hasSelector)!=null?v[0]:void 0),j=m,n.target=r.hasSource,n.label=e.rdfslabel,n.type="ZoneAnnotation"):(l=i.getItem(e.oahasBody),c.isArray(l)&&(l=l[0]),j=m,n.target=e.oahasTarget,n.label=e.rdfslabel,n.image=l.oahasSource||e.oahasBody,n.type="Image",b.call(l.dcformat,"image/jp2")>=0&&a.imageControls!=null&&(n.type="ImageViewer")):(h(n,(t=e.oahasTarget)!=null?t[0]:void 0),g(n,(u=e.oahasBody)!=null?u[0]:void 0),n.start!=null&&n.end!=null&&(p[s=n.source]==null&&(p[s]=[]),p[n.source].push([d,n.start,n.end])),n.text!=null?n.type="ContentAnnotation":n.type="TextContentZone",j=m);if(n.type!=null&&j!=null)return j.push(n)}),n.done(function(){a.addItemsToProcess(1+o.length);return a.dataStore.data.loadItems(m,function(){var d,e,f,g,h,i,j,k,n,q,r,s,t;m=[],g={},f={},e={},i=function(a){var b,d,h,i,j,k;h=a.target,i=a.start,b=a.end,d=a.id,c.isArray(d)&&(d=d[0]),e[d]=a,g[h]==null&&(g[h]={}),(j=g[h])[i]==null&&(j[i]=[]),g[h][i].push(d),f[h]==null&&(f[h]={}),(k=f[h])[b]==null&&(k[b]=[]);return f[h][b].push(d)};for(q=0,s=o.length;q<s;q++)d=o[q],i(d);k=function(){var a;a=[];for(h in g)a.push(h);return a}(),a.addItemsToProcess(k.length),a.addItemsProcessed(o.length),n=function(d){return a.withSource(d,function(i){var j,k,l,m,n,o,q,r,s,t,u,v,w,x,y,z,A,B,C,D,E,F,G,H;z=[],r=[],j=!1,y=function(a,b,c,e,f){return z.push({type:a,css:b.join(" "),text:i.slice(e,f),id:d+"-"+e+"-"+f,target:c,start:e,end:f})},x=function(a,b){var d,f,g,h,i;d=[],f=[];for(h=0,i=r.length;h<i;h++)g=r[h],d.push(e[g].type),e[g].cssclass!=null&&d.push(e[g].cssclass),c.isArray(e[g].css)?f.push(e[g].css.join(" ")):f.push(e[g].css);d.length===0&&d.push("Text");return o(a,b,d,f)},o=function(a,b,c,e){var f,g,i,j,k;k=p[d]||[];for(i=0,j=k.length;i<j;i++)f=k[i],a<=f[2]&&b>=f[1]&&(h=Math.min(Math.max(a,f[1]),f[2]),g=Math.max(Math.min(b,f[2]),f[1]),y(c,e,f[0],h,g));return!1},n=function(a){var b;b=["LineBreak"];return o(a,a,b,[""])},s=g[d]||[],q=f[d]||[],m=0,w=function(){var a;a=[];for(u in s)a.push(parseInt(u,10));return a}().concat(function(){var a;a=[];for(u in q)a.push(parseInt(u,10));return a}()).sort(function(a,b){return a-b});for(A=0,C=w.length;A<C;A++){v=w[A];if(v!==m){x(m,v),j&&!i.substr(m,v-m).match(/^\s*$/)&&(j=!1),t=!1,G=s[v]||[];for(B=0,D=G.length;B<D;B++)k=G[B],b.call(e[k].type,"LineAnnotation")>=0&&(t=!0),r.push(k);H=q[v]||[];for(F=0,E=H.length;F<E;F++)k=H[F],b.call(e[k].type,"LineAnnotation")>=0&&(t=!0),l=r.indexOf(k),l>-1&&r.splice(l,1);t&&!j&&(n(v),j=!0),m=v}}x(m,i.length);return a.dataStore.data.loadItems(z,function(){return a.addItemsProcessed(1)})})};for(r=0,t=k.length;r<t;r++)j=k[r],n(j);l.resolve();return a.addItemsProcessed(1)})}),j!=null&&j();return l.promise};if(j.url!=null)return i.importFromURL(j.url,function(){var b,c,e,f,g;c=[],f=d.initSynchronizer(),b=i.getCanvases(),a.addItemsToProcess(b.length),f.process(b,function(b){var d,e,f;a.addItemsProcessed(1),d=i.getItem(b);return c.push({id:b,type:"Canvas",width:parseInt((e=d.exifwidth)!=null?e[0]:void 0,10),height:parseInt((f=d.exifheight)!=null?f[0]:void 0,10),label:d.dctitle||d.rdfslabel})}),g=i.getZones(),a.addItemsToProcess(g.length),f.process(g,function(b){var d,e,f,g;a.addItemsProcessed(1),d=i.getItem(b);return c.push({id:b,type:"Zone",width:parseInt((e=mitem.exifwidth)!=null?e[0]:void 0,10),height:parseInt((f=mitem.exifheight)!=null?f[0]:void 0,10),angle:parseInt((g=mitem.scnaturalAngle)!=null?g[0]:void 0,10)||0,label:d.rdfslabel})}),e=i.getSequences(),a.addItemsToProcess(e.length),f.process(e,function(b){var d,f;a.addItemsProcessed(1),f=i.getItem(b),d={id:b,type:"Sequence",label:f.rdfslabel},e=[],e.push(f.rdffirst[0]),f=i.getItem(f.rdfrest[0]);while(f.id!=null)e.push(f.rdffirst[0]),f=i.getItem(f.rdfrest[0]);d.sequence=e;return c.push(d)});return f.done(function(){return a.dataStore.data.loadItems(c)})})}]))};return f.builder=function(a){var b,d,f,g,h,i,j,k;d={manifests:{}},b={},f=function(){},g=function(){},i=function(){},h=function(){},a.spinner!=null&&(i=function(){var b,c,e,f,g;f=d.manifests,g=[];for(b in f)c=f[b],e=c.getItemsToProcess(),g.push(c.events.onItemsToProcessChange.addListener(function(b){if(b>e)return a.spinner.hide()}));return g}),a.progressTracker!=null&&(f=function(){var b,c,e,f,g;e=0,b=0,g=d.manifests;for(c in g)f=g[c],e+=f.getItemsProcessed(),b+=f.getItemsToProcess();a.progressTracker.setNumerator(e);return a.progressTracker.setDenominator(b||1)},j=null,k=1e3,g=function(){if(j!=null)return k=500;j=function(){var b,c,e;e=d.manifests;for(b in e){c=e[b];if(c.getItemsToProcess()>c.getItemsProcessed()){a.progressTracker.show(),k/=2,k<500&&(k=500),setTimeout(j,k);return}}k>500&&a.progressTracker.hide(),k*=2,k>1e4&&(k=1e4);return setTimeout(j,k)};return j()}),a.searchBox!=null&&(a.searchBox.getServiceURL()!=null?(c.param.fragment.noEscape(":,/|"),h=function(b){var e,f,g,h,i;g=a.searchBox.getServiceURL()+b,h=d.manifests,i=[];for(e in h)f=h[e],f.flushSearchResults(),i.push(f.addManifestData(g,function(){var a,b,d,e,g,h,i,j,k,l;g=f.getPosition(),h=f.getSequence(),i=f.dataStore.data.getItem(h),a=(l=i.sequence)!=null?l[g]:void 0,b=f.getSearchResultCanvases(),e=[];for(j=0,k=b.length;j<k;j++)d=b[j],e.push(c.inArray(d,i.sequence));c(".canvas").trigger("searchResultsChange",[e]);return Q.fcall(f.loadCanvas,a).then(function(){var a;g===0?a=g+1:a=g-1,setTimeout(function(){return f.setPosition(a,0)});return setTimeout(function(){return f.setPosition(g,0)})})}));return i},a.searchBox.events.onQueryChange.addListener(function(a){return h(a)})):console.log("You must specify the URL to some search service.")),d.onManifest=function(a,c){if(d.manifests[a]!=null)return d.manifests[a].ready(function(){return c(d.manifests[a])});b[a]==null&&(b[a]=[]);return b[a].push(c)},d.addPresentation=function(j){var k,l,m,n;l=c(j).data("manifest");if(l!=null){k=d.manifests[l],k==null&&(k=e.SharedCanvas.initInstance({url:l}),d.manifests[l]=k,k.ready(function(){var a,c,d,e;c=b[l]||[];for(d=0,e=c.length;d<e;d++)a=c[d],a(k);return delete b[l]}),k.events.onItemsToProcessChange.addListener(f),k.events.onItemsProcessedChange.addListener(f),g(),i(),a.searchBox!=null&&k.ready(function(){var a;if(k.getSequence()==null)return a=k.events.onSequenceChange.addListener(function(){var b;b=c.bbq.getState("s"),b!=null&&(b=b.replace(/:/g,"="),b=b.replace(/\|/g,"&"),h(b));return a()})})),k.run(),m=(n=c(j).data("types"))!=null?n.split(/\s*,\s*/):void 0;return d.onManifest(l,function(a){return a.addPresentation({types:m,container:c(j)})})}},a["class"]==null&&(a["class"]=".canvas"),c(a["class"]).each(function(a,b){return d.addPresentation(b)});return d}})})})})(jQuery,MITHgrid),MITHgrid.defaults("SGA.Reader.Application.SharedCanvas",{dataStores:{data:{types:{Sequence:{},Canvas:{}},properties:{target:{valueType:"item"}}}},dataViews:{canvasAnnotations:{dataStore:"data",type:MITHgrid.Data.SubSet,expressions:["!target"]},sequences:{dataStore:"data",types:["Sequence"]}},variables:{Canvas:{is:"rw"},Sequence:{is:"rw"},Position:{is:"lrw",isa:"numeric"}}}),MITHgrid.defaults("SGA.Reader.Component.Slider",{variables:{Min:{is:"rw",isa:"numeric"},Max:{is:"rw",isa:"numeric"},Value:{is:"rw",isa:"numeric"}}}),MITHgrid.defaults("SGA.Reader.Component.PagerControls",{variables:{Min:{is:"rw",isa:"numeric"},Max:{is:"rw",isa:"numeric"},Value:{is:"rw",isa:"numeric"}}}),MITHgrid.defaults("SGA.Reader.Component.SequenceSelector",{variables:{Sequence:{is:"rw"}}}),MITHgrid.defaults("SGA.Reader.Component.ProgressBar",{variables:{Numerator:{is:"rw","default":0,isa:"numeric"},Denominator:{is:"rw","default":1,isa:"numeric"}},viewSetup:'<div class="progress progress-striped active">\n  <div class="bar" style="width: 0%;"></div>\n</div>'}),MITHgrid.defaults("SGA.Reader.Component.Spinner",{viewSetup:'<i class="icon-spinner icon-spin icon-3x"></i>'}),MITHgrid.defaults("SGA.Reader.Presentation.Canvas",{variables:{Canvas:{is:"rw"},Scale:{is:"rw",isa:"numeric"},ImgOnly:{is:"rw"},Height:{is:"rw",isa:"numeric"},Width:{is:"rw",isa:"numeric"},X:{is:"rw",isa:"numeric"},Y:{is:"rw",isa:"numeric"}}}),MITHgrid.defaults("SGA.Reader.Presentation.TextContent",{variables:{Height:{is:"rw",isa:"numeric"},Width:{is:"rw",isa:"numeric"},X:{is:"rw",isa:"numeric"},Y:{is:"rw",isa:"numeric"}}}),MITHgrid.defaults("SGA.Reader.Presentation.Zone",{variables:{Height:{is:"rw",isa:"numeric"},Width:{is:"rw",isa:"numeric"},X:{is:"rw",isa:"numeric"},Y:{is:"rw",isa:"numeric"}}}),MITHgrid.defaults("SGA.Reader.Data.Manifest",{variables:{ItemsToProcess:{is:"rw","default":0,isa:"numeric"},ItemsProcessed:{is:"rw","default":0,isa:"numeric"}}}),MITHgrid.defaults("SGA.Reader.Component.ImageControls",{variables:{Active:{is:"rw","default":!1},Zoom:{is:"rw","default":0,isa:"numeric"},MaxZoom:{is:"rw","default":0,isa:"numeric"},MinZoom:{is:"rw","default":0,isa:"numeric"},ImgPosition:{is:"rw","default":{}}}}),MITHgrid.defaults("SGA.Reader.Component.SearchBox",{variables:{Field:{is:"rw","default":!1},Query:{is:"rw","default":!1},ServiceURL:{is:"rw","default":!1}}}),MITHgrid.defaults("SGA.Reader.Component.ModeControls",{variables:{Mode:{is:"rw"}}})}).call(this);