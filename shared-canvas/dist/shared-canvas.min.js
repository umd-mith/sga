// Generated by CoffeeScript 1.3.3
/*
# SGA Shared Canvas v0.0.1
#
# **SGA Shared Canvas** is a shared canvas reader written in CoffeeScript.
#
#  
# Date: Mon Nov 26 11:34:38 2012 -0800
#
# License TBD.
#
*/
(function(){var a=[].slice,b=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};(function(c,d){d.globalNamespace("SGA");return SGA.namespace("Reader",function(e){e.namespace("Data",function(e){e.namespace("TextStore",function(b){return b.initInstance=function(){var b;b=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,a.call(b).concat([function(a){var b,d,e,f;e=a.options,b={},d={},f={},a.addFile=function(a){var e,f,g,h;c.isArray(a)||(a=[a]),h=[];for(f=0,g=a.length;f<g;f++)e=a[f],h.push(function(a){if(a!=null&&b[a]==null&&d[a]==null){d[a]=[];return c.ajax({url:a,type:"GET",processData:!1,success:function(c){var e,f,g,h,i;e=c.documentElement.textContent,b[a]=e,i=d[a];for(g=0,h=i.length;g<h;g++)f=i[g],f(e);return delete d[a]}})}}(e));return h};return a.withFile=function(a,c){if(b[a]!=null)return c(b[a]);if(d[a]!=null)return d[a].push(c)}}]))}});return e.namespace("Manifest",function(e){var f;f={"http://dms.stanford.edu/ns/":"sc","http://www.shared-canvas.org/ns/":"sc","http://www.w3.org/2000/01/rdf-schema#":"rdfs","http://www.w3.org/1999/02/22-rdf-syntax-ns#":"rdf","http://www.w3.org/2003/12/exif/ns#":"exif","http://purl.org/dc/elements/1.1/":"dc","http://www.w3.org/ns/openannotation/core/":"oa","http://www.openannotation.org/ns/":"oa","http://www.w3.org/ns/openannotation/extension/":"oax","http://www.openarchives.org/ore/terms/":"ore","http://www.shelleygodwinarchive.org/ns/1#":"sga","http://www.shelleygodwinarchive.org/ns1#":"sga"};return e.initInstance=function(){var e;e=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,["SGA.Reader.Data.Manifest"].concat(a.call(e),[function(a){var e,g,h,i,j;j=a.options,e=d.Data.Store.initInstance(),a.size=function(){return e.size()},i=[],g=function(d,e){{if(b.call(i,d)<0){i.push(d),a.addItemsToProcess(1);return c.ajax({url:d,type:"GET",contentType:"application/rdf+json",processData:!1,dataType:"json",success:function(b){return a.importJSON(b,e)},error:e})}e()}},a.importJSON=function(b,c){var h,i,j,k;h=[],k=d.initSynchronizer(function(){a.addItemsProcessed(1);return setTimeout(function(){var a,b,d;for(b=0,d=h.length;b<d;b++)a=h[b],e.contains(a.id)?e.updateItems([a]):e.loadItems([a]);if(c!=null)return c()},0)}),j=function(){var a;a=[];for(i in b)b.hasOwnProperty(i)&&a.push(i);return a}(),a.addItemsToProcess(j.length),k.process(j,function(c){var d,e,i,j,l,m,n,o,p,q,r,s,t,u,v,w,x,y;o=b[c],d={id:c};for(l in o){j=o[l],q=[];if(l==="http://www.w3.org/1999/02/22-rdf-syntax-ns#type"){for(r=0,u=j.length;r<u;r++){i=j[r];if(i.type==="uri")for(e in f)n=f[e],i.value.slice(0,e.length)===e&&q.push(n+i.value.substr(e.length))}d.type=q}else{for(s=0,v=j.length;s<v;s++)i=j[s],i.type==="literal"?q.push(i.value):i.type==="uri"?i.value.substr(0,1)==="("&&i.value.substr(-1)===")"?q.push("_:"+i.value.substr(1,i.value.length-2)):q.push(i.value):i.type==="bnode"&&(i.value.substr(0,1)==="("&&i.value.substr(-1)===")"?q.push("_:"+i.value.substr(1,i.value.length-2)):q.push(i.value));if(q.length>0)for(e in f)n=f[e],l.substr(0,e.length)===e&&(m=n+l.substr(e.length),d[m]=q)}}if(d.type==null||d.type.length===0)d.type="Blank";if(((x=d.oreisDescribedBy)!=null?x.length:void 0)>0){y=d.oreisDescribedBy;for(t=0,w=y.length;t<w;t++)p=y[t],k.increment(),g(p,k.decrement)}else h.push(d);return a.addItemsProcessed(1)});return k.done()},h=function(a){var b;c.isArray(a)||(a=[a]),b=d.Data.Set.initInstance(a);return e.getSubjectsUnion(b,"type").items()},a.getCanvases=function(){return h("scCanvas")},a.getSequences=function(){return h("scSequence")},a.getAnnotations=function(){return h("oaAnnotation")},a.getItem=e.getItem,a.contains=e.contains;return a.importFromURL=function(a,b){return g(a,function(){if(b!=null)return b()})}}]))}})}),e.namespace("Presentation",function(e){return e.namespace("Canvas",function(e){return e.initInstance=function(){var e,f;e=1<=arguments.length?a.call(arguments,0):[];return(f=d.Presentation).initInstance.apply(f,["SGA.Reader.Presentation.Canvas"].concat(a.call(e),[function(a,e){var f,g,h,i,j,k,l,m,n,o,p,q;n=a.options,m=null,i=a.dataView.prepare(["!target"]),o=[],f=function(a){return o.push(a)},q=c('<svg xmlns="http://www.w3.org/2000/svg" version="1.1"\n     xmlns:xlink="http://www.w3.org/1999/xlink"\n     width="0" height="0"\n >\n</svg>'),e.append(q),p=c(q).svg({onLoad:function(a){var b,c,d;f=function(b){return b(a)};for(c=0,d=o.length;c<d;c++)b=o[c],b(a);return o=null}}),k=null,j=null,g=null,h=c(e).width()*19/20,d.events.onWindowResize.addListener(function(){h=c(e).width()*19/20;if(k!=null)return a.setScale(h/k)}),a.events.onScaleChange.addListener(function(a){if(k!=null&&j!=null){g=j*a;return f(function(a){q.attr({width:h,height:g,viewbox:"0 0 "+h+" "+g});return q.css({width:h,height:g,border:"0.5em solid #eeeeee","border-radius":"5px","background-color":"#ffffff"})})}}),l=d.Data.SubSet.initInstance({dataStore:n.dataView,expressions:["!target"],key:null}),a.events.onCanvasChange.addListener(function(b){var c,d,e;l.setKey(b),c=l.getItem(b),k=((d=c.width)!=null?d[0]:void 0)||1,j=((e=c.height)!=null?e[0]:void 0)||1;return a.setScale(h/k)}),a.addLens("Image",function(a,c,d,e){var g,h,i;if(b.call(n.types||[],"Image")>=0){h={},g=d.getItem(e),i=null,f(function(a){var b;return i=a.image(0,0,"100%","100%",(b=g.image)!=null?b[0]:void 0,{preserveAspectRatio:"none"})}),h.update=function(a){},h.remove=function(){return f(function(a){return a.remove(i)})};return h}});return a.addLens("TextContent",function(a,d,e,g){var h,j,k,l,m,o,p,q,r,s;if(b.call(n.types||[],"Text")>=0){o={},h=n.application(),k=e.getItem(g),q=null,m=function(a){var c;c=[],b.call(a.modes,"LineAnnotation")>=0&&c.push("line"),b.call(a.modes,"AdditionAnnotation")>=0&&c.push("addition"),b.call(a.modes,"DeletionAnnotation")>=0&&c.push("deletion"),c.length===0&&c.push("text");return{type:"span",text:a.acc,classes:c.join(" "),modes:a.modes}},j=function(a){var b,c,d,e,f,g,h,i,j,k,l,n,o,p;j=a.text,f=a.mods,g=a.offset,c={acc:"",modes:[]},i=[],b=!1;for(h=k=0,o=j.length;0<=o?k<o:k>o;h=0<=o?++k:--k)if(f[h+g]==null)j[h].match(/^\s+$/)||(b=!1),c.acc+=j[h];else{c.acc.match(/^\s*$/)?c.acc="":i.push(m(c)),c.acc=j[h],p=f[h+g];for(l=0,n=p.length;l<n;l++)e=p[l],e.type==="LineAnnotation"&&(b||(i.push({type:"br",modes:[],acc:""}),b=!0)),e.action==="start"&&c.modes.push(e.type),e.action==="end"&&(c.modes=function(){var a,b,f,g;f=c.modes,g=[];for(a=0,b=f.length;a<b;a++)d=f[a],d!==e.type&&g.push(d);return g}())}i.push(m(c));return i},r="",l={},s=null,p=function(a,b,d){c.isArray(a)&&(a=a[0]),l[a]==null&&(l[a]=[]),c.isArray(d)&&(d=d[0]);return l[a].push({action:b,type:d})},f(function(a){var b,d;s=document.createElementNS("http://www.w3.org/2000/svg","foreignObject"),c(s).attr("x",0).attr("y",0).attr("width","100%").attr("height","100%"),b=a.root(),b.appendChild(s);return h.withSource((d=k.source)!=null?d[0]:void 0,function(a){var b,d,f,g,h,m,n,o,q,t,u,v,w,x,y,z,A,B,C,D;r=a.substr(k.start[0],k.end[0]),B=i.evaluate(k.source);for(v=0,y=B.length;v<y;v++)b=B[v],h=e.getItem(b),t=h.start[0],g=h.end[0],t<=k.end[0]&&g>=k.start[0]&&(t<k.start[0]&&(t=k.start[0]),g>k.end[0]&&(g=k.end[0]),p(h.start,"start",h.type),p(h.end,"end",h.type));o=j({text:r,mods:l,offset:k.start[0]}),u={},d=document.createElementNS("http://www.w3.org/1999/xhtml","body"),q=document.createElement("div"),c(q).addClass("text-content"),d.appendChild(q);for(w=0,z=o.length;w<z;w++){n=o[w],f=c("<"+n.type+" />"),n.type==="br"?c(q).append(c("<span class='linebreak'></span>")):f.text(n.text),f.addClass(n.classes),c(q).append(f),C=n.modes;for(x=0,A=C.length;x<A;x++)m=C[x],(D=u[m])==null&&(u[m]=[]),u[m].push(f)}return s.appendChild(d)})}),o.update=function(a){},o.remove=function(){return f(function(a){return a.remove(s)})};return o}})}]))}})}),e.namespace("Component",function(b){b.namespace("ProgressBar",function(b){return b.initInstance=function(){var b;b=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,["SGA.Reader.Component.ProgressBar"].concat(a.call(b),[function(a,b){a.events.onNumeratorChange.addListener(function(d){var e;e=parseInt(100*d/a.getDenominator(),10),e>100&&(e=100);return c(b).find(".bar").css("width",e+"%")}),a.events.onDenominatorChange.addListener(function(d){var e;e=parseInt(100*a.getNumerator()/d,10),e>100&&(e=100);return c(b).find(".bar").css("width",e+"%")}),a.show=function(){return c(b).show()};return a.hide=function(){return c(b).hide()}}]))}});return b.namespace("SequenceSelector",function(b){return b.initInstance=function(){var b,e;b=1<=arguments.length?a.call(arguments,0):[];return(e=d.Presentation).initInstance.apply(e,["SGA.Reader.Component.SequenceSelector"].concat(a.call(b),[function(a,b){var d;d=a.options,a.addLens("Sequence",function(a,b,d,e){var f,g,h,i;h={},g=d.getItem(e),f=c("<option></option>"),f.attr({value:e}),f.text((i=g.label)!=null?i[0]:void 0);return c(a).append(f)}),c(b).change(function(){return a.setSequence(c(b).val())});return a.finishDisplayUpdate=function(){return a.setSequence(c(b).val())}}]))}})});return e.namespace("Application",function(e){return e.namespace("SharedCanvas",function(f){f.initInstance=function(){var e,f;e=1<=arguments.length?a.call(arguments,0):[];return(f=d.Application).initInstance.apply(f,["SGA.Reader.Application.SharedCanvas"].concat(a.call(e),[function(a){var e,f,g,h,i;g=a.options,h=[],f=SGA.Reader.Data.Manifest.initInstance(),a.events.onItemsProcessedChange=f.events.onItemsProcessedChange,a.events.onItemsToProcessChange=f.events.onItemsToProcessChange,a.getItemsProcessed=f.getItemsProcessed,a.getItemsToProcess=f.getItemsToProcess,a.setItemsProcessed=f.setItemsProcessed,a.setItemsToProcess=f.setItemsToProcess,a.addItemsProcessed=f.addItemsProcessed,a.addItemsToProcess=f.addItemsToProcess,i=SGA.Reader.Data.TextStore.initInstance(),a.withSource=function(a,b){return i.withFile(a,b)},a.addPresentation=function(b){var c;c=SGA.Reader.Presentation.Canvas.initInstance(b.container,{types:b.types,application:function(){return a},dataView:a.dataView.canvasAnnotations});return h.push([c,b.container])},e=null,a.events.onSequenceChange.addListener(function(b){var c,d;e=b,d=a.dataStore.data.getItem(e),c=0,(d!=null?d.sequence:void 0)!=null&&(c=d.sequence.indexOf(a.getCanvas())),c<0&&(c=0);return a.setPosition(c)}),a.events.onPositionChange.addListener(function(b){var c,d,f;d=a.dataStore.data.getItem(e),c=(f=d.sequence)!=null?f[b]:void 0;return a.setCanvas(c)}),a.events.onCanvasChange.addListener(function(b){var c,d,f,g,i,j;a.dataView.canvasAnnotations.setKey(b),f=a.dataStore.data.getItem(e),c=f.sequence.indexOf(b),c>=0&&c!==a.getPosition()&&a.setPosition(c),j=[];for(g=0,i=h.length;g<i;g++)d=h[g],j.push(d[0].setCanvas(b));return j});if(g.url!=null)return f.importFromURL(g.url,function(){var e,g,h;g=[],h=d.initSynchronizer(function(){a.addItemsToProcess(1);return a.dataStore.data.loadItems(g,function(){return a.addItemsProcessed(1)})}),e=f.getCanvases(),a.addItemsToProcess(e.length),h.process(e,function(b){var c,d,e,h;a.addItemsProcessed(1),d=f.getItem(b),c={id:b,type:"Canvas",width:parseInt((e=d.exifwidth)!=null?e[0]:void 0,10),height:parseInt((h=d.exifheight)!=null?h[0]:void 0,10),label:d.dctitle||d.rdfslabel};return g.push(c)}),a.addItemsToProcess(f.getSequences().length),h.process(f.getSequences(),function(b){var c,d,e;a.addItemsProcessed(1),e=f.getItem(b),c={id:b,type:"Sequence",label:e.rdfslabel},d=[],d.push(e.rdffirst[0]),e=f.getItem(e.rdfrest[0]);while(e.id!=null)d.push(e.rdffirst[0]),e=f.getItem(e.rdfrest[0]);c.sequence=d;return g.push(c)}),a.addItemsToProcess(f.getAnnotations().length),h.process(f.getAnnotations(),function(d){var e,h,j,k,l,m,n,o,p,q,r,s;a.addItemsProcessed(1),e=f.getItem(d),b.call(e.type,"scContentAnnotation")>=0&&(j=f.getItem(e.oahasBody),c.isArray(j)&&(j=j[0]),k=f.getItem(j.oahasSelector),c.isArray(k)&&(k=k[0]),i.addFile(j.oahasSource),g.push({id:e.id,target:e.oahasTarget,type:"TextContent",source:j.oahasSource,start:parseInt((l=k.oaxbegin)!=null?l[0]:void 0,10),end:parseInt((m=k.oaxend)!=null?m[0]:void 0,10)})),b.call(e.type,"sgaLineAnnotation")>=0&&(j=f.getItem(e.oahasTarget),c.isArray(j)&&(j=j[0]),k=f.getItem(j.oahasSelector),c.isArray(k)&&(k=k[0]),g.push({id:e.id,target:j.oahasSource,start:parseInt((n=k.oaxbegin)!=null?n[0]:void 0,10),end:parseInt((o=k.oaxend)!=null?o[0]:void 0,10),type:"LineAnnotation"})),b.call(e.type,"sgaDeletionAnnotation")>=0&&(j=f.getItem(e.oahasTarget),c.isArray(j)&&(j=j[0]),k=f.getItem(j.oahasSelector),c.isArray(k)&&(k=k[0]),g.push({id:e.id,target:j.oahasSource,start:parseInt((p=k.oaxbegin)!=null?p[0]:void 0,10),end:parseInt((q=k.oaxend)!=null?q[0]:void 0,10),type:"DeletionAnnotation"})),b.call(e.type,"sgaAdditionAnnotation")>=0&&(j=f.getItem(e.oahasTarget),c.isArray(j)&&(j=j[0]),k=f.getItem(j.oahasSelector),c.isArray(k)&&(k=k[0]),g.push({id:e.id,target:j.oahasSource,start:parseInt((r=k.oaxbegin)!=null?r[0]:void 0,10),end:parseInt((s=k.oaxend)!=null?s[0]:void 0,10),type:"AdditionAnnotation"}));if(b.call(e.type,"scImageAnnotation")>=0){h=f.getItem(e.oahasBody),c.isArray(h)&&(h=h[0]);return g.push({id:e.id,target:e.oahasTarget,label:e.rdfslabel,image:h.oahasSource||e.oahasBody,type:"Image"})}});return h.done()})}]))};return f.builder=function(a){var b,d,f,g,h,i,j;d={manifests:{}},b={},f=function(){},g=function(){},a.progressTracker!=null&&(f=function(){var b,c,e,f,g;e=0,b=0,g=d.manifests;for(c in g)f=g[c],e+=f.getItemsProcessed(),b+=f.getItemsToProcess();a.progressTracker.setNumerator(e);return a.progressTracker.setDenominator(b||1)},h=null,i=1e3,g=function(){if(h!=null)return i=500;h=function(){var b,c,e;e=d.manifests;for(b in e){c=e[b];if(c.getItemsToProcess()>c.getItemsProcessed()){a.progressTracker.show(),i/=2,i<500&&(i=500),setTimeout(h,i);return}}i>500&&a.progressTracker.hide(),i*=2,i>1e4&&(i=1e4);return setTimeout(h,i)};return h()}),d.onManifest=function(a,c){var e;if(d.manifests[a]!=null)return d.manifests[a].ready(function(){return c(d.manifests[a])});(e=b[a])==null&&(b[a]=[]);return b[a].push(c)},d.addPresentation=function(a){var h,i,j,k;i=c(a).data("manifest");if(i!=null){h=d.manifests[i],h==null&&(h=e.SharedCanvas.initInstance({url:i}),d.manifests[i]=h,h.ready(function(){var a,c,d,e;c=b[i]||[];for(d=0,e=c.length;d<e;d++)a=c[d],a(h);return delete b[i]}),h.events.onItemsToProcessChange.addListener(f),h.events.onItemsProcessedChange.addListener(f),g()),h.run(),j=(k=c(a).data("types"))!=null?k.split(/\s*,\s*/):void 0;return d.onManifest(i,function(b){return b.addPresentation({types:j,container:c(a)})})}},(j=a["class"])==null&&(a["class"]=".canvas"),c(a["class"]).each(function(a,b){return d.addPresentation(b)});return d}})})})})(jQuery,MITHGrid),MITHGrid.defaults("SGA.Reader.Application.SharedCanvas",{dataStores:{data:{types:{Sequence:{},Canvas:{}},properties:{target:{valueType:"item"}}}},dataViews:{canvasAnnotations:{dataStore:"data",type:MITHGrid.Data.SubSet,expressions:["!target"]},sequences:{dataStore:"data",types:["Sequence"]}},variables:{Canvas:{is:"rw"},Sequence:{is:"rw"},Position:{is:"rw"}}}),MITHGrid.defaults("SGA.Reader.Component.SequenceSelector",{variables:{Sequence:{is:"rw"}}}),MITHGrid.defaults("SGA.Reader.Component.ProgressBar",{variables:{Numerator:{is:"rw","default":0},Denominator:{is:"rw","default":1}},viewSetup:'<div class="progress">\n  <div class="bar" style="width: 0%;"></div>\n</div>'}),MITHGrid.defaults("SGA.Reader.Presentation.Canvas",{variables:{Canvas:{is:"rw"},Scale:{is:"rw"}}}),MITHGrid.defaults("SGA.Reader.Data.Manifest",{variables:{ItemsToProcess:{is:"rw",isa:"numeric","default":0},ItemsProcessed:{is:"rw",isa:"numeric","default":0}}})}).call(this);