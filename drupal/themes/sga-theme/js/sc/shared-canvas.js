// Generated by CoffeeScript 1.6.3
/*
# SGA Shared Canvas v0.132980
#
# **SGA Shared Canvas** is a shared canvas reader written in CoffeeScript.
#
# Date: Fri Oct 25 10:34:14 2013 -0400
#
# (c) Copyright University of Maryland 2012-2013.  All rights reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
*/


(function() {
  var __slice = [].slice,
    __indexOf = [].indexOf || function(item) { for (var i = 0, l = this.length; i < l; i++) { if (i in this && this[i] === item) return i; } return -1; };

  (function($, MITHgrid) {
    MITHgrid.globalNamespace("SGA");
    return SGA.namespace("Reader", function(SGAReader) {
      SGAReader.namespace("Data", function(Data) {
        Data.namespace("StyleStore", function(StyleStore) {
          return StyleStore.initInstance = function() {
            var args;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            return MITHgrid.initInstance.apply(MITHgrid, __slice.call(args).concat([function(that) {
              var docs, options, regex;
              options = that.options;
              docs = {};
              regex = new RegExp("(?:\\.(\\S+)\\s*\\{\\s*([^}]*)\\s*\\})", "mg");
              that.addStyles = function(id, css) {
                var results, _results;
                if (docs[id] != null) {
                  return;
                }
                docs[id] = {};
                results = regex.exec(css);
                _results = [];
                while ((results != null ? results.index : void 0) != null) {
                  docs[id][results[1]] = results[2];
                  _results.push(results = regex.exec(css));
                }
                return _results;
              };
              return that.getStylesForClass = function(id, klass) {
                var _ref;
                if (((_ref = docs[id]) != null ? _ref[klass] : void 0) != null) {
                  return docs[id][klass];
                } else {
                  return "";
                }
              };
            }]));
          };
        });
        Data.namespace("TextStore", function(TextStore) {
          return TextStore.initInstance = function() {
            var args;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            return MITHgrid.initInstance.apply(MITHgrid, __slice.call(args).concat([function(that) {
              var fileContents, loadingFiles, options, pendingFiles;
              options = that.options;
              fileContents = {};
              loadingFiles = {};
              pendingFiles = {};
              that.addFile = function(files) {
                var file, _i, _len, _results;
                if (!$.isArray(files)) {
                  files = [files];
                }
                _results = [];
                for (_i = 0, _len = files.length; _i < _len; _i++) {
                  file = files[_i];
                  _results.push((function(file) {
                    if ((file != null) && (fileContents[file] == null) && (loadingFiles[file] == null)) {
                      loadingFiles[file] = [];
                      return $.ajax({
                        url: file,
                        type: 'GET',
                        processData: false,
                        success: function(data) {
                          var c, f, _j, _len1, _ref;
                          c = data.documentElement.textContent;
                          fileContents[file] = c;
                          _ref = loadingFiles[file];
                          for (_j = 0, _len1 = _ref.length; _j < _len1; _j++) {
                            f = _ref[_j];
                            f(c);
                          }
                          return delete loadingFiles[file];
                        }
                      });
                    }
                  })(file));
                }
                return _results;
              };
              return that.withFile = function(file, cb) {
                if (fileContents[file] != null) {
                  return cb(fileContents[file]);
                } else if (loadingFiles[file] != null) {
                  return loadingFiles[file].push(cb);
                } else {
                  that.addFile(file);
                  return loadingFiles[file].push(cb);
                }
              };
            }]));
          };
        });
        return Data.namespace("Manifest", function(Manifest) {
          var NS, types;
          NS = {
            "http://dms.stanford.edu/ns/": "sc",
            "http://www.shared-canvas.org/ns/": "sc",
            "http://www.w3.org/2000/01/rdf-schema#": "rdfs",
            "http://www.w3.org/1999/02/22-rdf-syntax-ns#": "rdf",
            "http://www.w3.org/2003/12/exif/ns#": "exif",
            "http://purl.org/dc/elements/1.1/": "dc",
            "http://www.w3.org/ns/openannotation/core/": "oa",
            "http://www.openannotation.org/ns/": "oa",
            "http://www.w3.org/ns/openannotation/extension/": "oax",
            "http://www.openarchives.org/ore/terms/": "ore",
            "http://www.shelleygodwinarchive.org/ns/1#": "sga",
            "http://www.shelleygodwinarchive.org/ns1#": "sga",
            "http://www.w3.org/2011/content#": "cnt",
            "http://purl.org/dc/dcmitype/": "dctypes"
          };
          types = {
            "http://www.w3.org/1999/02/22-rdf-syntax-ns#type": "item",
            "http://www.w3.org/ns/openannotation/core/hasMotivation": "item"
          };
          return Manifest.initInstance = function() {
            var args;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            return MITHgrid.initInstance.apply(MITHgrid, ["SGA.Reader.Data.Manifest"].concat(__slice.call(args), [function(that) {
              var data, flushSearchResults, getSearchResultCanvases, importFromURL, importer, itemsForCanvas, itemsWithType, loadedUrls, options;
              options = that.options;
              data = MITHgrid.Data.Store.initInstance();
              that.size = function() {
                return data.size();
              };
              importer = MITHgrid.Data.Importer.RDF_JSON.initInstance(data, NS, types);
              loadedUrls = [];
              importFromURL = function(url, cb) {
                if (__indexOf.call(loadedUrls, url) >= 0) {
                  cb();
                  return;
                }
                loadedUrls.push(url);
                that.addItemsToProcess(1);
                return $.ajax({
                  url: url,
                  type: 'GET',
                  contentType: 'application/rdf+json',
                  processData: false,
                  dataType: 'json',
                  success: function(data) {
                    that.addItemsProcessed(1);
                    return that.importJSON(data, cb);
                  },
                  error: function(e) {
                    that.addItemsProcessed(1);
                    throw new Error("Could not load the manifest");
                  }
                });
              };
              that.importJSON = function(json, cb) {
                var syncer;
                syncer = MITHgrid.initSynchronizer(cb);
                syncer.increment();
                importer["import"](json, function(ids) {
                  var idset, urls;
                  idset = MITHgrid.Data.Set.initInstance(ids);
                  urls = data.getObjectsUnion(idset, 'oreisDescribedBy');
                  urls.visit(function(url) {
                    syncer.increment();
                    return importFromURL(url, syncer.decrement);
                  });
                  return syncer.decrement();
                });
                return syncer.done();
              };
              itemsWithType = function(type) {
                if (!$.isArray(type)) {
                  type = [type];
                }
                types = MITHgrid.Data.Set.initInstance(type);
                return data.getSubjectsUnion(types, "type").items();
              };
              itemsForCanvas = function(canvas) {
                var annos, canvasSet, contentAnnotations, imageAnnotations, specificResources, specificResourcesAnnos, tei, teiURL;
                if (!$.isArray(canvas)) {
                  canvas = [canvas];
                }
                canvasSet = MITHgrid.Data.Set.initInstance(canvas);
                specificResources = data.getSubjectsUnion(canvasSet, "oahasSource");
                imageAnnotations = data.getSubjectsUnion(canvasSet, "oahasTarget");
                contentAnnotations = data.getSubjectsUnion(specificResources, "oahasTarget");
                tei = data.getObjectsUnion(contentAnnotations, 'oahasBody');
                teiURL = data.getObjectsUnion(tei, 'oahasSource');
                specificResourcesAnnos = data.getSubjectsUnion(teiURL, 'oahasSource');
                annos = data.getSubjectsUnion(specificResourcesAnnos, 'oahasTarget').items();
                return annos.concat(imageAnnotations.items(), contentAnnotations.items());
              };
              flushSearchResults = function() {
                var searchResults;
                types = MITHgrid.Data.Set.initInstance(['sgaSearchAnnotation']);
                searchResults = data.getSubjectsUnion(types, "type").items();
                return data.removeItems(searchResults);
              };
              getSearchResultCanvases = function() {
                var annos, canvasKeys, searchResults, sources, specificResources, step, teiURL;
                types = MITHgrid.Data.Set.initInstance(['sgaSearchAnnotation']);
                searchResults = data.getSubjectsUnion(types, "type");
                specificResources = data.getObjectsUnion(searchResults, "oahasTarget");
                teiURL = data.getObjectsUnion(specificResources, 'oahasSource');
                sources = data.getSubjectsUnion(teiURL, 'oahasSource');
                annos = data.getSubjectsUnion(sources, 'oahasBody');
                step = data.getObjectsUnion(annos, 'oahasTarget');
                canvasKeys = data.getObjectsUnion(step, 'oahasSource');
                return $.unique(canvasKeys.items());
              };
              that.getCanvases = function() {
                return itemsWithType('scCanvas');
              };
              that.getZones = function() {
                return itemsWithType('scZone');
              };
              that.getSequences = function() {
                return itemsWithType('scSequence');
              };
              that.getAnnotations = function() {
                return itemsWithType('oaAnnotation');
              };
              that.getRanges = function() {
                return itemsWithType('scRange');
              };
              that.getLayers = function() {
                return itemsWithType('scLayer');
              };
              that.getAnnotationsForCanvas = itemsForCanvas;
              that.flushSearchResults = flushSearchResults;
              that.getSearchResultCanvases = getSearchResultCanvases;
              that.getItem = data.getItem;
              that.contains = data.contains;
              return that.importFromURL = function(url, cb) {
                return importFromURL(url, function() {
                  if (cb != null) {
                    return cb();
                  }
                });
              };
            }]));
          };
        });
      });
      SGAReader.namespace("Presentation", function(Presentation) {
        Presentation.namespace("TextContent", function(TextContent) {
          return TextContent.initInstance = function() {
            var args, _ref;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            return (_ref = MITHgrid.Presentation).initInstance.apply(_ref, ["SGA.Reader.Presentation.TextContent"].concat(__slice.call(args), [function(that, container) {
              var additionLens, annoLens, currentLine, lenses, lineAlignments, lineIndents, lines, options, renderingTimer, scaleSettings;
              options = that.options;
              that.setHeight(0);
              that.events.onWidthChange.addListener(function(w) {
                return $(container).attr('width', w / 10);
              });
              if (options.width != null) {
                that.setWidth(options.width);
              }
              if (options.x != null) {
                that.setX(options.x);
              }
              if (options.y != null) {
                that.setY(options.y);
              }
              if (options.height != null) {
                that.setHeight(options.height);
              }
              if (options.scale != null) {
                that.setScale(options.scale);
              }
              if (options.inHTML) {
                that.events.onScaleChange.addListener(function(s) {
                  var r, _i, _len, _results;
                  _results = [];
                  for (_i = 0, _len = scaleSettings.length; _i < _len; _i++) {
                    r = scaleSettings[_i];
                    _results.push(r.setScale(s));
                  }
                  return _results;
                });
              }
              lines = {};
              lineAlignments = {};
              lineIndents = {};
              scaleSettings = [];
              currentLine = 0;
              that.startDisplayUpdate = function() {
                lines = {};
                return currentLine = 0;
              };
              that.finishDisplayUpdate = function() {
                var afterLayout, afterLayoutPos, currentLineEl, currentPos, i, lineNo, lineNoFraq, r, runAfterLayout, _fn, _i, _j, _len, _len1, _ref, _ref1;
                $(container).empty();
                afterLayout = [];
                _ref = ((function() {
                  var _results;
                  _results = [];
                  for (i in lines) {
                    _results.push(i);
                  }
                  return _results;
                })()).sort(function(a, b) {
                  return a - b;
                });
                for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                  lineNo = _ref[_i];
                  currentLineEl = $("<div></div>");
                  if (lineAlignments[lineNo] != null) {
                    currentLineEl.css({
                      'text-align': lineAlignments[lineNo]
                    });
                  }
                  if (lineIndents[lineNo] != null) {
                    currentLineEl.css;
                    currentLineEl.css({
                      'padding-left': (lineIndents[lineNo] * 4) + "em"
                    });
                  }
                  lineNoFraq = lineNo - parseInt(lineNo, 10);
                  if (lineNoFraq < 0) {
                    lineNoFraq += 1;
                  }
                  if (lineNoFraq > 0.5) {
                    currentLineEl.addClass('above-line');
                  } else if (lineNoFraq > 0) {
                    currentLineEl.addClass('below-line');
                  }
                  $(container).append(currentLineEl);
                  currentPos = 0;
                  afterLayoutPos = 0;
                  _ref1 = lines[lineNo];
                  _fn = function(r) {
                    if (r.setScale != null) {
                      scaleSettings.push(r);
                    }
                    if (r.$el != null) {
                      if (r.positioned) {
                        currentPos = r.charLead;
                        if (afterLayout[afterLayoutPos] != null) {
                          afterLayout[afterLayoutPos].push(r.afterLayout);
                        } else {
                          afterLayout[afterLayoutPos] = [r.afterLayout];
                        }
                      }
                      $(currentLineEl).append(r.$el);
                      r.$el.attr('data-pos', currentPos);
                      r.$el.attr('data-line', lineNo);
                      return currentPos += r.charWidth || 0;
                    }
                  };
                  for (_j = 0, _len1 = _ref1.length; _j < _len1; _j++) {
                    r = _ref1[_j];
                    _fn(r);
                  }
                }
                runAfterLayout = function(i) {
                  var fn, _k, _len2, _ref2;
                  if (i < afterLayout.length) {
                    _ref2 = afterLayout[i];
                    for (_k = 0, _len2 = _ref2.length; _k < _len2; _k++) {
                      fn = _ref2[_k];
                      fn();
                    }
                    return setTimeout((function() {
                      return runAfterLayout(i + 1);
                    }), 0);
                  }
                };
                setTimeout(function() {
                  return runAfterLayout(0);
                }, 0);
                return null;
              };
              renderingTimer = null;
              that.eventModelChange = function() {
                if (renderingTimer != null) {
                  clearTimeout(renderingTimer);
                }
                return renderingTimer = setTimeout(that.selfRender, 0);
              };
              annoLens = function(container, view, model, id) {
                var content, el, item, rendering;
                rendering = {};
                el = $("<span style='display: inline-block'></span>");
                rendering.$el = el;
                item = model.getItem(id);
                el.text(item.text[0]);
                el.addClass(item.type.join(" "));
                if ((item.css != null) && !/^\s*$/.test(item.css)) {
                  el.attr("style", item.css[0]);
                }
                content = item.text[0].replace(/\s+/g, " ");
                if (content === " ") {
                  rendering.charWidth = 0;
                } else {
                  rendering.charWidth = content.length;
                }
                if (rendering.charWidth === 0) {
                  return null;
                }
                if (lines[currentLine] == null) {
                  lines[currentLine] = [];
                }
                lines[currentLine].push(rendering);
                rendering.line = currentLine;
                rendering.positioned = false;
                rendering.setScale = function() {};
                rendering.afterLayout = function() {};
                rendering.remove = function() {
                  var r;
                  el.remove();
                  return lines[rendering.line] = (function() {
                    var _i, _len, _ref, _results;
                    _ref = lines[rendering.line];
                    _results = [];
                    for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                      r = _ref[_i];
                      if (r !== rendering) {
                        _results.push(r);
                      }
                    }
                    return _results;
                  })();
                };
                rendering.update = function(item) {
                  return el.text(item.text[0]);
                };
                return rendering;
              };
              additionLens = function(container, view, model, id) {
                var content, el, item, lastRendering, ourLineNo, rendering, _ref, _ref1, _ref2;
                rendering = {};
                el = $("<span style='display: inline-block'></span>");
                rendering.$el = el;
                item = model.getItem(id);
                el.text(item.text[0]);
                el.addClass(item.type.join(" "));
                if ((item.css != null) && /vertical-align: sub;/.test(item.css[0])) {
                  ourLineNo = currentLine + 0.3;
                } else if ((item.css != null) && /vertical-align: super;/.test(item.css[0])) {
                  ourLineNo = currentLine - 0.3;
                } else {
                  ourLineNo = currentLine;
                }
                if (lines[ourLineNo] == null) {
                  lines[ourLineNo] = [];
                }
                lines[ourLineNo].push(rendering);
                lastRendering = (_ref = lines[currentLine]) != null ? _ref[((_ref1 = lines[currentLine]) != null ? _ref1.length : void 0) - 1] : void 0;
                rendering.positioned = currentLine !== ourLineNo && ((_ref2 = lines[currentLine]) != null ? _ref2.length : void 0) > 0;
                content = item.text[0].replace(/\s+/g, " ");
                if (content === " ") {
                  rendering.charWidth = 0;
                } else {
                  rendering.charWidth = content.length;
                }
                rendering.line = ourLineNo;
                rendering.setScale = function() {};
                rendering.afterLayout = function() {
                  var accOffset, availableSpace, middle, myMiddle, myOffset, neededSpace, ourLeft, ourWidth, prevOffset, prevSibling, prevSiblings, spacing, usedSpace;
                  ourWidth = that.getWidth() / 10;
                  ourLeft = rendering.$el.parent().offset().left;
                  if (lastRendering != null) {
                    myOffset = rendering.$el.offset();
                    if (lastRendering.$el.hasClass('DeletionAnnotation')) {
                      middle = lastRendering.$el.offset().left + lastRendering.$el.outerWidth() / 2;
                    } else {
                      middle = lastRendering.$el.offset().left + lastRendering.$el.outerWidth();
                    }
                    myMiddle = myOffset.left + rendering.$el.outerWidth() / 2;
                    neededSpace = middle - myMiddle;
                    prevSibling = rendering.$el.prev();
                    accOffset = 0;
                    spacing = 0;
                    if ((prevSibling != null) && prevSibling.size() > 0) {
                      prevOffset = prevSibling.offset();
                      accOffset = prevSibling.offset().left + prevSibling.outerWidth() - ourLeft;
                      spacing = (prevOffset.left + prevSibling.outerWidth()) - myOffset.left;
                      spacing = parseInt(prevSibling.css('left'), 10) || 0;
                      if (spacing > neededSpace) {
                        neededSpace = spacing;
                      }
                    }
                    if (neededSpace >= 0) {
                      if (neededSpace + (myOffset.left - ourLeft) + accOffset + rendering.$el.outerWidth() > ourWidth) {
                        neededSpace = ourWidth - (myOffset.left - ourLeft) - accOffset - rendering.$el.outerWidth();
                      }
                    }
                    if (neededSpace < 0) {
                      if ((prevSibling == null) || prevSibling.size() <= 0) {
                        neededSpace = 0;
                      } else {
                        neededSpace = -neededSpace;
                        prevSiblings = rendering.$el.prevAll();
                        availableSpace = 0;
                        prevSiblings.each(function(i, x) {
                          return availableSpace += parseInt($(x).css('left'), 10) || 0;
                        });
                        if (prevSibling.size() > 0) {
                          availableSpace -= prevSibling.offset().left - ourLeft + prevSibling.outerWidth();
                        }
                        if (availableSpace > neededSpace) {
                          usedSpace = 0;
                          prevSiblings.each(function(i, s) {
                            var oldLeft, useWidth;
                            oldLeft = parseInt($(s).css('left'), 10) || 0;
                            if (availableSpace > 0) {
                              useWidth = parseInt(oldLeft * (neededSpace - usedSpace) / availableSpace, 10);
                              $(s).css('left', (oldLeft - useWidth - usedSpace) + "px");
                              usedSpace += useWidth;
                              return availableSpace -= oldLeft;
                            }
                          });
                          neededSpace = -neededSpace;
                        } else {
                          prevSiblings.each(function(i, s) {
                            return $(s).css('left', "0px");
                          });
                          neededSpace = 0;
                        }
                      }
                    }
                    if (neededSpace > 0) {
                      if (prevSibling.size() > 0) {
                        if (neededSpace < parseInt(prevSibling.css('left'), 10)) {
                          neededSpace = parseInt(prevSibling.css('left'), 10);
                        }
                      }
                      rendering.$el.css({
                        'position': 'relative',
                        'left': neededSpace + "px"
                      });
                      rendering.left = neededSpace / that.getScale();
                      return rendering.setScale = function(s) {
                        return rendering.$el.css({
                          'left': parseInt(rendering.left * s, 10) + "px"
                        });
                      };
                    }
                  }
                };
                rendering.remove = function() {
                  var r;
                  el.remove();
                  return lines[rendering.line] = (function() {
                    var _i, _len, _ref3, _results;
                    _ref3 = lines[rendering.line];
                    _results = [];
                    for (_i = 0, _len = _ref3.length; _i < _len; _i++) {
                      r = _ref3[_i];
                      if (r !== rendering) {
                        _results.push(r);
                      }
                    }
                    return _results;
                  })();
                };
                rendering.update = function(item) {
                  return el.text(item.text[0]);
                };
                return rendering;
              };
              lenses = {};
              that.addLens = function(key, lens) {
                return lenses[key] = lens;
              };
              that.getLens = function(id) {
                var item, t, types, _i, _j, _len, _len1, _ref;
                item = that.dataView.getItem(id);
                types = [];
                _ref = item.type;
                for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                  t = _ref[_i];
                  if ($.isArray(t)) {
                    types = types.concat(t);
                  } else {
                    types.push(t);
                  }
                }
                if (__indexOf.call(types, 'AdditionAnnotation') >= 0) {
                  return {
                    render: lenses['AdditionAnnotation']
                  };
                }
                for (_j = 0, _len1 = types.length; _j < _len1; _j++) {
                  t = types[_j];
                  if (t !== 'LineAnnotation' && (lenses[t] != null)) {
                    return {
                      render: lenses[t]
                    };
                  }
                }
                return {
                  render: lenses['LineAnnotation']
                };
              };
              that.hasLens = function(k) {
                return lenses[k] != null;
              };
              that.addLens('AdditionAnnotation', additionLens);
              that.addLens('DeletionAnnotation', annoLens);
              that.addLens('SearchAnnotation', annoLens);
              that.addLens('LineAnnotation', annoLens);
              that.addLens('Text', function() {});
              return that.addLens('LineBreak', function(container, view, model, id) {
                var item, _ref, _ref1;
                currentLine += 1;
                item = model.getItem(id);
                if (((_ref = item.sgatextAlignment) != null ? _ref.length : void 0) > 0) {
                  lineAlignments[currentLine] = item.sgatextAlignment[0];
                }
                if (((_ref1 = item.sgatextIndentLevel) != null ? _ref1.length : void 0) > 0) {
                  lineIndents[currentLine] = parseInt(item.sgatextIndentLevel[0], 10) || 0;
                }
                return null;
              });
            }]));
          };
        });
        Presentation.namespace("Zone", function(Zone) {
          return Zone.initInstance = function() {
            var args, _ref;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            return (_ref = MITHgrid.Presentation).initInstance.apply(_ref, ["SGA.Reader.Presentation.Zone"].concat(__slice.call(args), [function(that, container) {
              var annoExpr, app, options, recalculateHeight, svgRoot;
              options = that.options;
              svgRoot = options.svgRoot;
              app = that.options.application();
              that.setHeight(options.height);
              that.setWidth(options.width);
              that.setX(options.x);
              that.setY(options.y);
              that.setScale(options.scale);
              recalculateHeight = function(h) {};
              annoExpr = that.dataView.prepare(['!target']);
              that.addLens('Image', function(container, view, model, id) {
                var height, item, renderImage, rendering, svg, svgImage, vb, y;
                if (__indexOf.call(options.types || [], 'Image') < 0) {
                  return;
                }
                rendering = {};
                item = model.getItem(id);
                svg = $(svgRoot.root());
                vb = svg.get(0).getAttribute("viewBox");
                if (vb == null) {
                  svgRoot.configure({
                    viewBox: "0 0 " + options.width + " " + options.height
                  });
                }
                svgImage = null;
                height = 0;
                y = 0;
                renderImage = function(item) {
                  var width, x, _ref, _ref1, _ref2, _ref3, _ref4, _ref5;
                  if ((((_ref = item.image) != null ? _ref[0] : void 0) != null) && (svgRoot != null)) {
                    x = ((_ref1 = item.x) != null ? _ref1[0] : void 0) != null ? item.x[0] : 0;
                    y = ((_ref2 = item.y) != null ? _ref2[0] : void 0) != null ? item.y[0] : 0;
                    width = ((_ref3 = item.width) != null ? _ref3[0] : void 0) != null ? item.width[0] : options.width - x;
                    height = ((_ref4 = item.height) != null ? _ref4[0] : void 0) != null ? item.height[0] : options.height - y;
                    if (svgImage != null) {
                      svgRoot.remove(svgImage);
                    }
                    return svgImage = svgRoot.image(container, x / 10, y / 10, width / 10, height / 10, (_ref5 = item.image) != null ? _ref5[0] : void 0, {
                      preserveAspectRatio: 'none'
                    });
                  }
                };
                renderImage(item);
                rendering.getHeight = function() {
                  return height / 10;
                };
                rendering.getY = function() {
                  return y / 10;
                };
                rendering.update = renderImage;
                rendering.remove = function() {
                  if ((svgImage != null) && (svgRoot != null)) {
                    return svgRoot.remove(svgImage);
                  }
                };
                return rendering;
              });
              that.addLens('ImageViewer2', function(container, view, model, id) {
                var baseURL, item, rendering, tempBaseURL;
                if (__indexOf.call(options.types || [], 'Image') < 0) {
                  return;
                }
                rendering = {};
                item = model.getItem(id);
                app.imageControls.setActive(true);
                baseURL = item.url[0];
                tempBaseURL = baseURL.replace(/http:\/\/tiles2\.bodleian\.ox\.ac\.uk:8080\//, 'http://dev.shelleygodwinarchive.org/');
                console.log(baseURL, tempBaseURL, $(container));
                rendering.update = function(item) {};
                rendering.getZoom = function() {};
                rendering.setZoom = function(z) {};
                rendering.getX = function() {};
                rendering.setX = function(x) {};
                rendering.getY = function() {};
                rendering.setY = function(y) {};
                $.ajax({
                  url: tempBaseURL + "&svc_id=info:lanl-repo/svc/getMetadata",
                  success: function(metadata) {
                    var divHeight, divWidth, imageURL, originalHeight, originalWidth, xTiles, yTiles, zoomForFull, zoomLevels;
                    originalWidth = parseInt(metadata.width, 10) || 1;
                    originalHeight = parseInt(metadata.height, 10) || 1;
                    zoomLevels = parseInt(metadata.levels, 10);
                    divWidth = $(svgRoot.root()).parent().width() || 1;
                    divHeight = $(svgRoot.root()).parent().height() || 1;
                    zoomForFull = zoomLevels - Math.floor((Math.log(originalWidth) - Math.log(divWidth)) / Math.log(2.0));
                    xTiles = Math.ceil(divWidth / 256);
                    yTiles = Math.ceil(divHeight / 256);
                    console.log({
                      imageWidth: originalWidth,
                      imageHeight: originalHeight,
                      zoomLevels: zoomLevels,
                      divWidth: divWidth,
                      divHeight: divHeight,
                      originalZoom: zoomForFull,
                      xTiles: xTiles,
                      yTiles: yTiles,
                      tileWidth: Math.pow(2.0, zoomForFull) * 256
                    });
                    imageURL = function(x, y, z) {
                      var tileWidth, xx, yy;
                      tileWidth = Math.pow(2.0, zoomForFull) * 256;
                      xx = x * tileWidth;
                      yy = y * tileWidth;
                      return baseURL + ("&svc_id=info:lanl-repo/svc/getRegion&svc_val_fmt=info:ofi/fmt:kev:mtx:jpeg2000&svc.format=image/jpeg&svc.level=" + z + "&svc.region=" + yy + "," + xx + ",256,256");
                    };
                    console.log(imageURL(0, 0, zoomForFull));
                    return console.log(imageURL(1, 0, zoomForFull));
                  }
                });
                return rendering;
              });
              that.addLens('ImageViewer', function(container, view, model, id) {
                var baseURL, browserZoomLevel, canvas, g, item, map, po, rendering, svg, tempBaseURL, toAdoratio;
                if (__indexOf.call(options.types || [], 'Image') < 0) {
                  return;
                }
                rendering = {};
                browserZoomLevel = parseInt(document.width / document.body.clientWidth * 100 - 100, 10);
                if (__indexOf.call(window, 'webkitRequestAnimationFrame') >= 0 && browserZoomLevel !== 0) {
                  if (!$("#zoom-warning").size()) {
                    $(container).parent().prepend("<p id='zoom-warning'></p>");
                  }
                  if (browserZoomLevel > 0) {
                    $("#zoom-warning").text("Zooming in using your browser's controls will distort the facsimile image.");
                  } else {
                    $("#zoom-warning").text("Zooming out using your browser's controls will distort the facsimile image.");
                  }
                } else {
                  $("#zoom-warning").remove();
                }
                item = model.getItem(id);
                app.imageControls.setActive(true);
                baseURL = item.url[0];
                po = org.polymaps;
                svg = $(svgRoot.root());
                svg.get(0).removeAttribute("viewBox");
                g = svgRoot.group();
                tempBaseURL = baseURL.replace(/http:\/\/tiles2\.bodleian\.ox\.ac\.uk:8080\//, 'http://dev.shelleygodwinarchive.org/');
                map = po.map().container(g);
                canvas = $(container).parent().get(0);
                toAdoratio = $.ajax({
                  datatype: "json",
                  url: tempBaseURL + '&svc_id=info:lanl-repo/svc/getMetadata',
                  success: adoratio(canvas, baseURL, map)
                });
                toAdoratio.then(function() {
                  var fromZoomControls, startCenter;
                  fromZoomControls = false;
                  startCenter = map.center();
                  app.imageControls.events.onZoomChange.addListener(function(z) {
                    map.zoom(z);
                    app.imageControls.setImgPosition(map.position);
                    return fromZoomControls = true;
                  });
                  app.imageControls.events.onImgPositionChange.addListener(function(p) {
                    if (p.topLeft.x === 0 && p.topLeft.y === 0) {
                      return map.center(startCenter);
                    }
                  });
                  app.imageControls.setZoom(map.zoom());
                  app.imageControls.setMaxZoom(map.zoomRange()[1]);
                  app.imageControls.setMinZoom(map.zoomRange()[0]);
                  app.imageControls.setImgPosition(map.position);
                  map.on('zoom', function() {
                    if (!fromZoomControls) {
                      app.imageControls.setZoom(map.zoom());
                      app.imageControls.setImgPosition(map.position);
                      app.imageControls.setMaxZoom(map.zoomRange()[1]);
                    }
                    return fromZoomControls = false;
                  });
                  return map.on('drag', function() {
                    return app.imageControls.setImgPosition(map.position);
                  });
                });
                rendering.getHeight = function() {
                  return options.height / 10;
                };
                rendering.getY = function() {
                  return options.y / 10;
                };
                MITHgrid.events.onWindowResize.addListener(function() {
                  return map.resize();
                });
                rendering.update = function(item) {
                  return 0;
                };
                rendering.remove = function() {
                  app.imageControls.setActive(false);
                  app.imageControls.setZoom(0);
                  app.imageControls.setMaxZoom(0);
                  app.imageControls.setMinZoom(0);
                  app.imageControls.setImgPosition({
                    topLeft: {
                      x: 0,
                      y: 0
                    },
                    bottomRight: {
                      x: 0,
                      y: 0
                    }
                  });
                  return $(svgRoot.root()).find('#map').remove();
                };
                return rendering;
              });
              that.addLens('ZoneAnnotation', function(container, view, model, id) {
                var height, rendering, width, x, y, zone, zoneContainer, zoneDataView, zoneInfo, _ref, _ref1, _ref2, _ref3;
                rendering = {};
                zoneInfo = model.getItem(id);
                zoneContainer = null;
                zoneContainer = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                container.appendChild(zoneContainer);
                x = ((_ref = item.x) != null ? _ref[0] : void 0) != null ? item.x[0] : 0;
                y = ((_ref1 = item.y) != null ? _ref1[0] : void 0) != null ? item.y[0] : 0;
                width = ((_ref2 = item.width) != null ? _ref2[0] : void 0) != null ? item.width[0] : options.width - x;
                height = ((_ref3 = item.height) != null ? _ref3[0] : void 0) != null ? item.height[0] : options.height - y;
                zoneDataView = MITHgrid.Data.SubSet.initInstance({
                  dataStore: model,
                  expressions: ['!target']
                });
                zone = Zone.initInstance(zoneContainer, {
                  types: options.types,
                  dataView: zoneDataView,
                  svgRoot: svgRoot,
                  application: options.application,
                  heigth: height,
                  width: width
                });
                zoneDataView.setKey(id);
                zone.events.onHeightChange.addListener(function(h) {
                  return $(zoneContainer).attr('height', h / 10);
                });
                zone.events.onWidthChange.addListener(function(w) {
                  return $(zoneContainer).attr('width', w / 10);
                });
                zone.events.onXChange.addListener(function(x) {
                  return $(zoneContainer).attr('x', x / 10);
                });
                zone.events.onYChange.addListener(function(y) {
                  return $(zoneContainer).attr('y', y / 10);
                });
                zone.setX(x);
                zone.setY(y);
                zone.setHeight(height);
                zone.setWidth(width);
                zone.events.onHeightChange.addListener(recalculateHeight);
                rendering.getHeight = zone.getHeight;
                rendering.getY = zone.getY;
                rendering._destroy = function() {
                  if (zone._destroy != null) {
                    zone._destroy();
                  }
                  if (zoneDataView._destroy != null) {
                    return zoneDataView._destroy();
                  }
                };
                rendering.remove = function() {
                  zone.setHeight(0);
                  $(zoneContainer).hide();
                  return rendering._destroy();
                };
                rendering.update = function(item) {
                  var _ref4, _ref5, _ref6, _ref7;
                  x = ((_ref4 = item.x) != null ? _ref4[0] : void 0) != null ? item.x[0] : 0;
                  y = ((_ref5 = item.y) != null ? _ref5[0] : void 0) != null ? item.y[0] : 0;
                  width = ((_ref6 = item.width) != null ? _ref6[0] : void 0) != null ? item.width[0] : options.width - x;
                  height = ((_ref7 = item.height) != null ? _ref7[0] : void 0) != null ? item.height[0] : options.height - y;
                  if (height < zone.getHeight()) {
                    height = zone.getHeight();
                  }
                  that.setX(x);
                  that.setY(y);
                  that.setWidth(width);
                  return that.setHeight(height);
                };
                return rendering;
              });
              that.addLens('ContentAnnotation', function(container, view, model, id) {
                var bodyEl, height, item, overflowDiv, rendering, rootEl, textContainer, width, x, y, _ref, _ref1, _ref2, _ref3;
                if (__indexOf.call(options.types || [], 'Text') < 0) {
                  return;
                }
                rendering = {};
                item = model.getItem(id);
                textContainer = document.createElementNS('http://www.w3.org/2000/svg', 'foreignObject');
                x = ((_ref = item.x) != null ? _ref[0] : void 0) != null ? item.x[0] : 0;
                y = ((_ref1 = item.y) != null ? _ref1[0] : void 0) != null ? item.y[0] : 0;
                width = ((_ref2 = item.width) != null ? _ref2[0] : void 0) != null ? item.width[0] : options.width - x;
                height = ((_ref3 = item.height) != null ? _ref3[0] : void 0) != null ? item.height[0] : options.height - y;
                $(textContainer).attr("x", x / 10).attr("y", y / 10).attr("width", width / 10).attr("height", height / 10);
                container.appendChild(textContainer);
                bodyEl = document.createElementNS('http://www.w3.org/1999/xhtml', 'body');
                $(bodyEl).attr('xmlns', "http://www.w3.org/1999/xhtml");
                overflowDiv = document.createElement('div');
                bodyEl.appendChild(overflowDiv);
                rootEl = document.createElement('div');
                $(rootEl).addClass("text-content");
                $(overflowDiv).css({
                  'overflow': 'auto',
                  'height': height / 10,
                  'width': width / 10
                });
                overflowDiv.appendChild(rootEl);
                rootEl.text(item.text[0]);
                rendering.getHeight = function() {
                  return $(textContainer).height() * 10;
                };
                rendering.getY = function() {
                  return $(textContainer).position().top * 10;
                };
                rendering.update = function(item) {
                  return rootEl.text(item.text[0]);
                };
                rendering.remove = function() {
                  return rootEl.remove();
                };
                return rendering;
              });
              return that.addLens('TextContentZone', function(container, view, model, id) {
                var bodyEl, height, item, marquee, overflowDiv, rendering, rootEl, scale, strokeW, svg, text, textContainer, textDataView, updateMarque, vb, visiblePerc, width, x, y, zoom, _ref, _ref1, _ref2, _ref3;
                if (__indexOf.call(options.types || [], 'Text') < 0) {
                  return;
                }
                svg = $(svgRoot.root());
                vb = svg.get(0).getAttribute("viewBox");
                if (vb == null) {
                  svgRoot.configure({
                    viewBox: "0 0 " + options.width + " " + options.height
                  });
                }
                rendering = {};
                app = options.application();
                zoom = app.imageControls.getZoom();
                item = model.getItem(id);
                textContainer = null;
                textContainer = document.createElementNS('http://www.w3.org/2000/svg', 'foreignObject');
                textContainer.style.overflow = 'auto';
                container.appendChild(textContainer);
                bodyEl = document.createElementNS('http://www.w3.org/1999/xhtml', 'body');
                $(bodyEl).attr('xmlns', "http://www.w3.org/1999/xhtml");
                overflowDiv = document.createElement('div');
                $(overflowDiv).css('overflow', 'auto');
                bodyEl.appendChild(overflowDiv);
                rootEl = document.createElement('div');
                $(rootEl).addClass("text-content");
                $(rootEl).attr("id", id);
                $(rootEl).css({
                  "white-space": "nowrap",
                  "overflow": "auto"
                });
                overflowDiv.appendChild(rootEl);
                textContainer.appendChild(bodyEl);
                textDataView = MITHgrid.Data.SubSet.initInstance({
                  dataStore: model,
                  expressions: ['!target']
                });
                x = ((_ref = item.x) != null ? _ref[0] : void 0) != null ? item.x[0] : 0;
                y = ((_ref1 = item.y) != null ? _ref1[0] : void 0) != null ? item.y[0] : 0;
                width = ((_ref2 = item.width) != null ? _ref2[0] : void 0) != null ? item.width[0] : options.width - x;
                height = ((_ref3 = item.height) != null ? _ref3[0] : void 0) != null ? item.height[0] : options.height - y;
                $(textContainer).attr("x", x / 10).attr("y", y / 10).attr("width", width / 10).attr("height", height / 10);
                $(rootEl).css('width', width / 10);
                $(overflowDiv).css({
                  'width': width / 10,
                  'height': height / 10
                });
                text = Presentation.TextContent.initInstance(rootEl, {
                  types: options.types,
                  dataView: textDataView,
                  svgRoot: svgRoot,
                  application: options.application,
                  height: height,
                  width: width,
                  x: x,
                  y: y,
                  scale: that.getScale()
                });
                textDataView.setKey(id);
                updateMarque = function(z) {};
                if (app.imageControls.getActive()) {
                  $('.marquee').remove();
                  strokeW = 1;
                  marquee = svgRoot.rect(0, 0, Math.max(1, that.getWidth() / 10), Math.max(1, that.getHeight() / 10), {
                    "class": 'marquee',
                    fill: 'yellow',
                    stroke: 'navy',
                    strokeWidth: strokeW,
                    fillOpacity: '0.05',
                    strokeOpacity: '0.9'
                  });
                  scale = that.getWidth() / 10 / $(container).width();
                  visiblePerc = 100;
                  updateMarque = function(z) {
                    if (app.imageControls.getMaxZoom() > 0) {
                      width = Math.round(that.getWidth() / Math.pow(2, app.imageControls.getMaxZoom() - z));
                      visiblePerc = Math.min(100, ($(container).width() * 100) / width);
                      marquee.setAttribute("width", (that.getWidth() / 10 * visiblePerc) / 100);
                      marquee.setAttribute("height", (that.getHeight() / 10 * visiblePerc) / 100);
                      if (app.imageControls.getZoom() > app.imageControls.getMaxZoom() - 1) {
                        return $(marquee).attr("opacity", "0");
                      } else {
                        return $(marquee).attr("opacity", "100");
                      }
                    }
                  };
                  that.onDestroy(app.imageControls.events.onZoomChange.addListener(updateMarque));
                  that.onDestroy(app.imageControls.events.onImgPositionChange.addListener(function(p) {
                    marquee.setAttribute("x", ((-p.topLeft.x * visiblePerc) / 100) * scale);
                    return marquee.setAttribute("y", ((-p.topLeft.y * visiblePerc) / 100) * scale);
                  }));
                }
                /*
                that.onDestroy text.events.onHeightChange.addListener (h) ->
                  #$(textContainer).attr("height", h/10)
                  #$(overflowDiv).attr("height", h/10)
                  #recalculateHeight()
                  #setTimeout (-> updateMarque app.imageControls.getZoom()), 0
                */

                rendering.getHeight = text.getHeight;
                rendering.getY = text.getY;
                rendering._destroy = function() {
                  if (text._destroy != null) {
                    text._destroy();
                  }
                  if (textDataView._destroy != null) {
                    return textDataView._destroy();
                  }
                };
                rendering.remove = function() {
                  $(textContainer).empty();
                  return svgRoot.remove(textContainer);
                };
                rendering.update = function(item) {
                  var _ref4, _ref5, _ref6, _ref7;
                  x = ((_ref4 = item.x) != null ? _ref4[0] : void 0) != null ? item.x[0] : 0;
                  y = ((_ref5 = item.y) != null ? _ref5[0] : void 0) != null ? item.y[0] : 0;
                  width = ((_ref6 = item.width) != null ? _ref6[0] : void 0) != null ? item.width[0] : options.width - x;
                  height = ((_ref7 = item.height) != null ? _ref7[0] : void 0) != null ? item.height[0] : options.height - y;
                  that.setHeight(height);
                  return $(textContainer).attr("x", x / 10).attr("y", y / 10).attr("width", width / 10);
                };
                return rendering;
              });
            }]));
          };
        });
        Presentation.namespace("TextZone", function(Zone) {
          return Zone.initInstance = function() {
            var args, _ref;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            return (_ref = MITHgrid.Presentation).initInstance.apply(_ref, ["SGA.Reader.Presentation.TextZone"].concat(__slice.call(args), [function(that, container) {
              var annoExpr, app, marquee, marqueeHeight, marqueeLeft, marqueeTop, marqueeWidth, options, strokeW, svgRoot, updateMarque, visiblePerc, _ref;
              options = that.options;
              svgRoot = options.svgRoot;
              app = that.options.application();
              that.setHeight(options.height);
              that.setWidth(options.width);
              that.setX(options.x);
              that.setY(options.y);
              that.setScale(options.scale);
              updateMarque = function(z) {};
              app = that.options.application();
              if ((_ref = app.imageControls) != null ? _ref.getActive() : void 0) {
                $('.marquee').remove();
                strokeW = 1;
                marquee = $("<div class='marquee'></div>");
                $(container).append(marquee);
                marquee.css({
                  "border-color": 'navy',
                  "background-color": "yellow",
                  "border-width": strokeW,
                  "opacity": "0.1",
                  "border-opacity": "0.9",
                  "width": options.width * options.scale,
                  "height": options.height * options.scale,
                  "position": "absolute",
                  "z-index": 0,
                  "top": 0,
                  "left": 16
                });
                visiblePerc = 100;
                marqueeLeft = 0;
                marqueeTop = 0;
                marqueeWidth = parseInt((that.getWidth() * visiblePerc * that.getScale()) / 100, 10);
                marqueeHeight = parseInt((that.getHeight() * visiblePerc * that.getScale()) / 100, 10);
                updateMarque = function(z) {
                  var width;
                  if (app.imageControls.getMaxZoom() > 0) {
                    width = Math.round(that.getWidth() / Math.pow(2, app.imageControls.getMaxZoom() - z));
                    visiblePerc = Math.min(100, ($(container).width() * 100) / width);
                    marqueeWidth = parseInt((that.getWidth() * visiblePerc * that.getScale()) / 100, 10);
                    marqueeHeight = parseInt((that.getHeight() * visiblePerc * that.getScale()) / 100, 10);
                    marquee.css({
                      "width": marqueeLeft < 0 ? marqueeWidth + marqueeLeft : marqueeWidth + marqueeLeft > $(container).width() ? $(container).width() - marqueeLeft : marqueeWidth,
                      "height": marqueeTop < 0 ? marqueeHeight + marqueeTop : marqueeHeight + marqueeTop > $(container).height() ? $(container).height() - marqueeTop : marqueeHeight
                    });
                    if (app.imageControls.getZoom() > app.imageControls.getMaxZoom() - 1) {
                      return $(marquee).css("opacity", "0");
                    } else {
                      return $(marquee).css("opacity", "0.1");
                    }
                  }
                };
                that.onDestroy(app.imageControls.events.onZoomChange.addListener(updateMarque));
                that.onDestroy(app.imageControls.events.onImgPositionChange.addListener(function(p) {
                  marqueeLeft = parseInt((-p.topLeft.x * visiblePerc / 10) * that.getScale(), 10);
                  marqueeTop = parseInt((-p.topLeft.y * visiblePerc / 10) * that.getScale(), 10);
                  return marquee.css({
                    "left": 16 + Math.max(0, marqueeLeft),
                    "top": Math.max(0, marqueeTop),
                    "width": marqueeLeft < 0 ? marqueeWidth + marqueeLeft : marqueeWidth + marqueeLeft > $(container).width() ? $(container).width() - marqueeLeft : marqueeWidth,
                    "height": marqueeTop < 0 ? marqueeHeight + marqueeTop : marqueeHeight + marqueeTop > $(container).height() ? $(container).height() - marqueeTop : marqueeHeight
                  });
                }));
              }
              that.events.onScaleChange.addListener(function(s) {
                updateMarque(app.imageControls.getZoom());
                return that.visitRenderings(function(id, r) {
                  if (typeof r.setScale === "function") {
                    r.setScale(s);
                  }
                  return true;
                });
              });
              annoExpr = that.dataView.prepare(['!target']);
              that.addLens('ContentAnnotation', function(innerContainer, view, model, id) {
                var height, item, overflowDiv, rendering, rootEl, textContainer, width, x, y, _ref1, _ref2, _ref3, _ref4;
                rendering = {};
                item = model.getItem(id);
                textContainer = $("<div></div>");
                x = ((_ref1 = item.x) != null ? _ref1[0] : void 0) != null ? item.x[0] : 0;
                y = ((_ref2 = item.y) != null ? _ref2[0] : void 0) != null ? item.y[0] : 0;
                width = ((_ref3 = item.width) != null ? _ref3[0] : void 0) != null ? item.width[0] : options.width - x;
                height = ((_ref4 = item.height) != null ? _ref4[0] : void 0) != null ? item.height[0] : options.height - y;
                $(textContainer).css({
                  "position": "absolute",
                  "left": parseInt(16 + x * that.getScale(), 10) + "px",
                  "top": parseInt(y * that.getScale(), 10) + "px",
                  "width": parseInt(width * that.getScale(), 10) + "px",
                  "height": parseInt(height * that.getScale(), 10) + "px"
                });
                container.append(textContainer);
                overflowDiv = $("<div></div>");
                container.append(overflowDiv);
                rootEl = $("<div></div>");
                $(rootEl).addClass("text-content");
                $(overflowDiv).css({
                  'overflow': 'auto',
                  'height': parseInt(height * that.getScale(), 10) + "px",
                  'width': parseInt(width * that.getScale(), 10) + "px"
                });
                overflowDiv.append(rootEl);
                rootEl.text(item.text[0]);
                rendering.getHeight = function() {
                  return $(textContainer).height() * 10;
                };
                rendering.getY = function() {
                  return $(textContainer).position().top * 10;
                };
                rendering.update = function(item) {
                  return rootEl.text(item.text[0]);
                };
                rendering.remove = function() {
                  return rootEl.remove();
                };
                rendering.setScale = function(s) {
                  $(textContainer).css({
                    "left": parseInt(16 + x * s, 10) + "px",
                    "top": parseInt(y * s, 10) + "px",
                    "width": parseInt(width * s, 10) + "px",
                    "height": parseInt(height * s, 10) + "px"
                  });
                  return $(overflowDiv).css({
                    'height': parseInt(height * that.getScale(), 10) + "px",
                    'width': parseInt(width * that.getScale(), 10) + "px"
                  });
                };
                return rendering;
              });
              return that.addLens('TextContentZone', function(innerContainer, view, model, id) {
                var height, item, rendering, rootEl, text, textContainer, textDataView, width, x, y, zoom, _ref1, _ref2, _ref3, _ref4;
                rendering = {};
                app = options.application();
                zoom = app.imageControls.getZoom();
                item = model.getItem(id);
                textContainer = $("<div></div>");
                textContainer.css({
                  overflow: 'auto',
                  position: 'absolute'
                });
                container.append(textContainer);
                rootEl = $("<div></div>");
                $(rootEl).addClass("text-content");
                $(rootEl).attr("id", id);
                $(rootEl).css({
                  "white-space": "nowrap"
                });
                textContainer.append(rootEl);
                textDataView = MITHgrid.Data.SubSet.initInstance({
                  dataStore: model,
                  expressions: ['!target']
                });
                x = ((_ref1 = item.x) != null ? _ref1[0] : void 0) != null ? item.x[0] : 0;
                y = ((_ref2 = item.y) != null ? _ref2[0] : void 0) != null ? item.y[0] : 0;
                width = ((_ref3 = item.width) != null ? _ref3[0] : void 0) != null ? item.width[0] : options.width - x;
                height = ((_ref4 = item.height) != null ? _ref4[0] : void 0) != null ? item.height[0] : options.height - y;
                $(textContainer).css({
                  left: parseInt(16 + x * that.getScale(), 10) + "px",
                  top: parseInt(y * that.getScale(), 10) + "px",
                  width: parseInt(width * that.getScale(), 10) + "px",
                  height: parseInt(height * that.getScale(), 10) + "px"
                });
                text = Presentation.TextContent.initInstance(rootEl, {
                  types: options.types,
                  dataView: textDataView,
                  application: options.application,
                  height: height,
                  width: width,
                  x: x,
                  y: y,
                  scale: that.getScale(),
                  inHTML: true
                });
                textDataView.setKey(id);
                rendering.getHeight = text.getHeight;
                rendering.getY = text.getY;
                rendering._destroy = function() {
                  if (text._destroy != null) {
                    text._destroy();
                  }
                  if (textDataView._destroy != null) {
                    return textDataView._destroy();
                  }
                };
                rendering.remove = function() {
                  return $(textContainer).empty();
                };
                rendering.setScale = function(s) {
                  $(textContainer).css({
                    left: parseInt(16 + x * s, 10) + "px",
                    top: parseInt(y * s, 10) + "px",
                    width: parseInt(width * s, 10) + "px",
                    height: parseInt(height * s, 10) + "px"
                  });
                  return text.setScale(s);
                };
                rendering.update = function(item) {
                  var _ref5, _ref6, _ref7, _ref8;
                  x = ((_ref5 = item.x) != null ? _ref5[0] : void 0) != null ? item.x[0] : 0;
                  y = ((_ref6 = item.y) != null ? _ref6[0] : void 0) != null ? item.y[0] : 0;
                  width = ((_ref7 = item.width) != null ? _ref7[0] : void 0) != null ? item.width[0] : options.width - x;
                  height = ((_ref8 = item.height) != null ? _ref8[0] : void 0) != null ? item.height[0] : options.height - y;
                  that.setHeight(height);
                  return $(textContainer).css({
                    left: parseInt(16 + x * that.getScale(), 10) + "px",
                    top: parseInt(y * that.getScale(), 10) + "px",
                    width: parseInt(width * that.getScale(), 10) + "px",
                    height: parseInt(height * that.getScale(), 10) + "px"
                  });
                };
                return rendering;
              });
            }]));
          };
        });
        Presentation.namespace("Canvas", function(Canvas) {
          return Canvas.initInstance = function() {
            var args, container, ns, options, _ref, _ref1, _ref2;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            _ref = MITHgrid.normalizeArgs.apply(MITHgrid, args), ns = _ref[0], container = _ref[1], options = _ref[2];
            if (__indexOf.call(options.types, "Text") >= 0 && options.types.length === 1) {
              return (_ref1 = SGA.Reader.Presentation.TextCanvas).initInstance.apply(_ref1, args);
            } else {
              return (_ref2 = SGA.Reader.Presentation.ImageCanvas).initInstance.apply(_ref2, args);
            }
          };
        });
        Presentation.namespace("TextCanvas", function(Canvas) {
          return Canvas.initInstance = function() {
            var args, _ref;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            return (_ref = MITHgrid.Presentation).initInstance.apply(_ref, ["SGA.Reader.Presentation.TextCanvas"].concat(__slice.call(args), [function(that, container) {
              var DivHeight, DivWidth, annoExpr, baseFontSize, canvasHeight, canvasWidth, dataView, options, realCanvas, resizer, viewEl;
              options = that.options;
              annoExpr = that.dataView.prepare(['!target']);
              viewEl = $("<div></div>");
              container.append(viewEl);
              canvasWidth = null;
              canvasHeight = null;
              baseFontSize = 150;
              DivHeight = null;
              DivWidth = parseInt($(container).width() * 20 / 20, 10);
              $(container).height(parseInt($(container).width() * 4 / 3, 10));
              resizer = function() {
                DivWidth = parseInt($(container).width() * 20 / 20, 10);
                if ((canvasWidth != null) && canvasWidth > 0) {
                  return that.setScale(DivWidth / canvasWidth);
                }
              };
              MITHgrid.events.onWindowResize.addListener(resizer);
              $(viewEl).css({
                'border': '1px solid grey',
                'background-color': 'white'
              });
              that.events.onScaleChange.addListener(function(s) {
                if ((canvasWidth != null) && (canvasHeight != null)) {
                  DivHeight = parseInt(canvasHeight * s, 10);
                }
                $(viewEl).css({
                  'font-size': (parseInt(baseFontSize * s * 10, 10) / 10) + "px",
                  'line-height': (parseInt(baseFontSize * s * 11.5, 10) / 10) + "px",
                  'height': DivHeight,
                  'width': DivWidth
                });
                return typeof realCanvas !== "undefined" && realCanvas !== null ? realCanvas.setScale(s) : void 0;
              });
              dataView = MITHgrid.Data.SubSet.initInstance({
                dataStore: options.dataView,
                expressions: ['!target'],
                key: null
              });
              realCanvas = null;
              $(container).on("resetPres", function() {
                resizer();
                if (realCanvas != null) {
                  if (realCanvas.hide != null) {
                    realCanvas.hide();
                  }
                  if (realCanvas._destroy != null) {
                    realCanvas._destroy();
                  }
                }
                $(viewEl).empty();
                return realCanvas = SGA.Reader.Presentation.TextZone.initInstance(viewEl, {
                  types: options.types,
                  dataView: dataView,
                  application: options.application,
                  height: canvasHeight,
                  width: canvasWidth,
                  scale: DivWidth / canvasWidth
                });
              });
              return that.events.onCanvasChange.addListener(function(canvas) {
                var item, _ref, _ref1;
                dataView.setKey(canvas);
                item = dataView.getItem(canvas);
                canvasWidth = ((_ref = item.width) != null ? _ref[0] : void 0) || 1;
                canvasHeight = ((_ref1 = item.height) != null ? _ref1[0] : void 0) || 1;
                resizer();
                if (realCanvas != null) {
                  if (realCanvas.hide != null) {
                    realCanvas.hide();
                  }
                  if (realCanvas._destroy != null) {
                    realCanvas._destroy();
                  }
                }
                $(viewEl).empty();
                realCanvas = SGA.Reader.Presentation.TextZone.initInstance(viewEl, {
                  types: options.types,
                  dataView: dataView,
                  application: options.application,
                  height: canvasHeight,
                  width: canvasWidth,
                  scale: DivWidth / canvasWidth
                });
                that.setHeight(canvasHeight);
                return realCanvas.events.onHeightChange.addListener(that.setHeight);
              });
            }]));
          };
        });
        return Presentation.namespace("ImageCanvas", function(Canvas) {
          return Canvas.initInstance = function() {
            var args, _ref;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            return (_ref = MITHgrid.Presentation).initInstance.apply(_ref, ["SGA.Reader.Presentation.ImageCanvas"].concat(__slice.call(args), [function(that, container) {
              var SVG, SVGHeight, SVGWidth, annoExpr, canvasHeight, canvasWidth, dataView, e, options, pendingSVGfctns, realCanvas, setSizeAttrs, svgRoot, svgRootEl;
              options = that.options;
              annoExpr = that.dataView.prepare(['!target']);
              pendingSVGfctns = [];
              SVG = function(cb) {
                return pendingSVGfctns.push(cb);
              };
              svgRootEl = $("<svg xmlns=\"http://www.w3.org/2000/svg\" version=\"1.1\"\n     xmlns:xlink=\"http://www.w3.org/1999/xlink\"\n >\n</svg>");
              $(container).append(svgRootEl);
              try {
                svgRoot = $(svgRootEl).svg({
                  onLoad: function(svg) {
                    var cb, _i, _len;
                    SVG = function(cb) {
                      return cb(svg);
                    };
                    for (_i = 0, _len = pendingSVGfctns.length; _i < _len; _i++) {
                      cb = pendingSVGfctns[_i];
                      cb(svg);
                    }
                    return pendingSVGfctns = null;
                  }
                });
              } catch (_error) {
                e = _error;
                console.log("svg call failed:", e.message);
              }
              canvasWidth = null;
              canvasHeight = null;
              SVGHeight = null;
              SVGWidth = parseInt($(container).width() * 20 / 20, 10);
              setSizeAttrs = function() {
                return SVG(function(svgRoot) {
                  var svg, vb;
                  svg = $(svgRoot.root());
                  vb = svg.get(0).getAttribute("viewBox");
                  if (vb != null) {
                    svgRoot.configure({
                      viewBox: "0 0 " + (canvasWidth / 10) + " " + (canvasHeight / 10)
                    });
                  }
                  return svgRootEl.css({
                    width: SVGWidth,
                    height: SVGHeight,
                    border: "1px solid #eeeeee",
                    "border-radius": "2px",
                    "background-color": "#ffffff"
                  });
                });
              };
              that.events.onHeightChange.addListener(function(h) {
                SVGHeight = parseInt(SVGWidth / canvasWidth * canvasHeight, 10);
                return setSizeAttrs();
              });
              MITHgrid.events.onWindowResize.addListener(function() {
                SVGWidth = parseInt($(container).width() * 20 / 20, 10);
                if ((canvasWidth != null) && canvasWidth > 0) {
                  return that.setScale(SVGWidth / canvasWidth);
                }
              });
              that.events.onScaleChange.addListener(function(s) {
                if ((canvasWidth != null) && (canvasHeight != null)) {
                  SVGHeight = parseInt(canvasHeight * s, 10);
                  return setSizeAttrs();
                }
              });
              dataView = MITHgrid.Data.SubSet.initInstance({
                dataStore: options.dataView,
                expressions: ['!target'],
                key: null
              });
              realCanvas = null;
              $(container).on("resetPres", function() {
                SVGWidth = parseInt($(container).width() * 20 / 20, 10);
                if ((canvasWidth != null) && canvasWidth > 0) {
                  that.setScale(SVGWidth / canvasWidth);
                  if (realCanvas != null) {
                    if (realCanvas.hide != null) {
                      realCanvas.hide();
                    }
                    if (realCanvas._destroy != null) {
                      realCanvas._destroy();
                    }
                  }
                  return SVG(function(svgRoot) {
                    svgRoot.clear();
                    return realCanvas = SGA.Reader.Presentation.Zone.initInstance(svgRoot.root(), {
                      types: options.types,
                      dataView: dataView,
                      application: options.application,
                      height: canvasHeight,
                      width: canvasWidth,
                      svgRoot: svgRoot,
                      scale: that.getScale()
                    });
                  });
                }
              });
              return that.events.onCanvasChange.addListener(function(canvas) {
                var item, _ref, _ref1;
                dataView.setKey(canvas);
                item = dataView.getItem(canvas);
                canvasWidth = ((_ref = item.width) != null ? _ref[0] : void 0) || 1;
                canvasHeight = ((_ref1 = item.height) != null ? _ref1[0] : void 0) || 1;
                that.setScale(SVGWidth / canvasWidth);
                if (realCanvas != null) {
                  if (realCanvas.hide != null) {
                    realCanvas.hide();
                  }
                  if (realCanvas._destroy != null) {
                    realCanvas._destroy();
                  }
                }
                return SVG(function(svgRoot) {
                  $(container).trigger("sizeChange", [
                    {
                      w: container.width(),
                      h: container.height()
                    }
                  ]);
                  svgRoot.clear();
                  realCanvas = SGA.Reader.Presentation.Zone.initInstance(svgRoot.root(), {
                    types: options.types,
                    dataView: dataView,
                    application: options.application,
                    height: canvasHeight,
                    width: canvasWidth,
                    svgRoot: svgRoot,
                    scale: that.getScale()
                  });
                  that.setHeight(canvasHeight);
                  return realCanvas.events.onHeightChange.addListener(that.setHeight);
                });
              });
            }]));
          };
        });
      });
      SGAReader.namespace("Data", function(Data) {
        Data.namespace("StyleStore", function(StyleStore) {
          return StyleStore.initInstance = function() {
            var args;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            return MITHgrid.initInstance.apply(MITHgrid, __slice.call(args).concat([function(that) {
              var docs, options, regex;
              options = that.options;
              docs = {};
              regex = new RegExp("(?:\\.(\\S+)\\s*\\{\\s*([^}]*)\\s*\\})", "mg");
              that.addStyles = function(id, css) {
                var results, _results;
                if (docs[id] != null) {
                  return;
                }
                docs[id] = {};
                results = regex.exec(css);
                _results = [];
                while ((results != null ? results.index : void 0) != null) {
                  docs[id][results[1]] = results[2];
                  _results.push(results = regex.exec(css));
                }
                return _results;
              };
              return that.getStylesForClass = function(id, klass) {
                var _ref;
                if (((_ref = docs[id]) != null ? _ref[klass] : void 0) != null) {
                  return docs[id][klass];
                } else {
                  return "";
                }
              };
            }]));
          };
        });
        Data.namespace("TextStore", function(TextStore) {
          return TextStore.initInstance = function() {
            var args;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            return MITHgrid.initInstance.apply(MITHgrid, __slice.call(args).concat([function(that) {
              var fileContents, loadingFiles, options, pendingFiles;
              options = that.options;
              fileContents = {};
              loadingFiles = {};
              pendingFiles = {};
              that.addFile = function(files) {
                var file, _i, _len, _results;
                if (!$.isArray(files)) {
                  files = [files];
                }
                _results = [];
                for (_i = 0, _len = files.length; _i < _len; _i++) {
                  file = files[_i];
                  _results.push((function(file) {
                    if ((file != null) && (fileContents[file] == null) && (loadingFiles[file] == null)) {
                      loadingFiles[file] = [];
                      return $.ajax({
                        url: file,
                        type: 'GET',
                        processData: false,
                        success: function(data) {
                          var c, f, _j, _len1, _ref;
                          c = data.documentElement.textContent;
                          fileContents[file] = c;
                          _ref = loadingFiles[file];
                          for (_j = 0, _len1 = _ref.length; _j < _len1; _j++) {
                            f = _ref[_j];
                            f(c);
                          }
                          return delete loadingFiles[file];
                        }
                      });
                    }
                  })(file));
                }
                return _results;
              };
              return that.withFile = function(file, cb) {
                if (fileContents[file] != null) {
                  return cb(fileContents[file]);
                } else if (loadingFiles[file] != null) {
                  return loadingFiles[file].push(cb);
                } else {
                  that.addFile(file);
                  return loadingFiles[file].push(cb);
                }
              };
            }]));
          };
        });
        return Data.namespace("Manifest", function(Manifest) {
          var NS, types;
          NS = {
            "http://dms.stanford.edu/ns/": "sc",
            "http://www.shared-canvas.org/ns/": "sc",
            "http://www.w3.org/2000/01/rdf-schema#": "rdfs",
            "http://www.w3.org/1999/02/22-rdf-syntax-ns#": "rdf",
            "http://www.w3.org/2003/12/exif/ns#": "exif",
            "http://purl.org/dc/elements/1.1/": "dc",
            "http://www.w3.org/ns/openannotation/core/": "oa",
            "http://www.openannotation.org/ns/": "oa",
            "http://www.w3.org/ns/openannotation/extension/": "oax",
            "http://www.openarchives.org/ore/terms/": "ore",
            "http://www.shelleygodwinarchive.org/ns/1#": "sga",
            "http://www.shelleygodwinarchive.org/ns1#": "sga",
            "http://www.w3.org/2011/content#": "cnt",
            "http://purl.org/dc/dcmitype/": "dctypes"
          };
          types = {
            "http://www.w3.org/1999/02/22-rdf-syntax-ns#type": "item",
            "http://www.w3.org/ns/openannotation/core/hasMotivation": "item"
          };
          return Manifest.initInstance = function() {
            var args;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            return MITHgrid.initInstance.apply(MITHgrid, ["SGA.Reader.Data.Manifest"].concat(__slice.call(args), [function(that) {
              var data, flushSearchResults, getSearchResultCanvases, importFromURL, importer, itemsForCanvas, itemsWithType, loadedUrls, options;
              options = that.options;
              data = MITHgrid.Data.Store.initInstance();
              that.size = function() {
                return data.size();
              };
              importer = MITHgrid.Data.Importer.RDF_JSON.initInstance(data, NS, types);
              loadedUrls = [];
              importFromURL = function(url, cb) {
                if (__indexOf.call(loadedUrls, url) >= 0) {
                  cb();
                  return;
                }
                loadedUrls.push(url);
                that.addItemsToProcess(1);
                return $.ajax({
                  url: url,
                  type: 'GET',
                  contentType: 'application/rdf+json',
                  processData: false,
                  dataType: 'json',
                  success: function(data) {
                    that.addItemsProcessed(1);
                    return that.importJSON(data, cb);
                  },
                  error: function(e) {
                    that.addItemsProcessed(1);
                    throw new Error("Could not load the manifest");
                  }
                });
              };
              that.importJSON = function(json, cb) {
                var syncer;
                syncer = MITHgrid.initSynchronizer(cb);
                syncer.increment();
                importer["import"](json, function(ids) {
                  var idset, urls;
                  idset = MITHgrid.Data.Set.initInstance(ids);
                  urls = data.getObjectsUnion(idset, 'oreisDescribedBy');
                  urls.visit(function(url) {
                    syncer.increment();
                    return importFromURL(url, syncer.decrement);
                  });
                  return syncer.decrement();
                });
                return syncer.done();
              };
              itemsWithType = function(type) {
                if (!$.isArray(type)) {
                  type = [type];
                }
                types = MITHgrid.Data.Set.initInstance(type);
                return data.getSubjectsUnion(types, "type").items();
              };
              itemsForCanvas = function(canvas) {
                var annos, canvasSet, contentAnnotations, imageAnnotations, specificResources, specificResourcesAnnos, tei, teiURL;
                if (!$.isArray(canvas)) {
                  canvas = [canvas];
                }
                canvasSet = MITHgrid.Data.Set.initInstance(canvas);
                specificResources = data.getSubjectsUnion(canvasSet, "oahasSource");
                imageAnnotations = data.getSubjectsUnion(canvasSet, "oahasTarget");
                contentAnnotations = data.getSubjectsUnion(specificResources, "oahasTarget");
                tei = data.getObjectsUnion(contentAnnotations, 'oahasBody');
                teiURL = data.getObjectsUnion(tei, 'oahasSource');
                specificResourcesAnnos = data.getSubjectsUnion(teiURL, 'oahasSource');
                annos = data.getSubjectsUnion(specificResourcesAnnos, 'oahasTarget').items();
                return annos.concat(imageAnnotations.items(), contentAnnotations.items());
              };
              flushSearchResults = function() {
                var searchResults;
                types = MITHgrid.Data.Set.initInstance(['sgaSearchAnnotation']);
                searchResults = data.getSubjectsUnion(types, "type").items();
                return data.removeItems(searchResults);
              };
              getSearchResultCanvases = function() {
                var annos, canvasKeys, searchResults, sources, specificResources, step, teiURL;
                types = MITHgrid.Data.Set.initInstance(['sgaSearchAnnotation']);
                searchResults = data.getSubjectsUnion(types, "type");
                specificResources = data.getObjectsUnion(searchResults, "oahasTarget");
                teiURL = data.getObjectsUnion(specificResources, 'oahasSource');
                sources = data.getSubjectsUnion(teiURL, 'oahasSource');
                annos = data.getSubjectsUnion(sources, 'oahasBody');
                step = data.getObjectsUnion(annos, 'oahasTarget');
                canvasKeys = data.getObjectsUnion(step, 'oahasSource');
                return $.unique(canvasKeys.items());
              };
              that.getCanvases = function() {
                return itemsWithType('scCanvas');
              };
              that.getZones = function() {
                return itemsWithType('scZone');
              };
              that.getSequences = function() {
                return itemsWithType('scSequence');
              };
              that.getAnnotations = function() {
                return itemsWithType('oaAnnotation');
              };
              that.getRanges = function() {
                return itemsWithType('scRange');
              };
              that.getLayers = function() {
                return itemsWithType('scLayer');
              };
              that.getAnnotationsForCanvas = itemsForCanvas;
              that.flushSearchResults = flushSearchResults;
              that.getSearchResultCanvases = getSearchResultCanvases;
              that.getItem = data.getItem;
              that.contains = data.contains;
              return that.importFromURL = function(url, cb) {
                return importFromURL(url, function() {
                  if (cb != null) {
                    return cb();
                  }
                });
              };
            }]));
          };
        });
      });
      SGAReader.namespace("Component", function(Component) {
        Component.namespace("ProgressBar", function(ProgressBar) {
          return ProgressBar.initInstance = function() {
            var args;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            return MITHgrid.initInstance.apply(MITHgrid, ["SGA.Reader.Component.ProgressBar"].concat(__slice.call(args), [function(that, container) {
              that.events.onNumeratorChange.addListener(function(n) {
                var percent;
                percent = parseInt(100 * n / that.getDenominator(), 10);
                if (percent > 100) {
                  percent = 100;
                }
                return $(container).find(".bar").css("width", percent + "%");
              });
              that.events.onDenominatorChange.addListener(function(d) {
                var percent;
                percent = parseInt(100 * that.getNumerator() / d, 10);
                if (percent > 100) {
                  percent = 100;
                }
                return $(container).find(".bar").css("width", percent + "%");
              });
              that.show = function() {
                return $(container).show();
              };
              return that.hide = function() {
                return $(container).hide();
              };
            }]));
          };
        });
        Component.namespace("Spinner", function(Spinner) {
          return Spinner.initInstance = function() {
            var args;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            return MITHgrid.initInstance.apply(MITHgrid, ["SGA.Reader.Component.Spinner"].concat(__slice.call(args), [function(that, container) {
              that.show = function() {
                return $(container).show();
              };
              return that.hide = function() {
                return $(container).hide();
              };
            }]));
          };
        });
        Component.namespace("SequenceSelector", function(SequenceSelector) {
          return SequenceSelector.initInstance = function() {
            var args, _ref;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            return (_ref = MITHgrid.Presentation).initInstance.apply(_ref, ["SGA.Reader.Component.SequenceSelector"].concat(__slice.call(args), [function(that, container) {
              var options;
              options = that.options;
              return that.addLens('Sequence', function(container, view, model, id) {
                var el, item, rendering, _ref;
                that.setSequence(id);
                if ($(container).is("select")) {
                  rendering = {};
                  item = model.getItem(id);
                  el = $("<option></option>");
                  el.attr({
                    value: id
                  });
                  el.text((_ref = item.label) != null ? _ref[0] : void 0);
                  $(container).append(el);
                  $(container).change(function() {
                    return that.setSequence($(container).val());
                  });
                  that.events.onSequenceChange.addListener(function(v) {
                    return $(container).val(v);
                  });
                  return that.finishDisplayUpdate = function() {
                    return that.setSequence($(container).val());
                  };
                }
              });
            }]));
          };
        });
        Component.namespace("Slider", function(Slider) {
          return Slider.initInstance = function() {
            var args;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            return MITHgrid.initInstance.apply(MITHgrid, ["SGA.Reader.Component.Slider"].concat(__slice.call(args), [function(that, container) {
              var options;
              options = that.options;
              $('.canvas').on("searchResultsChange", function(e, results) {
                var $c, adjustment, pages, r, res_h_perc, res_height, s_max, s_min, valPercent, _i, _len, _results;
                $c = $(container);
                $('.res').remove();
                pages = that.getMax();
                _results = [];
                for (_i = 0, _len = results.length; _i < _len; _i++) {
                  r = results[_i];
                  r = r + 1;
                  res_height = $c.height() / (pages + 1);
                  res_h_perc = (pages + 1) / 100;
                  s_min = $c.slider("option", "min");
                  s_max = $c.slider("option", "max");
                  valPercent = 100 - ((r - s_min) / (s_max - s_min) * 100);
                  adjustment = res_h_perc / 2;
                  _results.push($c.append("<div style='bottom:" + (valPercent + adjustment) + "%; height:" + res_height + "px' class='res ui-slider-range ui-widget-header ui-corner-all'> </div>"));
                }
                return _results;
              });
              that.events.onMaxChange.addListener(function(n) {
                var pages;
                if ($(container).data("slider")) {
                  $(container).slider({
                    max: n
                  });
                } else {
                  pages = n;
                  $(container).slider({
                    orientation: "vertical",
                    range: "min",
                    min: that.getMin(),
                    max: pages,
                    value: pages,
                    step: 1,
                    slide: function(event, ui) {
                      if (options.getLabel != null) {
                        return $(ui.handle).text(options.getLabel(pages - ui.value));
                      }
                    },
                    stop: function(event, ui) {
                      0;
                      return that.setValue(pages - ui.value);
                    }
                  });
                  if (options.getLabel != null) {
                    $(container).find("a").text(options.getLabel(0));
                  }
                  $('.canvas').on("sizeChange", function(e, d) {
                    var $c;
                    $c = $(container);
                    $c.height(d.h);
                    return $('.canvas').unbind("sizeChange");
                  });
                }
                if ((that.getValue() != null) && parseInt(that.getValue()) !== NaN) {
                  $.bbq.pushState({
                    n: that.getValue() + 1
                  });
                  return $(container).slider({
                    value: pages - that.getValue()
                  });
                }
              });
              that.events.onMinChange.addListener(function(n) {
                if ($(container).data("slider")) {
                  return $(container).slider({
                    min: n
                  });
                }
              });
              return that.events.onValueChange.addListener(function(n) {
                if ($(container).data("slider")) {
                  $(container).slider({
                    value: that.getMax() - n
                  });
                }
                if (options.getLabel != null) {
                  $(container).find("a").text(options.getLabel(n));
                }
                if ((that.getValue() != null) && parseInt(that.getValue()) !== NaN) {
                  return $.bbq.pushState({
                    n: that.getValue() + 1
                  });
                }
              });
            }]));
          };
        });
        Component.namespace("PagerControls", function(PagerControls) {
          return PagerControls.initInstance = function() {
            var args;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            return MITHgrid.initInstance.apply(MITHgrid, ["SGA.Reader.Component.PagerControls"].concat(__slice.call(args), [function(that, container) {
              var firstEl, lastEl, nextEl, prevEl, updateBBQ;
              $(window).bind("hashchange", function(e) {
                var n;
                n = $.bbq.getState("n");
                if ((n != null) && parseInt(n) !== NaN) {
                  return that.setValue(n - 1);
                }
              });
              firstEl = $(container).find("#first-page");
              prevEl = $(container).find("#prev-page");
              nextEl = $(container).find("#next-page");
              lastEl = $(container).find("#last-page");
              that.events.onMinChange.addListener(function(n) {
                if (n < that.getValue()) {
                  firstEl.removeClass("disabled");
                  return prevEl.removeClass("disabled");
                } else {
                  firstEl.addClass("disabled");
                  return prevEl.addClass("disabled");
                }
              });
              that.events.onMaxChange.addListener(function(n) {
                if (n > that.getValue()) {
                  nextEl.removeClass("disabled");
                  return lastEl.removeClass("disabled");
                } else {
                  nextEl.addClass("disabled");
                  return lastEl.addClass("disabled");
                }
              });
              that.events.onValueChange.addListener(function(n) {
                if (n > that.getMin()) {
                  firstEl.removeClass("disabled");
                  prevEl.removeClass("disabled");
                } else {
                  firstEl.addClass("disabled");
                  prevEl.addClass("disabled");
                }
                if (n < that.getMax()) {
                  nextEl.removeClass("disabled");
                  return lastEl.removeClass("disabled");
                } else {
                  nextEl.addClass("disabled");
                  return lastEl.addClass("disabled");
                }
              });
              updateBBQ = function() {
                if ((that.getValue() != null) && parseInt(that.getValue()) !== NaN) {
                  return $.bbq.pushState({
                    n: that.getValue() + 1
                  });
                }
              };
              $(prevEl).click(function(e) {
                e.preventDefault();
                that.addValue(-1);
                return updateBBQ();
              });
              $(nextEl).click(function(e) {
                e.preventDefault();
                that.addValue(1);
                return updateBBQ();
              });
              $(firstEl).click(function(e) {
                e.preventDefault();
                that.setValue(that.getMin());
                return updateBBQ();
              });
              return $(lastEl).click(function(e) {
                e.preventDefault();
                that.setValue(that.getMax());
                return updateBBQ();
              });
            }]));
          };
        });
        Component.namespace("ImageControls", function(ImageControls) {
          return ImageControls.initInstance = function() {
            var args;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            return MITHgrid.initInstance.apply(MITHgrid, ["SGA.Reader.Component.ImageControls"].concat(__slice.call(args), [function(that, container) {
              var inEl, marqueeEl, outEl, resetEl;
              resetEl = $(container).find("#zoom-reset");
              inEl = $(container).find("#zoom-in");
              outEl = $(container).find("#zoom-out");
              marqueeEl = $(container).find("#marquee-sh");
              $(resetEl).click(function(e) {
                e.preventDefault();
                that.setZoom(that.getMinZoom());
                return that.setImgPosition({
                  topLeft: {
                    x: 0,
                    y: 0
                  },
                  bottomRight: {
                    x: 0,
                    y: 0
                  }
                });
              });
              $(inEl).click(function(e) {
                var zoom;
                e.preventDefault();
                zoom = that.getZoom();
                if (Math.floor(zoom + 1 <= that.getMaxZoom())) {
                  return that.setZoom(Math.floor(zoom + 1));
                }
              });
              $(outEl).click(function(e) {
                var minZoom, zoom;
                e.preventDefault();
                zoom = that.getZoom();
                minZoom = that.getMinZoom();
                if (Math.floor(zoom - 1 > minZoom)) {
                  return that.setZoom(Math.floor(zoom - 1));
                } else if (Math.floor(zoom - 1 === Math.floor(minZoom))) {
                  return that.setZoom(minZoom);
                }
              });
              return $(marqueeEl).click(function(e) {
                var marquees;
                e.preventDefault();
                marquees = $('.marquee');
                return marquees.each(function(i, m) {
                  m = $(m);
                  if (m.css("display") !== "none") {
                    return m.hide();
                  } else {
                    return m.show();
                  }
                });
              });
            }]));
          };
        });
        Component.namespace("SearchBox", function(SearchBox) {
          return SearchBox.initInstance = function() {
            var args;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            return MITHgrid.initInstance.apply(MITHgrid, ["SGA.Reader.Component.SearchBox"].concat(__slice.call(args), [function(that, service) {
              var container, srcButton, srcForm;
              that.events.onQueryChange.addListener(function(q) {
                q = q.replace(/\=/g, ':');
                q = q.replace(/\&/g, '|');
                return $.bbq.pushState({
                  s: q
                });
              });
              container = args[0];
              that.setServiceURL(service);
              srcButton = $('#search-btn');
              srcForm = $(container).closest('form');
              if (srcButton != null) {
                srcButton.click(function() {
                  return srcForm.submit();
                });
              }
              return srcForm.submit(function(e) {
                var f, fields, fields_html, i, val, _i, _len;
                e.preventDefault();
                fields_html = $('#limit-search').find('input:checked');
                fields = "";
                if (fields_html.length === 0) {
                  fields = "text";
                } else {
                  for (i = _i = 0, _len = fields_html.length; _i < _len; i = ++_i) {
                    f = fields_html[i];
                    fields += $(f).val();
                    if (i + 1 !== fields_html.length) {
                      fields += ',';
                    }
                  }
                }
                val = $(container).find('input').val();
                if (!val.match('^\s*$')) {
                  that.setQuery("f=" + fields + "&q=" + val);
                }
                return false;
              });
            }]));
          };
        });
        Component.namespace("ModeLayers", function(ModeLayers) {
          return ModeLayers.initInstance = function() {
            var args;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            return MITHgrid.initInstance.apply(MITHgrid, ["SGA.Reader.Component.ModeLayers"].concat(__slice.call(args), [function(that, container) {
              var canvas, get, hide, layerAnnos, show, text, xml;
              canvas = null;
              text = null;
              xml = null;
              layerAnnos = [];
              get = function() {
                var a, data, las, layerA, _i, _len, _ref, _results;
                data = that.options.dataView;
                las = MITHgrid.Data.Set.initInstance(['LayerAnno']);
                _ref = data.getSubjectsUnion(las, "type").items();
                _results = [];
                for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                  layerA = _ref[_i];
                  a = data.getItem(layerA);
                  _results.push(layerAnnos.push(a));
                }
                return _results;
              };
              show = function() {
                if (that.options.getMode() === 'xml') {
                  $(container).html(xml);
                  prettyPrint();
                } else {
                  $(container).html(text);
                }
                return $(container).show();
              };
              hide = function() {
                return $(container).hide();
              };
              that.options.dataView.events.onAfterLoading.addListener(function(d) {
                return get();
              });
              that.options.pagerEvt.addListener(function(canvas) {
                var a, c, _i, _len, _results;
                c = c;
                $(container).height($('.canvas').height());
                _results = [];
                for (_i = 0, _len = layerAnnos.length; _i < _len; _i++) {
                  a = layerAnnos[_i];
                  if (a.canvas[0] === canvas) {
                    if (a.motivation[0] === "http://www.shelleygodwinarchive.org/ns1#reading") {
                      _results.push($.get(a.body, function(data) {
                        var d, e, _j, _len1, _results1;
                        d = $.parseHTML(data);
                        _results1 = [];
                        for (_j = 0, _len1 = d.length; _j < _len1; _j++) {
                          e = d[_j];
                          if ($(e).is('div')) {
                            text = e;
                            if (that.options.getMode() === 'reading') {
                              _results1.push($(container).html(text));
                            } else {
                              _results1.push(void 0);
                            }
                          } else {
                            _results1.push(void 0);
                          }
                        }
                        return _results1;
                      }));
                    } else if (a.motivation[0] === "http://www.shelleygodwinarchive.org/ns1#source") {
                      _results.push($.get(a.body, function(data) {
                        var serializer, surface, txtdata;
                        surface = data.getElementsByTagName('surface');
                        serializer = new XMLSerializer();
                        txtdata = serializer.serializeToString(surface[0]);
                        txtdata = txtdata.replace(/\&/g, '&amp;');
                        txtdata = txtdata.replace(/%/g, '&#37;');
                        txtdata = txtdata.replace(/</g, '&lt;');
                        txtdata = txtdata.replace(/>/g, '&gt;');
                        xml = "<pre class='prettyprint'><code class='language-xml'>" + txtdata + "</code></pre>";
                        if (that.options.getMode() === 'xml') {
                          $(container).html(xml);
                          return prettyPrint();
                        }
                      }));
                    } else {
                      _results.push(void 0);
                    }
                  } else {
                    _results.push(void 0);
                  }
                }
                return _results;
              });
              return that.options.onModeChange.addListener(function(m) {
                switch (m) {
                  case 'reading':
                    $(container).removeClass('xml');
                    return show();
                  case 'xml':
                    $(container).addClass('xml');
                    return show();
                  default:
                    return hide();
                }
              });
            }]));
          };
        });
        Component.namespace("ModeControls", function(ModeControls) {
          return ModeControls.initInstance = function() {
            var args;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            return MITHgrid.initInstance.apply(MITHgrid, ["SGA.Reader.Component.ModeControls"].concat(__slice.call(args), [function(that, container) {
              var imgBinding, modeController, options, rdgBinding, restoreBoth, stdBinding, stored_txt_canvas, xmlBinding;
              options = that.options;
              stored_txt_canvas = null;
              restoreBoth = function() {
                var c, img_parent;
                img_parent = $('*[data-types=Image]').parent();
                c = /(col-[^-]+?-)(\d+)/g.exec($('*[data-types=Image]').parent()[0].className);
                img_parent[0].className = c[1] + parseInt(c[2]) / 2;
                stored_txt_canvas.insertAfter(img_parent);
                $('*[data-types=Image]').trigger('resetPres');
                stored_txt_canvas = null;
                return that.setMode('normal');
              };
              modeController = SGA.Reader.Controller.ModeSelector.initInstance();
              rdgBinding = modeController.bind('#mode-rdg', {
                mode: 'reading'
              });
              xmlBinding = modeController.bind('#mode-xml', {
                mode: 'xml'
              });
              stdBinding = modeController.bind('#mode-std', {
                mode: 'normal'
              });
              imgBinding = modeController.bind('#img-only', {
                mode: 'imgOnly'
              });
              rdgBinding.events.onModeSelect.addListener(that.setMode);
              xmlBinding.events.onModeSelect.addListener(that.setMode);
              stdBinding.events.onModeSelect.addListener(that.setMode);
              imgBinding.events.onModeSelect.addListener(that.setMode);
              that.events.onModeChange.addListener(function(m) {
                var thing, _i, _len, _ref;
                _ref = [rdgBinding, xmlBinding, stdBinding, imgBinding];
                for (_i = 0, _len = _ref.length; _i < _len; _i++) {
                  thing = _ref[_i];
                  thing.eventModeSelect(m);
                }
                return $.bbq.pushState({
                  m: m
                });
              });
              rdgBinding.onSelect = function() {
                if (stored_txt_canvas != null) {
                  restoreBoth();
                }
                return $('*[data-types=Text]').hide();
              };
              xmlBinding.onSelect = function() {
                if (stored_txt_canvas != null) {
                  restoreBoth();
                }
                return $('*[data-types=Text]').hide();
              };
              stdBinding.onSelect = function() {
                if (stored_txt_canvas != null) {
                  restoreBoth();
                }
                return $('*[data-types=Text]').show();
              };
              return imgBinding.onSelect = function() {
                var c;
                stored_txt_canvas = $('*[data-types=Text]').parent();
                $('*[data-types=Text]').parent().remove();
                c = /(col-[^-]+?-)(\d+)/g.exec($('*[data-types=Image]').parent()[0].className);
                $('*[data-types=Image]').parent()[0].className = c[1] + parseInt(c[2]) * 2;
                return $('*[data-types=Image]').trigger('resetPres');
              };
              /*
              $(imgOnly).click (e) ->
                e.preventDefault()
                  
                if !$(imgOnly).hasClass('active')
                  stored_txt_canvas = $('*[data-types=Text]').parent()
                  $('*[data-types=Text]').parent().remove()
                  
                  # Double the bootstrap column
                  c = /(col-[^-]+?-)(\d+)/g.exec( $('*[data-types=Image]').parent()[0].className )
                  $('*[data-types=Image]').parent()[0].className = c[1] + parseInt(c[2]) * 2
                  
                  $('*[data-types=Image]').trigger('resetPres')
                  that.setMode('imgOnly')
                  
              $(rdg).click (e) ->
                e.preventDefault()
                  
                if stored_txt_canvas?            
                  restoreBoth()
                  
                if !$(rdg).hasClass('active')
                  $('*[data-types=Text]').hide()
                  that.setMode('reading')
                  
              $(xml).click (e) ->
                e.preventDefault()
                  
                if stored_txt_canvas?            
                  restoreBoth()
                  
                if !$(xml).hasClass('active')
                  $('*[data-types=Text]').hide()
                  that.setMode('xml')          
                  
              $(std).click (e) ->
                e.preventDefault()
                  
                if stored_txt_canvas?
                  restoreBoth()
                $('*[data-types=Text]').show()
                that.setMode('normal')
              */

            }]));
          };
        });
        return Component.namespace("LimitViewControls", function(LimitViewControls) {
          return LimitViewControls.initInstance = function() {
            var args;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            return MITHgrid.initInstance.apply(MITHgrid, ["SGA.Reader.Component.LimitViewControls"].concat(__slice.call(args), [function(that, container) {
              var $c;
              $c = $(container);
              that.options.onModeChange.addListener(function(m) {
                if (m !== 'normal') {
                  $(container).fadeTo(1, 0.3);
                  return $(container).find('input').prop('disabled', true);
                } else {
                  $(container).fadeTo(1, 1);
                  return $(container).find('input').prop('disabled', false);
                }
              });
              $c.find('#hand-view_2').change(function() {
                var css;
                if ($(this).is(':checked')) {
                  css = ".canvas[data-types] .hand-pbs{ color:#a54647; } \n.canvas[data-types] *:not(.hand-pbs), .canvas[data-types] .DeletionAnnotation:not(.hand-pbs){ color:#D9D9D9; }\n.canvas[data-types] .DeletionAnnotation.hand-pbs{ color:#a54647; }";
                  $('#LimitViewControls_classes').remove();
                  return $("<style type='text/css' id='LimitViewControls_classes'>" + css + "</style>").appendTo("head");
                }
              });
              $c.find('#hand-view_1').change(function() {
                var css;
                if ($(this).is(':checked')) {
                  css = ".canvas[data-types] .hand-pbs{ color:#D9D9D9; } \n.canvas[data-types] *:not(.hand-pbs), .canvas[data-types] .DeletionAnnotation.hand-pbs{ color:#a54647; }\n.canvas[data-types] .DeletionAnnotation:not(.hand-pbs){ color:#a54647 }";
                  $('#LimitViewControls_classes').remove();
                  return $("<style type='text/css' id='LimitViewControls_classes'>" + css + "</style>").appendTo("head");
                }
              });
              return $c.find('#hand-view_0').change(function() {
                if ($(this).is(':checked')) {
                  return $('#LimitViewControls_classes').remove();
                }
              });
            }]));
          };
        });
      });
      SGAReader.namespace("Controller", function(Controller) {
        return Controller.namespace("ModeSelector", function(ModeSelector) {
          return ModeSelector.initInstance = function() {
            var args, _ref;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            return (_ref = MITHgrid.Controller).initInstance.apply(_ref, ["SGA.Reader.Controller.ModeSelector"].concat(__slice.call(args), [function(that, container) {
              var set;
              set = [];
              that.applyBindings = function(binding, options) {
                var el;
                set.push(binding);
                el = binding.locate('');
                binding.$clickHandler = function(e) {
                  var b, _i, _len, _results;
                  e.preventDefault();
                  binding.events.onModeSelect.fire(options.mode);
                  _results = [];
                  for (_i = 0, _len = set.length; _i < _len; _i++) {
                    b = set[_i];
                    _results.push(typeof b.eventModeSelect === "function" ? b.eventModeSelect(options.mode) : void 0);
                  }
                  return _results;
                };
                el.bind('click', binding.$clickHandler);
                binding.eventModeSelect = function(m) {
                  if (options.mode === m) {
                    if (!el.hasClass('active')) {
                      el.addClass('active');
                      return binding.onSelect();
                    }
                  } else {
                    if (el.hasClass('active')) {
                      el.removeClass('active');
                      return binding.onUnselect();
                    }
                  }
                };
                binding.onSelect = function() {};
                return binding.onUnselect = function() {};
              };
              return that.removeBindings = function(binding) {
                var s;
                set = (function() {
                  var _i, _len, _results;
                  _results = [];
                  for (_i = 0, _len = set.length; _i < _len; _i++) {
                    s = set[_i];
                    if (s !== binding) {
                      _results.push(s);
                    }
                  }
                  return _results;
                })();
                return el.unbind('click', binding.$clickHandler);
              };
            }]));
          };
        });
      });
      return SGAReader.namespace("Application", function(Application) {
        return Application.namespace("SharedCanvas", function(SharedCanvas) {
          SharedCanvas.initInstance = function() {
            var args, _ref;
            args = 1 <= arguments.length ? __slice.call(arguments, 0) : [];
            return (_ref = MITHgrid.Application).initInstance.apply(_ref, ["SGA.Reader.Application.SharedCanvas"].concat(__slice.call(args), [function(that) {
              var currentSequence, extractSpatialConstraint, extractTextBody, extractTextTarget, manifestData, options, presentations, textSource;
              options = that.options;
              presentations = [];
              that.addPresentation = function(config) {
                var p;
                p = SGA.Reader.Presentation.Canvas.initInstance(config.container, {
                  types: config.types,
                  application: function() {
                    return that;
                  },
                  dataView: that.dataView.canvasAnnotations
                });
                return presentations.push([p, config.container]);
              };
              currentSequence = null;
              that.events.onSequenceChange.addListener(function(s) {
                var hash, n, p, paras, seq, _ref;
                currentSequence = s;
                seq = that.dataStore.data.getItem(currentSequence);
                hash = $.param.fragment(window.location.href);
                paras = $.deparam(hash);
                n = parseInt(paras.n);
                if ((paras.n != null) && (seq.sequence.length >= (_ref = n - 1) && _ref >= 0)) {
                  p = n - 1;
                } else {
                  if ((seq != null ? seq.sequence : void 0) != null) {
                    p = seq.sequence.indexOf(that.getCanvas());
                  }
                  if (p < 0) {
                    p = 0;
                  }
                }
                return that.setPosition(p);
              });
              that.events.onPositionChange.addListener(function(p) {
                var canvasKey, seq, _ref;
                seq = that.dataStore.data.getItem(currentSequence);
                canvasKey = (_ref = seq.sequence) != null ? _ref[p] : void 0;
                return that.setCanvas(canvasKey);
              });
              that.events.onCanvasChange.addListener(function(k) {
                var allAnnos, annos, canvasKey, p, seq, _ref;
                that.dataView.canvasAnnotations.setKey(k);
                seq = that.dataStore.data.getItem(currentSequence);
                p = seq.sequence.indexOf(k);
                if (p >= 0 && p !== that.getPosition()) {
                  that.setPosition(p);
                }
                canvasKey = (_ref = seq.sequence) != null ? _ref[p] : void 0;
                allAnnos = that.dataView.canvasAnnotations.items();
                if (allAnnos.length > 0) {
                  that.dataView.canvasAnnotations.removeItems(allAnnos);
                  annos = that.getAnnotationsForCanvas(canvasKey);
                  that.dataStore.data.removeItems(annos);
                }
                Q.nfcall(that.loadCanvas, k).then(function() {
                  return setTimeout((function() {
                    var pp, _i, _len, _results;
                    _results = [];
                    for (_i = 0, _len = presentations.length; _i < _len; _i++) {
                      pp = presentations[_i];
                      _results.push(pp[0].setCanvas(k));
                    }
                    return _results;
                  }), 100);
                });
                return k;
              });
              manifestData = SGA.Reader.Data.Manifest.initInstance();
              that.events.onItemsProcessedChange = manifestData.events.onItemsProcessedChange;
              that.events.onItemsToProcessChange = manifestData.events.onItemsToProcessChange;
              that.getItemsProcessed = manifestData.getItemsProcessed;
              that.getItemsToProcess = manifestData.getItemsToProcess;
              that.setItemsProcessed = manifestData.setItemsProcessed;
              that.setItemsToProcess = manifestData.setItemsToProcess;
              that.addItemsProcessed = manifestData.addItemsProcessed;
              that.addItemsToProcess = manifestData.addItemsToProcess;
              that.addManifestData = manifestData.importFromURL;
              that.getAnnotationsForCanvas = manifestData.getAnnotationsForCanvas;
              that.flushSearchResults = manifestData.flushSearchResults;
              that.getSearchResultCanvases = manifestData.getSearchResultCanvases;
              textSource = SGA.Reader.Data.TextStore.initInstance();
              that.withSource = textSource.withFile;
              extractSpatialConstraint = function(item, id) {
                var bits, constraint, _ref, _ref1;
                if (id == null) {
                  return;
                }
                constraint = manifestData.getItem(id);
                if (__indexOf.call(constraint.type, 'oaFragmentSelector') >= 0) {
                  if (constraint.rdfvalue[0].substr(0, 5) === "xywh=") {
                    item.shape = "Rectangle";
                    bits = constraint.rdfvalue[0].substr(5).split(",");
                    item.x = parseInt(bits[0], 10);
                    item.y = parseInt(bits[1], 10);
                    item.width = parseInt(bits[2], 10);
                    return item.height = parseInt(bits[3], 10);
                  }
                } else {
                  if (constraint.oaxbegin != null) {
                    item.start = parseInt((_ref = constraint.oaxbegin) != null ? _ref[0] : void 0, 10);
                  }
                  if (constraint.oaxend != null) {
                    return item.end = parseInt((_ref1 = constraint.oaxend) != null ? _ref1[0] : void 0, 10);
                  }
                }
              };
              extractTextTarget = function(item, id) {
                var styleItem, target, _ref;
                if (id == null) {
                  return;
                }
                target = manifestData.getItem(id);
                if (__indexOf.call(target.type, "oaSpecificResource") >= 0) {
                  item.target = target.oahasSource;
                  if (target.oahasStyle != null) {
                    styleItem = manifestData.getItem(target.oahasStyle[0]);
                    if (__indexOf.call(styleItem.dcformat, "text/css") >= 0) {
                      item.css = styleItem.cntchars;
                    }
                  }
                  if (target.sgahasClass != null) {
                    item.cssclass = target.sgahasClass[0];
                  }
                  return extractSpatialConstraint(item, (_ref = target.oahasSelector) != null ? _ref[0] : void 0);
                } else {
                  return item.target = id;
                }
              };
              extractTextBody = function(item, id) {
                var body, _ref;
                if (id == null) {
                  return;
                }
                body = manifestData.getItem(id);
                textSource.addFile(body.oahasSource);
                item.source = body.oahasSource;
                return extractSpatialConstraint(item, (_ref = body.oahasSelector) != null ? _ref[0] : void 0);
              };
              that.loadCanvas = function(canvas, cb) {
                var annos, deferred, items, syncer, textAnnos, textSources;
                deferred = Q.defer();
                items = [];
                textSources = {};
                textAnnos = [];
                syncer = MITHgrid.initSynchronizer();
                annos = manifestData.getAnnotationsForCanvas(canvas);
                that.addItemsToProcess(annos.length);
                syncer.process(annos, function(id) {
                  var aitem, array, f, imgitem, item, sgaTypes, target, _name, _ref, _ref1, _ref2, _ref3;
                  that.addItemsProcessed(1);
                  aitem = manifestData.getItem(id);
                  array = null;
                  item = {
                    id: id
                  };
                  if (__indexOf.call(aitem.type, "scContentAnnotation") >= 0) {
                    extractTextTarget(item, (_ref = aitem.oahasTarget) != null ? _ref[0] : void 0);
                    extractTextBody(item, (_ref1 = aitem.oahasBody) != null ? _ref1[0] : void 0);
                    if ((item.start != null) && (item.end != null)) {
                      if (textSources[_name = item.source] == null) {
                        textSources[_name] = [];
                      }
                      textSources[item.source].push([id, item.start, item.end]);
                    }
                    if (item.text != null) {
                      item.type = "ContentAnnotation";
                    } else {
                      item.type = "TextContentZone";
                    }
                    array = items;
                  } else if (__indexOf.call(aitem.type, "scImageAnnotation") >= 0) {
                    imgitem = manifestData.getItem(aitem.oahasBody);
                    if ($.isArray(imgitem)) {
                      imgitem = imgitem[0];
                    }
                    array = items;
                    item.target = aitem.oahasTarget;
                    item.label = aitem.rdfslabel;
                    item.image = imgitem.oahasSource || aitem.oahasBody;
                    item.type = "Image";
                    if (__indexOf.call(imgitem["dcformat"], "image/jp2") >= 0 && (that.imageControls != null) && (imgitem.schasRelatedService != null)) {
                      item.type = "ImageViewer";
                      item.url = imgitem.schasRelatedService[0] + "?url_ver=Z39.88-2004&rft_id=" + item.image[0];
                    }
                  } else if (__indexOf.call(aitem.type, "scZoneAnnotation") >= 0) {
                    target = manifestData.getItem(aitem.oahasTarget);
                    extractSpatialConstraint(item, (_ref2 = target.hasSelector) != null ? _ref2[0] : void 0);
                    array = items;
                    item.target = target.hasSource;
                    item.label = aitem.rdfslabel;
                    item.type = "ZoneAnnotation";
                  } else {
                    sgaTypes = (function() {
                      var _i, _len, _ref3, _results;
                      _ref3 = aitem.type;
                      _results = [];
                      for (_i = 0, _len = _ref3.length; _i < _len; _i++) {
                        f = _ref3[_i];
                        if (f.substr(0, 3) === "sga" && f.substr(f.length - 10) === "Annotation") {
                          _results.push(f.substr(3));
                        }
                      }
                      return _results;
                    })();
                    if (sgaTypes.length > 0) {
                      extractTextTarget(item, (_ref3 = aitem.oahasTarget) != null ? _ref3[0] : void 0);
                      item.type = sgaTypes;
                      array = textAnnos;
                    }
                  }
                  if ((item.type != null) && (array != null)) {
                    return array.push(item);
                  }
                });
                syncer.done(function() {
                  that.addItemsToProcess(1 + textAnnos.length);
                  return that.dataStore.data.loadItems(items, function() {
                    var item, modInfo, modend, modstart, s, setMod, source, sources, _fn, _i, _j, _len, _len1;
                    items = [];
                    modstart = {};
                    modend = {};
                    modInfo = {};
                    setMod = function(item) {
                      var end, id, source, start, _base, _base1;
                      source = item.target;
                      start = item.start;
                      end = item.end;
                      id = item.id;
                      if ($.isArray(id)) {
                        id = id[0];
                      }
                      modInfo[id] = item;
                      if (modstart[source] == null) {
                        modstart[source] = {};
                      }
                      if ((_base = modstart[source])[start] == null) {
                        _base[start] = [];
                      }
                      modstart[source][start].push(id);
                      if (modend[source] == null) {
                        modend[source] = {};
                      }
                      if ((_base1 = modend[source])[end] == null) {
                        _base1[end] = [];
                      }
                      return modend[source][end].push(id);
                    };
                    for (_i = 0, _len = textAnnos.length; _i < _len; _i++) {
                      item = textAnnos[_i];
                      setMod(item);
                    }
                    sources = (function() {
                      var _results;
                      _results = [];
                      for (s in modstart) {
                        _results.push(s);
                      }
                      return _results;
                    })();
                    that.addItemsToProcess(sources.length);
                    that.addItemsProcessed(textAnnos.length);
                    _fn = function(source) {
                      return that.withSource(source, function(text) {
                        var br_pushed, id, idx, last_pos, makeLinebreak, makeTextItems, mends, modIds, mstarts, needs_br, p, pos, positions, processNode, pushTextItem, textItems, _k, _l, _len2, _len3, _len4, _m, _ref, _ref1;
                        textItems = [];
                        modIds = [];
                        br_pushed = false;
                        pushTextItem = function(classes, css, target, start, end) {
                          return textItems.push({
                            type: classes,
                            css: css.join(" "),
                            text: text.slice(start, end),
                            id: source + "-" + start + "-" + end,
                            target: target,
                            start: start,
                            end: end
                          });
                        };
                        processNode = function(start, end) {
                          var classes, css, id, _k, _len2;
                          classes = [];
                          css = [];
                          for (_k = 0, _len2 = modIds.length; _k < _len2; _k++) {
                            id = modIds[_k];
                            classes.push(modInfo[id].type);
                            if (modInfo[id].cssclass != null) {
                              classes.push(modInfo[id].cssclass);
                            }
                            if ($.isArray(modInfo[id].css)) {
                              css.push(modInfo[id].css.join(" "));
                            } else {
                              css.push(modInfo[id].css);
                            }
                          }
                          if (classes.length === 0) {
                            classes.push("Text");
                          }
                          return makeTextItems(start, end, classes, css);
                        };
                        makeTextItems = function(start, end, classes, css) {
                          var candidate, e, _k, _len2, _ref;
                          _ref = textSources[source] || [];
                          for (_k = 0, _len2 = _ref.length; _k < _len2; _k++) {
                            candidate = _ref[_k];
                            if (start <= candidate[2] && end >= candidate[1]) {
                              s = Math.min(Math.max(start, candidate[1]), candidate[2]);
                              e = Math.max(Math.min(end, candidate[2]), candidate[1]);
                              pushTextItem(classes, css, candidate[0], s, e);
                            }
                          }
                          return false;
                        };
                        makeLinebreak = function(pos) {
                          var classes;
                          classes = ["LineBreak"];
                          return makeTextItems(pos, pos, classes, [""]);
                        };
                        mstarts = modstart[source] || [];
                        mends = modend[source] || [];
                        last_pos = 0;
                        positions = ((function() {
                          var _results;
                          _results = [];
                          for (p in mstarts) {
                            _results.push(parseInt(p, 10));
                          }
                          return _results;
                        })()).concat((function() {
                          var _results;
                          _results = [];
                          for (p in mends) {
                            _results.push(parseInt(p, 10));
                          }
                          return _results;
                        })()).sort(function(a, b) {
                          return a - b;
                        });
                        for (_k = 0, _len2 = positions.length; _k < _len2; _k++) {
                          pos = positions[_k];
                          if (pos !== last_pos) {
                            processNode(last_pos, pos);
                            if (br_pushed && !text.substr(last_pos, pos - last_pos).match(/^\s*$/)) {
                              br_pushed = false;
                            }
                            needs_br = false;
                            _ref = mstarts[pos] || [];
                            for (_l = 0, _len3 = _ref.length; _l < _len3; _l++) {
                              id = _ref[_l];
                              if (__indexOf.call(modInfo[id].type, "LineAnnotation") >= 0) {
                                needs_br = true;
                              }
                              modIds.push(id);
                            }
                            _ref1 = mends[pos] || [];
                            for (_m = 0, _len4 = _ref1.length; _m < _len4; _m++) {
                              id = _ref1[_m];
                              if (__indexOf.call(modInfo[id].type, "LineAnnotation") >= 0) {
                                needs_br = true;
                              }
                              idx = modIds.indexOf(id);
                              if (idx > -1) {
                                modIds.splice(idx, 1);
                              }
                            }
                            if (needs_br && !br_pushed) {
                              makeLinebreak(pos);
                              br_pushed = true;
                            }
                            last_pos = pos;
                          }
                        }
                        processNode(last_pos, text.length);
                        return that.dataStore.data.loadItems(textItems, function() {
                          return that.addItemsProcessed(1);
                        });
                      });
                    };
                    for (_j = 0, _len1 = sources.length; _j < _len1; _j++) {
                      source = sources[_j];
                      _fn(source);
                    }
                    deferred.resolve();
                    return that.addItemsProcessed(1);
                  });
                });
                if (cb != null) {
                  cb();
                }
                return deferred.promise;
              };
              if (options.url != null) {
                manifestData.importFromURL(options.url, function() {
                  var canvases, items, layers, ranges, seq, syncer, zones;
                  items = [];
                  syncer = MITHgrid.initSynchronizer();
                  canvases = manifestData.getCanvases();
                  that.addItemsToProcess(canvases.length);
                  syncer.process(canvases, function(id) {
                    var mitem, _ref, _ref1;
                    that.addItemsProcessed(1);
                    mitem = manifestData.getItem(id);
                    return items.push({
                      id: id,
                      type: 'Canvas',
                      width: parseInt((_ref = mitem.exifwidth) != null ? _ref[0] : void 0, 10),
                      height: parseInt((_ref1 = mitem.exifheight) != null ? _ref1[0] : void 0, 10),
                      label: mitem.dctitle || mitem.rdfslabel
                    });
                  });
                  zones = manifestData.getZones();
                  that.addItemsToProcess(zones.length);
                  syncer.process(zones, function(id) {
                    var zitem, _ref, _ref1, _ref2;
                    that.addItemsProcessed(1);
                    zitem = manifestData.getItem(id);
                    return items.push({
                      id: id,
                      type: 'Zone',
                      width: parseInt((_ref = mitem.exifwidth) != null ? _ref[0] : void 0, 10),
                      height: parseInt((_ref1 = mitem.exifheight) != null ? _ref1[0] : void 0, 10),
                      angle: parseInt((_ref2 = mitem.scnaturalAngle) != null ? _ref2[0] : void 0, 10) || 0,
                      label: zitem.rdfslabel
                    });
                  });
                  seq = manifestData.getSequences();
                  that.addItemsToProcess(seq.length);
                  syncer.process(seq, function(id) {
                    var item, sitem;
                    that.addItemsProcessed(1);
                    sitem = manifestData.getItem(id);
                    item = {
                      id: id,
                      type: 'Sequence',
                      label: sitem.rdfslabel
                    };
                    seq = [];
                    seq.push(sitem.rdffirst[0]);
                    sitem = manifestData.getItem(sitem.rdfrest[0]);
                    while (sitem.id != null) {
                      seq.push(sitem.rdffirst[0]);
                      sitem = manifestData.getItem(sitem.rdfrest[0]);
                    }
                    item.sequence = seq;
                    return items.push(item);
                  });
                  ranges = manifestData.getRanges();
                  that.addItemsToProcess(ranges.length);
                  syncer.process(ranges, function(id) {
                    var contents, item, ritem;
                    that.addItemsProcessed(1);
                    ritem = manifestData.getItem(id);
                    item = {
                      id: id,
                      type: 'Range',
                      label: ritem.rdfslabel
                    };
                    contents = [];
                    contents.push(ritem.rdffirst[0]);
                    ritem = manifestData.getItem(ritem.rdfrest[0]);
                    while (ritem.id != null) {
                      contents.push(ritem.rdffirst[0]);
                      ritem = manifestData.getItem(ritem.rdfrest[0]);
                    }
                    item.canvases = contents;
                    return items.push(item);
                  });
                  layers = manifestData.getLayers();
                  that.addItemsToProcess(layers.length);
                  syncer.process(layers, function(id) {
                    var a, aitem, annos, aritem, c, contents, item, ritem, _i, _len, _ref;
                    that.addItemsProcessed(1);
                    ritem = manifestData.getItem(id);
                    item = {
                      id: id,
                      type: 'Layer',
                      label: ritem.rdfslabel,
                      motivation: (_ref = ritem.scforMotivation) != null ? _ref[0] : void 0
                    };
                    contents = [];
                    contents.push(ritem.rdffirst[0]);
                    ritem = manifestData.getItem(ritem.rdfrest[0]);
                    while (ritem.id != null) {
                      contents.push(ritem.rdffirst[0]);
                      ritem = manifestData.getItem(ritem.rdfrest[0]);
                    }
                    if (item.motivation === "http://www.shelleygodwinarchive.org/ns1#reading" || item.motivation === "http://www.shelleygodwinarchive.org/ns1#source") {
                      annos = [];
                      for (_i = 0, _len = contents.length; _i < _len; _i++) {
                        c = contents[_i];
                        ritem = manifestData.getItem(c);
                        a = manifestData.getItem(ritem.rdffirst[0]);
                        annos.push(a.id);
                        aritem = manifestData.getItem(a.id[0]);
                        aitem = {
                          id: aritem.id[0],
                          type: 'LayerAnno',
                          motivation: item.motivation,
                          body: aritem.oahasBody[0],
                          canvas: a.oahasTarget[0]
                        };
                        items.push(aitem);
                      }
                      item.annotations = annos;
                    }
                    item.canvases = contents;
                    return items.push(item);
                  });
                  return syncer.done(function() {
                    return that.dataStore.data.loadItems(items);
                  });
                });
              }
              that.getRangeMetadata = function(id) {
                var info, meta, _ref;
                meta = {};
                info = that.dataStore.data.getItem(id);
                meta.rangeTitle = (_ref = info.label) != null ? _ref[0] : void 0;
                return meta;
              };
              that.getManifestMetadata = function(id) {
                var info, ret, _ref, _ref1, _ref2, _ref3, _ref4, _ref5, _ref6, _ref7;
                ret = {};
                if (id == null) {
                  id = options.url;
                  id = id.substr(0, id.indexOf('.json'));
                  id = id.replace('dev.', '');
                }
                if (id != null) {
                  info = manifestData.getItem(id);
                  ret.workTitle = (_ref = info.dctitle) != null ? _ref[0] : void 0;
                  ret.workNotebook = (_ref1 = info.rdfslabel) != null ? _ref1[0] : void 0;
                  ret.workAuthor = (_ref2 = info.scagentLabel) != null ? _ref2[0] : void 0;
                  ret.workHands = (_ref3 = info.sgahandLabel) != null ? _ref3[0] : void 0;
                  ret.workDate = (_ref4 = info.scdateLabel) != null ? _ref4[0] : void 0;
                  ret.workState = (_ref5 = info.sgastateLabel) != null ? _ref5[0] : void 0;
                  ret.workInstitution = (_ref6 = info.scattributionLabel) != null ? _ref6[0] : void 0;
                  ret.workShelfmark = (_ref7 = info.sgashelfmarkLabel) != null ? _ref7[0] : void 0;
                }
                return ret;
              };
              return that.getCanvasMetadata = function(id) {
                var info, meta, rangeIds, rangeTitles, _ref;
                meta = that.getManifestMetadata();
                info = that.dataStore.data.getItem(id);
                meta.canvasTitle = (_ref = info.label) != null ? _ref[0] : void 0;
                rangeIds = that.dataStore.data.getSubjectsUnion(MITHgrid.Data.Set.initInstance([id]), 'canvases');
                rangeTitles = {};
                rangeIds.visit(function(rid) {
                  var rmeta;
                  rmeta = that.getRangeMetadata(rid);
                  if (rmeta.rangeTitle != null) {
                    meta.rangeTitle || (meta.rangeTitle = []);
                    return meta.rangeTitle.push(rmeta.rangeTitle);
                  }
                });
                return meta;
              };
            }]));
          };
          return SharedCanvas.builder = function(config) {
            var manifestCallbacks, that, updateProgressTracker, updateProgressTrackerVisibility, updateSearchResults, updateSpinnerVisibility, uptv, uptvTimer;
            that = {
              manifests: {}
            };
            manifestCallbacks = {};
            updateProgressTracker = function() {};
            updateProgressTrackerVisibility = function() {};
            updateSpinnerVisibility = function() {};
            updateSearchResults = function() {};
            if (config.spinner != null) {
              updateSpinnerVisibility = function() {
                var m, obj, tot, _ref, _results;
                _ref = that.manifests;
                _results = [];
                for (m in _ref) {
                  obj = _ref[m];
                  tot = obj.getItemsToProcess();
                  _results.push(obj.events.onItemsToProcessChange.addListener(function(i) {
                    if (i > tot) {
                      return config.spinner.hide();
                    }
                  }));
                }
                return _results;
              };
            }
            if (config.progressTracker != null) {
              updateProgressTracker = function() {
                var d, m, n, obj, _ref;
                n = 0;
                d = 0;
                _ref = that.manifests;
                for (m in _ref) {
                  obj = _ref[m];
                  n += obj.getItemsProcessed();
                  d += obj.getItemsToProcess();
                }
                config.progressTracker.setNumerator(n);
                return config.progressTracker.setDenominator(d || 1);
              };
              uptv = null;
              uptvTimer = 1000;
              updateProgressTrackerVisibility = function() {
                if (uptv != null) {
                  return uptvTimer = 500;
                } else {
                  uptv = function() {
                    var m, obj, _ref;
                    _ref = that.manifests;
                    for (m in _ref) {
                      obj = _ref[m];
                      if (obj.getItemsToProcess() > obj.getItemsProcessed()) {
                        config.progressTracker.show();
                        uptvTimer /= 2;
                        if (uptvTimer < 500) {
                          uptvTimer = 500;
                        }
                        setTimeout(uptv, uptvTimer);
                        return;
                      }
                    }
                    if (uptvTimer > 500) {
                      config.progressTracker.hide();
                    }
                    uptvTimer *= 2;
                    if (uptvTimer > 10000) {
                      uptvTimer = 10000;
                    }
                    return setTimeout(uptv, uptvTimer);
                  };
                  return uptv();
                }
              };
            }
            if (config.searchBox != null) {
              if (config.searchBox.getServiceURL() != null) {
                $.param.fragment.noEscape(':,/|');
                updateSearchResults = function(q) {
                  var m, obj, queryURL, _ref, _results;
                  queryURL = config.searchBox.getServiceURL() + q;
                  _ref = that.manifests;
                  _results = [];
                  for (m in _ref) {
                    obj = _ref[m];
                    obj.flushSearchResults();
                    _results.push(obj.addManifestData(queryURL, function() {
                      var canvasKey, canvasesWithResults, cwr, cwrPos, p, s, seq, _i, _len, _ref1;
                      p = obj.getPosition();
                      s = obj.getSequence();
                      seq = obj.dataStore.data.getItem(s);
                      canvasKey = (_ref1 = seq.sequence) != null ? _ref1[p] : void 0;
                      canvasesWithResults = obj.getSearchResultCanvases();
                      cwrPos = [];
                      for (_i = 0, _len = canvasesWithResults.length; _i < _len; _i++) {
                        cwr = canvasesWithResults[_i];
                        cwrPos.push($.inArray(cwr, seq.sequence));
                      }
                      $('.canvas').trigger("searchResultsChange", [cwrPos]);
                      return Q.fcall(obj.loadCanvas, canvasKey).then(function() {
                        var newPage;
                        if (p === 0) {
                          newPage = p + 1;
                        } else {
                          newPage = p - 1;
                        }
                        setTimeout(function() {
                          return obj.setPosition(newPage, 0);
                        });
                        return setTimeout(function() {
                          return obj.setPosition(p, 0);
                        });
                      });
                    }));
                  }
                  return _results;
                };
                config.searchBox.events.onQueryChange.addListener(function(q) {
                  return updateSearchResults(q);
                });
              } else {
                console.log("You must specify the URL to some search service.");
              }
            }
            that.onManifest = function(url, cb) {
              if (that.manifests[url] != null) {
                return that.manifests[url].ready(function() {
                  return cb(that.manifests[url]);
                });
              } else {
                if (manifestCallbacks[url] == null) {
                  manifestCallbacks[url] = [];
                }
                return manifestCallbacks[url].push(cb);
              }
            };
            that.addPresentation = function(el) {
              var manifest, manifestUrl, types, _ref;
              $(el).height(parseInt($(el).width() * 4 / 3, 10));
              manifestUrl = $(el).data('manifest');
              if (manifestUrl != null) {
                manifest = that.manifests[manifestUrl];
                if (manifest == null) {
                  manifest = Application.SharedCanvas.initInstance({
                    url: manifestUrl
                  });
                  that.manifests[manifestUrl] = manifest;
                  manifest.ready(function() {
                    var cb, cbs, _i, _len;
                    cbs = manifestCallbacks[manifestUrl] || [];
                    for (_i = 0, _len = cbs.length; _i < _len; _i++) {
                      cb = cbs[_i];
                      cb(manifest);
                    }
                    return delete manifestCallbacks[manifestUrl];
                  });
                  manifest.events.onItemsToProcessChange.addListener(updateProgressTracker);
                  manifest.events.onItemsProcessedChange.addListener(updateProgressTracker);
                  updateProgressTrackerVisibility();
                  updateSpinnerVisibility();
                  if (config.searchBox != null) {
                    manifest.ready(function() {
                      var removeListener;
                      if (manifest.getSequence() == null) {
                        return removeListener = manifest.events.onSequenceChange.addListener(function() {
                          var bbq_q;
                          bbq_q = $.bbq.getState('s');
                          if (bbq_q != null) {
                            bbq_q = bbq_q.replace(/:/g, '=');
                            bbq_q = bbq_q.replace(/\|/g, '&');
                            updateSearchResults(bbq_q);
                          }
                          return removeListener();
                        });
                      }
                    });
                  }
                }
                manifest.run();
                types = (_ref = $(el).data('types')) != null ? _ref.split(/\s*,\s*/) : void 0;
                return that.onManifest(manifestUrl, function(manifest) {
                  return manifest.addPresentation({
                    types: types,
                    container: $(el)
                  });
                });
              }
            };
            if (config["class"] == null) {
              config["class"] = ".canvas";
            }
            $(config["class"]).each(function(idx, el) {
              return that.addPresentation(el);
            });
            return that;
          };
        });
      });
    });
  })(jQuery, MITHgrid);

  MITHgrid.defaults('SGA.Reader.Application.SharedCanvas', {
    dataStores: {
      data: {
        types: {
          Sequence: {},
          Canvas: {}
        },
        properties: {
          target: {
            valueType: 'item'
          }
        }
      }
    },
    dataViews: {
      canvasAnnotations: {
        dataStore: 'data',
        type: MITHgrid.Data.SubSet,
        expressions: ['!target']
      },
      sequences: {
        dataStore: 'data',
        types: ['Sequence']
      }
    },
    variables: {
      Canvas: {
        is: 'rw'
      },
      Sequence: {
        is: 'rw'
      },
      Position: {
        is: 'lrw',
        isa: 'numeric'
      }
    }
  });

  MITHgrid.defaults('SGA.Reader.Component.Slider', {
    variables: {
      Min: {
        is: 'rw',
        isa: 'numeric'
      },
      Max: {
        is: 'rw',
        isa: 'numeric'
      },
      Value: {
        is: 'rw',
        isa: 'numeric'
      }
    }
  });

  MITHgrid.defaults('SGA.Reader.Component.PagerControls', {
    variables: {
      Min: {
        is: 'rw',
        isa: 'numeric'
      },
      Max: {
        is: 'rw',
        isa: 'numeric'
      },
      Value: {
        is: 'rw',
        isa: 'numeric'
      }
    }
  });

  MITHgrid.defaults('SGA.Reader.Component.SequenceSelector', {
    variables: {
      Sequence: {
        is: 'rw'
      }
    }
  });

  MITHgrid.defaults('SGA.Reader.Component.ProgressBar', {
    variables: {
      Numerator: {
        is: 'rw',
        "default": 0,
        isa: 'numeric'
      },
      Denominator: {
        is: 'rw',
        "default": 1,
        isa: 'numeric'
      }
    },
    viewSetup: "<div class=\"progress progress-striped active\">\n  <div class=\"bar\" style=\"width: 0%;\"></div>\n</div>"
  });

  MITHgrid.defaults('SGA.Reader.Component.Spinner', {
    viewSetup: "<i class=\"icon-spinner icon-spin icon-3x\"></i>"
  });

  MITHgrid.defaults('SGA.Reader.Presentation.ImageCanvas', {
    variables: {
      Canvas: {
        is: 'rw'
      },
      Scale: {
        is: 'rw',
        isa: 'numeric'
      },
      ImgOnly: {
        is: 'rw'
      },
      Height: {
        is: 'rw',
        isa: 'numeric'
      },
      Width: {
        is: 'rw',
        isa: 'numeric'
      },
      X: {
        is: 'rw',
        isa: 'numeric'
      },
      Y: {
        is: 'rw',
        isa: 'numeric'
      }
    }
  });

  MITHgrid.defaults('SGA.Reader.Presentation.TextCanvas', {
    variables: {
      Canvas: {
        is: 'rw'
      },
      Scale: {
        is: 'rw',
        isa: 'numeric'
      },
      ImgOnly: {
        is: 'rw'
      },
      Height: {
        is: 'rw',
        isa: 'numeric'
      },
      Width: {
        is: 'rw',
        isa: 'numeric'
      },
      X: {
        is: 'rw',
        isa: 'numeric'
      },
      Y: {
        is: 'rw',
        isa: 'numeric'
      }
    }
  });

  MITHgrid.defaults('SGA.Reader.Presentation.TextContent', {
    variables: {
      Height: {
        is: 'rw',
        isa: 'numeric'
      },
      Width: {
        is: 'rw',
        isa: 'numeric'
      },
      X: {
        is: 'rw',
        isa: 'numeric'
      },
      Y: {
        is: 'rw',
        isa: 'numeric'
      },
      Scale: {
        is: 'rw',
        isa: 'numeric'
      }
    }
  });

  MITHgrid.defaults('SGA.Reader.Presentation.Zone', {
    variables: {
      Height: {
        is: 'rw',
        isa: 'numeric'
      },
      Width: {
        is: 'rw',
        isa: 'numeric'
      },
      X: {
        is: 'rw',
        isa: 'numeric'
      },
      Y: {
        is: 'rw',
        isa: 'numeric'
      },
      Scale: {
        is: 'rw',
        isa: 'numeric'
      }
    }
  });

  MITHgrid.defaults('SGA.Reader.Presentation.TextZone', {
    variables: {
      Height: {
        is: 'rw',
        isa: 'numeric'
      },
      Width: {
        is: 'rw',
        isa: 'numeric'
      },
      X: {
        is: 'rw',
        isa: 'numeric'
      },
      Y: {
        is: 'rw',
        isa: 'numeric'
      },
      Scale: {
        is: 'rw',
        isa: 'numeric'
      }
    }
  });

  MITHgrid.defaults('SGA.Reader.Data.Manifest', {
    variables: {
      ItemsToProcess: {
        is: 'rw',
        "default": 0,
        isa: 'numeric'
      },
      ItemsProcessed: {
        is: 'rw',
        "default": 0,
        isa: 'numeric'
      }
    }
  });

  MITHgrid.defaults('SGA.Reader.Component.ImageControls', {
    variables: {
      Active: {
        is: 'rw',
        "default": false
      },
      Zoom: {
        is: 'rw',
        "default": 0,
        isa: 'numeric'
      },
      MaxZoom: {
        is: 'rw',
        "default": 0,
        isa: 'numeric'
      },
      MinZoom: {
        is: 'rw',
        "default": 0,
        isa: 'numeric'
      },
      ImgPosition: {
        is: 'rw',
        "default": {}
      }
    }
  });

  MITHgrid.defaults('SGA.Reader.Component.SearchBox', {
    variables: {
      Field: {
        is: 'rw',
        "default": false
      },
      Query: {
        is: 'rw',
        "default": false
      },
      ServiceURL: {
        is: 'rw',
        "default": false
      }
    }
  });

  MITHgrid.defaults('SGA.Reader.Component.ModeControls', {
    variables: {
      Mode: {
        is: 'rw',
        "default": 'normal'
      }
    }
  });

  MITHgrid.defaults('SGA.Reader.Controller.ModeSelector', {
    bind: {
      events: {
        onModeSelect: null
      }
    }
  });

}).call(this);
