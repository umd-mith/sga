// Generated by CoffeeScript 1.3.3
/*
# SGA Shared Canvas v0.0.1
#
# **SGA Shared Canvas** is a shared canvas reader written in CoffeeScript.
#
#  
# Date: Wed Oct 24 13:11:47 2012 -0400
#
# License TBD.
#
*/
(function(){var a=[].slice,b=[].indexOf||function(a){for(var b=0,c=this.length;b<c;b++)if(b in this&&this[b]===a)return b;return-1};(function(c,d){d.globalNamespace("SGA");return SGA.namespace("Reader",function(e){e.namespace("Data",function(e){e.namespace("TextStore",function(b){return b.initInstance=function(){var b;b=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,a.call(b).concat([function(a){var b,d,e,f;e=a.options,b={},d={},f={},a.addFile=function(a){var e,f,g,h;c.isArray(a)||(a=[a]),h=[];for(f=0,g=a.length;f<g;f++)e=a[f],h.push(function(a){(b[a]!=null||d[a]!=null)&&next,d[a]=[];return c.ajax({url:a,type:"GET",processData:!1,success:function(c){var e,f,g,h,i;e=c.documentElement.textContent,b[a]=e,i=d[a];for(g=0,h=i.length;g<h;g++)f=i[g],f(e);return delete d[a]}})}(e));return h};return a.withFile=function(a,c){if(b[a]!=null)return c(b[a]);if(d[a]!=null)return d[a].push(c)}}]))}});return e.namespace("Manifest",function(e){var f;f={"http://dms.stanford.edu/ns/":"sc","http://www.shared-canvas.org/ns/":"sc","http://www.w3.org/2000/01/rdf-schema#":"rdfs","http://www.w3.org/1999/02/22-rdf-syntax-ns#":"rdf","http://www.w3.org/2003/12/exif/ns#":"exif","http://purl.org/dc/elements/1.1/":"dc","http://www.w3.org/ns/openannotation/core/":"oa","http://www.openannotation.org/ns/":"oa","http://www.w3.org/ns/openannotation/extension/":"oax","http://www.openarchives.org/ore/terms/":"ore","http://www.shelleygodwinarchive.org/ns/1#":"sga","http://www.shelleygodwinarchive.org/ns1#":"sga"};return e.initInstance=function(){var e;e=1<=arguments.length?a.call(arguments,0):[];return d.initInstance.apply(d,["SGA.Reader.Data.Manifest"].concat(a.call(e),[function(a){var e,g,h,i,j;j=a.options,e=d.Data.Store.initInstance(),i=[],g=function(d,e){{if(b.call(i,d)<0){i.push(d);return c.ajax({url:d,type:"GET",contentType:"application/rdf+json",processData:!1,dataType:"json",success:function(b){return a.importJSON(b,e)},error:e})}e()}},a.importJSON=function(a,b){var c,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C;q=d.initSynchronizer(b),h=[];for(p in a){o=a[p],c={id:p};for(l in o){k=o[l],s=[];if(l==="http://www.w3.org/1999/02/22-rdf-syntax-ns#type"){for(t=0,x=k.length;t<x;t++){j=k[t];if(j.type==="uri")for(i in f)n=f[i],(n==="sc"||n==="sga"||n==="oa"||n==="oax")&&j.value.slice(0,i.length)===i&&s.push(n+j.value.substr(i.length))}c.type=s}else{for(u=0,y=k.length;u<y;u++)j=k[u],j.type==="literal"?s.push(j.value):j.type==="uri"?j.value.substr(0,1)==="("&&j.value.substr(-1)===")"?s.push("_:"+j.value.substr(1,j.value.length-2)):s.push(j.value):j.type==="bnode"&&(j.value.substr(0,1)==="("&&j.value.substr(-1)===")"?s.push("_:"+j.value.substr(1,j.value.length-2)):s.push(j.value));if(s.length>0)for(i in f)n=f[i],l.substr(0,i.length)===i&&(m=n+l.substr(i.length),c[m]=s)}}if(c.type==null||c.type.length===0)c.type="Blank";if(((B=c.oreisDescribedBy)!=null?B.length:void 0)>0){C=c.oreisDescribedBy;for(v=0,z=C.length;v<z;v++)r=C[v],q.increment(),g(r,q.decrement)}else h.push(c)}for(w=0,A=h.length;w<A;w++)c=h[w],e.contains(c.id)?e.updateItems([c]):e.loadItems([c]);return q.done()},h=function(a){var b;c.isArray(a)||(a=[a]),b=d.Data.Set.initInstance(a);return e.getSubjectsUnion(b,"type").items()},a.getCanvases=function(){return h("scCanvas")},a.getSequences=function(){return h("scSequence")},a.getAnnotations=function(){return h("oaAnnotation")},a.getItem=e.getItem,a.contains=e.contains;return a.importFromURL=function(a,b){return g(a,function(){if(b!=null)return b()})}}]))}})}),e.namespace("Presentation",function(e){return e.namespace("Canvas",function(e){return e.initInstance=function(){var e,f;e=1<=arguments.length?a.call(arguments,0):[];return(f=d.Presentation).initInstance.apply(f,["SGA.Reader.Presentation.Canvas"].concat(a.call(e),[function(a,e){var f,g,h,i,j,k,l,m,n,o,p,q;n=a.options,m=null,i=a.dataView.prepare(["!target"]),o=[],f=function(a){return o.push(a)},q=c('<svg xmlns="http://www.w3.org/2000/svg" version="1.1"\n     xmlns:xlink="http://www.w3.org/1999/xlink"\n     width="0" height="0"\n >\n</svg>'),e.append(q),p=c(q).svg({onLoad:function(a){var b,c,d;f=function(b){return b(a)};for(c=0,d=o.length;c<d;c++)b=o[c],b(a);return o=null}}),k=null,j=null,g=null,h=c(e).width()*19/20,d.events.onWindowResize.addListener(function(){h=c(e).width()*19/20;if(k!=null)return a.setScale(h/k)}),a.events.onScaleChange.addListener(function(a){if(k!=null&&j!=null){g=j*a;return f(function(a){q.attr({width:h,height:g,viewbox:"0 0 "+h+" "+g});return q.css({width:h,height:g,border:"0.5em solid #eeeeee","border-radius":"5px","background-color":"#ffffff"})})}}),l=d.Data.SubSet.initInstance({dataStore:n.dataView,expressions:["!target"],key:null}),a.events.onCanvasChange.addListener(function(b){var c,d,e;l.setKey(b),c=l.getItem(b),k=((d=c.width)!=null?d[0]:void 0)||1,j=((e=c.height)!=null?e[0]:void 0)||1;return a.setScale(h/k)}),a.addLens("Image",function(a,c,d,e){var g,h,i;if(b.call(n.types||[],"Image")>=0){h={},g=d.getItem(e),i=null,f(function(a){var b;return i=a.image(0,0,"100%","100%",(b=g.image)!=null?b[0]:void 0,{preserveAspectRatio:"none"})}),h.update=function(a){},h.remove=function(){return f(function(a){return a.remove(i)})};return h}});return a.addLens("TextContent",function(a,d,e,g){var h,j,k,l,m,o,p,q,r,s;if(b.call(n.types||[],"Text")>=0){o={},h=n.application(),k=e.getItem(g),q=null,m=function(a){var c;c=[],b.call(a.modes,"LineAnnotation")>=0&&c.push("line"),b.call(a.modes,"AdditionAnnotation")>=0&&c.push("addition"),b.call(a.modes,"DeletionAnnotation")>=0&&c.push("deletion"),c.length===0&&c.push("text");return{type:"span",text:a.acc,classes:c.join(" "),modes:a.modes}},j=function(a){var b,c,d,e,f,g,h,i,j,k,l,n,o,p;j=a.text,f=a.mods,g=a.offset,c={acc:"",modes:[]},i=[],b=!1;for(h=k=0,o=j.length;0<=o?k<o:k>o;h=0<=o?++k:--k)if(f[h+g]==null)j[h].match(/^\s+$/)||(b=!1),c.acc+=j[h];else{c.acc.match(/^\s*$/)?c.acc="":i.push(m(c)),c.acc=j[h],p=f[h+g];for(l=0,n=p.length;l<n;l++)e=p[l],e.type==="LineAnnotation"&&(b||(i.push({type:"br",modes:[],acc:""}),b=!0)),e.action==="start"&&c.modes.push(e.type),e.action==="end"&&(c.modes=function(){var a,b,f,g;f=c.modes,g=[];for(a=0,b=f.length;a<b;a++)d=f[a],d!==e.type&&g.push(d);return g}())}i.push(m(c));return i},r="",l={},s=null,p=function(a,b,d){c.isArray(a)&&(a=a[0]),l[a]==null&&(l[a]=[]),c.isArray(d)&&(d=d[0]);return l[a].push({action:b,type:d})},f(function(a){var b;s=document.createElementNS("http://www.w3.org/2000/svg","foreignObject"),c(s).attr("x",0).attr("y",0).attr("width","100%").attr("height","100%"),b=a.root(),b.appendChild(s);return h.withSource(k.source[0],function(a){var b,d,f,g,h,m,n,o,q,t,u,v,w,x,y,z,A,B,C,D;r=a.substr(k.start[0],k.end[0]),B=i.evaluate(k.source);for(v=0,y=B.length;v<y;v++)b=B[v],h=e.getItem(b),t=h.start[0],g=h.end[0],t<=k.end[0]&&g>=k.start[0]&&(t<k.start[0]&&(t=k.start[0]),g>k.end[0]&&(g=k.end[0]),p(h.start,"start",h.type),p(h.end,"end",h.type));o=j({text:r,mods:l,offset:k.start[0]}),u={},d=document.createElementNS("http://www.w3.org/1999/xhtml","body"),q=document.createElement("div"),c(q).addClass("text-content"),d.appendChild(q);for(w=0,z=o.length;w<z;w++){n=o[w],f=c("<"+n.type+" />"),n.type!=="br"&&f.text(n.text),f.addClass(n.classes),c(q).append(f),C=n.modes;for(x=0,A=C.length;x<A;x++)m=C[x],(D=u[m])==null&&(u[m]=[]),u[m].push(f)}return s.appendChild(d)})}),o.update=function(a){},o.remove=function(){return f(function(a){return a.remove(s)})};return o}})}]))}})}),e.namespace("Component",function(b){return b.namespace("SequenceSelector",function(b){return b.initInstance=function(){var b,e;b=1<=arguments.length?a.call(arguments,0):[];return(e=d.Presentation).initInstance.apply(e,["SGA.Reader.Component.SequenceSelector"].concat(a.call(b),[function(a,b){var d;d=a.options,a.addLens("Sequence",function(a,b,d,e){var f,g,h,i;h={},g=d.getItem(e),f=c("<option></option>"),f.attr({value:e}),f.text((i=g.label)!=null?i[0]:void 0);return c(a).append(f)}),c(b).change(function(){return a.setSequence(c(b).val())});return a.finishDisplayUpdate=function(){return a.setSequence(c(b).val())}}]))}})});return e.namespace("Application",function(e){return e.namespace("SharedCanvas",function(f){f.initInstance=function(){var e,f;e=1<=arguments.length?a.call(arguments,0):[];return(f=d.Application).initInstance.apply(f,["SGA.Reader.Application.SharedCanvas"].concat(a.call(e),[function(a){var d,e,f,g,h;f=a.options,g=[],e=SGA.Reader.Data.Manifest.initInstance(),h=SGA.Reader.Data.TextStore.initInstance(),a.withSource=function(a,b){return h.withFile(a,b)},a.addPresentation=function(b){var c;c=SGA.Reader.Presentation.Canvas.initInstance(b.container,{types:b.types,application:function(){return a},dataView:a.dataView.canvasAnnotations});return g.push([c,b.container])},d=null,a.events.onSequenceChange.addListener(function(b){var c,e;d=b,e=a.dataStore.data.getItem(d),c=e.sequence.indexOf(a.getCanvas()),c<0&&(c=0);return a.setPosition(c)}),a.events.onPositionChange.addListener(function(b){var c,e,f;e=a.dataStore.data.getItem(d),c=(f=e.sequence)!=null?f[b]:void 0;return a.setCanvas(c)}),a.events.onCanvasChange.addListener(function(b){var c,e,f,h,i,j;a.dataView.canvasAnnotations.setKey(b),f=a.dataStore.data.getItem(d),c=f.sequence.indexOf(b),c>=0&&c!==a.getPosition()&&a.setPosition(c),j=[];for(h=0,i=g.length;h<i;h++)e=g[h],j.push(e[0].setCanvas(b));return j});if(f.url!=null)return e.importFromURL(f.url,function(){var d,f,g,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A;k=[],f=e.getCanvases();for(q=0,t=f.length;q<t;q++)g=f[q],l=e.getItem(g),j={id:g,type:"Canvas",width:parseInt((w=l.exifwidth)!=null?w[0]:void 0,10),height:parseInt((x=l.exifheight)!=null?x[0]:void 0,10),label:l.dctitle||l.rdfslabel},k.push(j);y=e.getSequences();for(r=0,u=y.length;r<u;r++){g=y[r],n=e.getItem(g),j={id:g,type:"Sequence",label:n.rdfslabel},m=[];while(e.contains((z=n.rdffirst)!=null?z[0]:void 0))m.push(n.rdffirst[0]),n=e.getItem(n.rdfrest[0]);j.sequence=m,k.push(j)}A=e.getAnnotations();for(s=0,v=A.length;s<v;s++)g=A[s],d=e.getItem(g),b.call(d.type,"scContentAnnotation")>=0&&(o=e.getItem(d.oahasBody),c.isArray(o)&&(o=o[0]),p=e.getItem(o.oahasSelector),c.isArray(p)&&(p=p[0]),h.addFile(o.oahasSource),k.push({id:d.id,target:d.oahasTarget,type:"TextContent",source:o.oahasSource,start:parseInt(p.oaxbegin[0],10),end:parseInt(p.oaxend[0],10)})),b.call(d.type,"sgaLineAnnotation")>=0&&(o=e.getItem(d.oahasTarget),c.isArray(o)&&(o=o[0]),p=e.getItem(o.oahasSelector),c.isArray(p)&&(p=p[0]),k.push({id:d.id,target:o.oahasSource,start:parseInt(p.oaxbegin[0],10),end:parseInt(p.oaxend[0],10),type:"LineAnnotation"})),b.call(d.type,"sgaDeletionAnnotation")>=0&&(o=e.getItem(d.oahasTarget),c.isArray(o)&&(o=o[0]),p=e.getItem(o.oahasSelector),c.isArray(p)&&(p=p[0]),k.push({id:d.id,target:o.oahasSource,start:parseInt(p.oaxbegin[0],10),end:parseInt(p.oaxend[0],10),type:"DeletionAnnotation"})),b.call(d.type,"sgaAdditionAnnotation")>=0&&(o=e.getItem(d.oahasTarget),c.isArray(o)&&(o=o[0]),p=e.getItem(o.oahasSelector),c.isArray(p)&&(p=p[0]),k.push({id:d.id,target:o.oahasSource,start:parseInt(p.oaxbegin[0],10),end:parseInt(p.oaxend[0],10),type:"AdditionAnnotation"})),b.call(d.type,"scImageAnnotation")>=0&&(i=e.getItem(d.oahasBody),c.isArray(i)&&(i=i[0]),k.push({id:d.id,target:d.oahasTarget,label:d.rdfslabel,image:i.oahasSource||d.oahasBody,type:"Image"}));return a.dataStore.data.loadItems(k)})}]))};return f.builder=function(a){var b,d,f;d={manifests:{}},b={},d.onManifest=function(a,c){var e;if(d.manifests[a]!=null)return d.manifests[a].ready(function(){return c(d.manifests[a])});(e=b[a])==null&&(b[a]=[]);return b[a].push(c)},d.addPresentation=function(a){var f,g,h,i;g=c(a).data("manifest");if(g!=null){f=d.manifests[g],f==null&&(f=e.SharedCanvas.initInstance({url:g}),d.manifests[g]=f,f.ready(function(){var a,c,d,e;c=b[g]||[];for(d=0,e=c.length;d<e;d++)a=c[d],a(f);return delete b[g]})),f.run(),h=(i=c(a).data("types"))!=null?i.split(/\s*,\s*/):void 0;return d.onManifest(g,function(b){return b.addPresentation({types:h,container:c(a)})})}},(f=a["class"])==null&&(a["class"]=".canvas"),c(a["class"]).each(function(a,b){return d.addPresentation(b)});return d}})})})})(jQuery,MITHGrid),MITHGrid.defaults("SGA.Reader.Application.SharedCanvas",{dataStores:{data:{types:{Sequence:{},Canvas:{}},properties:{target:{valueType:"item"}}}},dataViews:{canvasAnnotations:{dataStore:"data",type:MITHGrid.Data.SubSet,expressions:["!target"]},sequences:{dataStore:"data",types:["Sequence"]}},variables:{Canvas:{is:"rw"},Sequence:{is:"rw"},Position:{is:"rw"}}}),MITHGrid.defaults("SGA.Reader.Component.SequenceSelector",{variables:{Sequence:{is:"rw"}}}),MITHGrid.defaults("SGA.Reader.Presentation.Canvas",{variables:{Canvas:{is:"rw"},Scale:{is:"rw"}}})}).call(this);